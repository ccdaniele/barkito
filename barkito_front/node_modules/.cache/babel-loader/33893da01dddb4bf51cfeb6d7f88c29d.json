{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst startCh = channel('apm:elasticsearch:query:start');\nconst finishCh = channel('apm:elasticsearch:query:finish');\nconst errorCh = channel('apm:elasticsearch:query:error');\naddHook({\n  name: '@elastic/transport',\n  file: 'lib/Transport.js',\n  versions: ['>=8']\n}, exports => {\n  shimmer.wrap(exports.default.prototype, 'request', wrapRequest);\n  return exports;\n});\naddHook({\n  name: '@elastic/elasticsearch',\n  file: 'lib/Transport.js',\n  versions: ['>=5.6.16 <8', '>=8']\n}, Transport => {\n  shimmer.wrap(Transport.prototype, 'request', wrapRequest);\n  return Transport;\n});\naddHook({\n  name: 'elasticsearch',\n  file: 'src/lib/transport.js',\n  versions: ['>=10']\n}, Transport => {\n  shimmer.wrap(Transport.prototype, 'request', wrapRequest);\n  return Transport;\n});\n\nfunction wrapRequest(request) {\n  return function (params, options, cb) {\n    if (!startCh.hasSubscribers) {\n      return request.apply(this, arguments);\n    }\n\n    if (!params) return request.apply(this, arguments);\n    const parentResource = new AsyncResource('bound-anonymous-fn');\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({\n        params\n      });\n\n      try {\n        const lastIndex = arguments.length - 1;\n        cb = arguments[lastIndex];\n\n        if (typeof cb === 'function') {\n          cb = parentResource.bind(cb);\n          arguments[lastIndex] = asyncResource.bind(function (error) {\n            finish(params, error);\n            return cb.apply(null, arguments);\n          });\n          return request.apply(this, arguments);\n        } else {\n          const promise = request.apply(this, arguments);\n\n          if (promise && typeof promise.then === 'function') {\n            const onResolve = asyncResource.bind(() => finish(params));\n            const onReject = asyncResource.bind(e => finish(params, e));\n            promise.then(onResolve, onReject);\n          } else {\n            finish(params);\n          }\n\n          return promise;\n        }\n      } catch (err) {\n        err.stack; // trigger getting the stack at the original throwing point\n\n        errorCh.publish(err);\n        throw err;\n      }\n    });\n  };\n}\n\nfunction finish(params, error) {\n  if (error) {\n    errorCh.publish(error);\n  }\n\n  finishCh.publish({\n    params\n  });\n}","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startCh","finishCh","errorCh","name","file","versions","exports","wrap","default","prototype","wrapRequest","Transport","request","params","options","cb","hasSubscribers","apply","arguments","parentResource","asyncResource","runInAsyncScope","publish","lastIndex","length","bind","error","finish","promise","then","onResolve","onReject","e","err","stack"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/elasticsearch.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst startCh = channel('apm:elasticsearch:query:start')\nconst finishCh = channel('apm:elasticsearch:query:finish')\nconst errorCh = channel('apm:elasticsearch:query:error')\n\naddHook({ name: '@elastic/transport', file: 'lib/Transport.js', versions: ['>=8'] }, (exports) => {\n  shimmer.wrap(exports.default.prototype, 'request', wrapRequest)\n  return exports\n})\n\naddHook({ name: '@elastic/elasticsearch', file: 'lib/Transport.js', versions: ['>=5.6.16 <8', '>=8'] }, Transport => {\n  shimmer.wrap(Transport.prototype, 'request', wrapRequest)\n  return Transport\n})\n\naddHook({ name: 'elasticsearch', file: 'src/lib/transport.js', versions: ['>=10'] }, Transport => {\n  shimmer.wrap(Transport.prototype, 'request', wrapRequest)\n  return Transport\n})\n\nfunction wrapRequest (request) {\n  return function (params, options, cb) {\n    if (!startCh.hasSubscribers) {\n      return request.apply(this, arguments)\n    }\n\n    if (!params) return request.apply(this, arguments)\n\n    const parentResource = new AsyncResource('bound-anonymous-fn')\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({ params })\n\n      try {\n        const lastIndex = arguments.length - 1\n        cb = arguments[lastIndex]\n\n        if (typeof cb === 'function') {\n          cb = parentResource.bind(cb)\n\n          arguments[lastIndex] = asyncResource.bind(function (error) {\n            finish(params, error)\n            return cb.apply(null, arguments)\n          })\n          return request.apply(this, arguments)\n        } else {\n          const promise = request.apply(this, arguments)\n          if (promise && typeof promise.then === 'function') {\n            const onResolve = asyncResource.bind(() => finish(params))\n            const onReject = asyncResource.bind(e => finish(params, e))\n\n            promise.then(onResolve, onReject)\n          } else {\n            finish(params)\n          }\n          return promise\n        }\n      } catch (err) {\n        err.stack // trigger getting the stack at the original throwing point\n        errorCh.publish(err)\n\n        throw err\n      }\n    })\n  }\n}\n\nfunction finish (params, error) {\n  if (error) {\n    errorCh.publish(error)\n  }\n  finishCh.publish({ params })\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}