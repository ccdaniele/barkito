{"ast":null,"code":"'use strict';\n\nconst request = require('../../../exporters/common/request');\n\nconst log = require('../../../log');\n\nconst {\n  AgentlessCiVisibilityEncoder\n} = require('../../../encode/agentless-ci-visibility');\n\nconst BaseWriter = require('../../../exporters/common/writer');\n\nfunction safeJSONStringify(value) {\n  return JSON.stringify(value, (key, value) => key !== 'dd-api-key' ? value : undefined);\n}\n\nclass Writer extends BaseWriter {\n  constructor(_ref) {\n    let {\n      url,\n      tags\n    } = _ref;\n    super(...arguments);\n    const {\n      'runtime-id': runtimeId,\n      env,\n      service\n    } = tags;\n    this._url = url;\n    this._encoder = new AgentlessCiVisibilityEncoder(this, {\n      runtimeId,\n      env,\n      service\n    });\n  }\n\n  _sendPayload(data, _, done) {\n    const options = {\n      path: '/api/v2/citestcycle',\n      method: 'POST',\n      headers: {\n        'dd-api-key': process.env.DATADOG_API_KEY || process.env.DD_API_KEY,\n        'Content-Type': 'application/msgpack'\n      },\n      timeout: 15000\n    };\n    options.protocol = this._url.protocol;\n    options.hostname = this._url.hostname;\n    options.port = this._url.port;\n    log.debug(() => `Request to the intake: ${safeJSONStringify(options)}`);\n    request(data, options, (err, res) => {\n      if (err) {\n        log.error(err);\n        done();\n        return;\n      }\n\n      log.debug(`Response from the intake: ${res}`);\n      done();\n    });\n  }\n\n}\n\nmodule.exports = Writer;","map":{"version":3,"names":["request","require","log","AgentlessCiVisibilityEncoder","BaseWriter","safeJSONStringify","value","JSON","stringify","key","undefined","Writer","constructor","url","tags","arguments","runtimeId","env","service","_url","_encoder","_sendPayload","data","_","done","options","path","method","headers","process","DATADOG_API_KEY","DD_API_KEY","timeout","protocol","hostname","port","debug","err","res","error","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/ci-visibility/exporters/agentless/writer.js"],"sourcesContent":["'use strict'\nconst request = require('../../../exporters/common/request')\nconst log = require('../../../log')\n\nconst { AgentlessCiVisibilityEncoder } = require('../../../encode/agentless-ci-visibility')\nconst BaseWriter = require('../../../exporters/common/writer')\n\nfunction safeJSONStringify (value) {\n  return JSON.stringify(value, (key, value) =>\n    key !== 'dd-api-key' ? value : undefined\n  )\n}\n\nclass Writer extends BaseWriter {\n  constructor ({ url, tags }) {\n    super(...arguments)\n    const { 'runtime-id': runtimeId, env, service } = tags\n    this._url = url\n    this._encoder = new AgentlessCiVisibilityEncoder(this, { runtimeId, env, service })\n  }\n\n  _sendPayload (data, _, done) {\n    const options = {\n      path: '/api/v2/citestcycle',\n      method: 'POST',\n      headers: {\n        'dd-api-key': process.env.DATADOG_API_KEY || process.env.DD_API_KEY,\n        'Content-Type': 'application/msgpack'\n      },\n      timeout: 15000\n    }\n\n    options.protocol = this._url.protocol\n    options.hostname = this._url.hostname\n    options.port = this._url.port\n\n    log.debug(() => `Request to the intake: ${safeJSONStringify(options)}`)\n    request(data, options, (err, res) => {\n      if (err) {\n        log.error(err)\n        done()\n        return\n      }\n      log.debug(`Response from the intake: ${res}`)\n      done()\n    })\n  }\n}\n\nmodule.exports = Writer\n"],"mappings":"AAAA;;AACA,MAAMA,OAAO,GAAGC,OAAO,CAAC,mCAAD,CAAvB;;AACA,MAAMC,GAAG,GAAGD,OAAO,CAAC,cAAD,CAAnB;;AAEA,MAAM;EAAEE;AAAF,IAAmCF,OAAO,CAAC,yCAAD,CAAhD;;AACA,MAAMG,UAAU,GAAGH,OAAO,CAAC,kCAAD,CAA1B;;AAEA,SAASI,iBAAT,CAA4BC,KAA5B,EAAmC;EACjC,OAAOC,IAAI,CAACC,SAAL,CAAeF,KAAf,EAAsB,CAACG,GAAD,EAAMH,KAAN,KAC3BG,GAAG,KAAK,YAAR,GAAuBH,KAAvB,GAA+BI,SAD1B,CAAP;AAGD;;AAED,MAAMC,MAAN,SAAqBP,UAArB,CAAgC;EAC9BQ,WAAW,OAAiB;IAAA,IAAf;MAAEC,GAAF;MAAOC;IAAP,CAAe;IAC1B,MAAM,GAAGC,SAAT;IACA,MAAM;MAAE,cAAcC,SAAhB;MAA2BC,GAA3B;MAAgCC;IAAhC,IAA4CJ,IAAlD;IACA,KAAKK,IAAL,GAAYN,GAAZ;IACA,KAAKO,QAAL,GAAgB,IAAIjB,4BAAJ,CAAiC,IAAjC,EAAuC;MAAEa,SAAF;MAAaC,GAAb;MAAkBC;IAAlB,CAAvC,CAAhB;EACD;;EAEDG,YAAY,CAAEC,IAAF,EAAQC,CAAR,EAAWC,IAAX,EAAiB;IAC3B,MAAMC,OAAO,GAAG;MACdC,IAAI,EAAE,qBADQ;MAEdC,MAAM,EAAE,MAFM;MAGdC,OAAO,EAAE;QACP,cAAcC,OAAO,CAACZ,GAAR,CAAYa,eAAZ,IAA+BD,OAAO,CAACZ,GAAR,CAAYc,UADlD;QAEP,gBAAgB;MAFT,CAHK;MAOdC,OAAO,EAAE;IAPK,CAAhB;IAUAP,OAAO,CAACQ,QAAR,GAAmB,KAAKd,IAAL,CAAUc,QAA7B;IACAR,OAAO,CAACS,QAAR,GAAmB,KAAKf,IAAL,CAAUe,QAA7B;IACAT,OAAO,CAACU,IAAR,GAAe,KAAKhB,IAAL,CAAUgB,IAAzB;IAEAjC,GAAG,CAACkC,KAAJ,CAAU,MAAO,0BAAyB/B,iBAAiB,CAACoB,OAAD,CAAU,EAArE;IACAzB,OAAO,CAACsB,IAAD,EAAOG,OAAP,EAAgB,CAACY,GAAD,EAAMC,GAAN,KAAc;MACnC,IAAID,GAAJ,EAAS;QACPnC,GAAG,CAACqC,KAAJ,CAAUF,GAAV;QACAb,IAAI;QACJ;MACD;;MACDtB,GAAG,CAACkC,KAAJ,CAAW,6BAA4BE,GAAI,EAA3C;MACAd,IAAI;IACL,CARM,CAAP;EASD;;AAjC6B;;AAoChCgB,MAAM,CAACC,OAAP,GAAiB9B,MAAjB"},"metadata":{},"sourceType":"script"}