{"ast":null,"code":"'use strict';\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst {\n  addHook,\n  channel,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst handleChannel = channel('apm:microgateway-core:request:handle');\nconst routeChannel = channel('apm:microgateway-core:request:route');\nconst errorChannel = channel('apm:microgateway-core:request:error');\nconst name = 'microgateway-core';\nconst versions = ['>=2.1'];\nconst requestResources = new WeakMap();\n\nfunction wrapConfigProxyFactory(configProxyFactory) {\n  return function () {\n    const configProxy = configProxyFactory.apply(this, arguments);\n    return function (req, res, next) {\n      const requestResource = new AsyncResource('bound-anonymous-fn');\n      requestResources.set(req, requestResource);\n      handleChannel.publish({\n        req,\n        res\n      });\n      return configProxy.apply(this, arguments);\n    };\n  };\n}\n\nfunction wrapPluginsFactory(pluginsFactory) {\n  return function (plugins) {\n    const pluginsMiddleware = pluginsFactory.apply(this, arguments);\n    return function pluginsMiddlewareWithTrace(req, res, next) {\n      arguments[2] = wrapNext(req, res, next);\n      return pluginsMiddleware.apply(this, arguments);\n    };\n  };\n}\n\nfunction wrapNext(req, res, next) {\n  return function nextWithTrace(err) {\n    const requestResource = requestResources.get(req);\n    requestResource.runInAsyncScope(() => {\n      if (err) {\n        errorChannel.publish(err);\n      }\n\n      if (res.proxy && res.proxy.base_path) {\n        routeChannel.publish({\n          req,\n          res,\n          route: res.proxy.base_path\n        });\n      }\n    });\n    return next.apply(this, arguments);\n  };\n}\n\naddHook({\n  name,\n  versions,\n  file: 'lib/config-proxy-middleware.js'\n}, configProxyFactory => {\n  return shimmer.wrap(configProxyFactory, wrapConfigProxyFactory(configProxyFactory));\n});\naddHook({\n  name,\n  versions,\n  file: 'lib/plugins-middleware.js'\n}, pluginsFactory => {\n  return shimmer.wrap(pluginsFactory, wrapPluginsFactory(pluginsFactory));\n});","map":{"version":3,"names":["shimmer","require","addHook","channel","AsyncResource","handleChannel","routeChannel","errorChannel","name","versions","requestResources","WeakMap","wrapConfigProxyFactory","configProxyFactory","configProxy","apply","arguments","req","res","next","requestResource","set","publish","wrapPluginsFactory","pluginsFactory","plugins","pluginsMiddleware","pluginsMiddlewareWithTrace","wrapNext","nextWithTrace","err","get","runInAsyncScope","proxy","base_path","route","file","wrap"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/microgateway-core.js"],"sourcesContent":["'use strict'\n\nconst shimmer = require('../../datadog-shimmer')\nconst { addHook, channel, AsyncResource } = require('./helpers/instrument')\n\nconst handleChannel = channel('apm:microgateway-core:request:handle')\nconst routeChannel = channel('apm:microgateway-core:request:route')\nconst errorChannel = channel('apm:microgateway-core:request:error')\n\nconst name = 'microgateway-core'\nconst versions = ['>=2.1']\nconst requestResources = new WeakMap()\n\nfunction wrapConfigProxyFactory (configProxyFactory) {\n  return function () {\n    const configProxy = configProxyFactory.apply(this, arguments)\n\n    return function (req, res, next) {\n      const requestResource = new AsyncResource('bound-anonymous-fn')\n\n      requestResources.set(req, requestResource)\n\n      handleChannel.publish({ req, res })\n\n      return configProxy.apply(this, arguments)\n    }\n  }\n}\n\nfunction wrapPluginsFactory (pluginsFactory) {\n  return function (plugins) {\n    const pluginsMiddleware = pluginsFactory.apply(this, arguments)\n\n    return function pluginsMiddlewareWithTrace (req, res, next) {\n      arguments[2] = wrapNext(req, res, next)\n\n      return pluginsMiddleware.apply(this, arguments)\n    }\n  }\n}\n\nfunction wrapNext (req, res, next) {\n  return function nextWithTrace (err) {\n    const requestResource = requestResources.get(req)\n\n    requestResource.runInAsyncScope(() => {\n      if (err) {\n        errorChannel.publish(err)\n      }\n\n      if (res.proxy && res.proxy.base_path) {\n        routeChannel.publish({ req, res, route: res.proxy.base_path })\n      }\n    })\n\n    return next.apply(this, arguments)\n  }\n}\n\naddHook({ name, versions, file: 'lib/config-proxy-middleware.js' }, configProxyFactory => {\n  return shimmer.wrap(configProxyFactory, wrapConfigProxyFactory(configProxyFactory))\n})\n\naddHook({ name, versions, file: 'lib/plugins-middleware.js' }, pluginsFactory => {\n  return shimmer.wrap(pluginsFactory, wrapPluginsFactory(pluginsFactory))\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}