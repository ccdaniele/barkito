{"ast":null,"code":"'use strict';\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin');\n\nconst {\n  storage\n} = require('../../datadog-core');\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nclass KafkajsPlugin extends Plugin {\n  static get name() {\n    return 'kafkajs';\n  }\n\n  constructor() {\n    super(...arguments);\n    this.addSub(`apm:kafkajs:produce:start`, _ref => {\n      let {\n        topic,\n        messages\n      } = _ref;\n      const store = storage.getStore();\n      const childOf = store ? store.span : store;\n      const span = this.tracer.startSpan('kafka.produce', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || `${this.tracer._service}-kafka`,\n          'span.kind': 'producer',\n          'component': 'kafkajs'\n        }\n      });\n      analyticsSampler.sample(span, this.config.measured);\n      this.enter(span, store);\n      span.addTags({\n        'resource.name': topic,\n        'kafka.topic': topic,\n        'kafka.batch_size': messages.length\n      });\n\n      for (const message of messages) {\n        if (typeof message === 'object') {\n          this.tracer.inject(span, 'text_map', message.headers);\n        }\n      }\n    });\n    this.addSub(`apm:kafkajs:consume:start`, _ref2 => {\n      let {\n        topic,\n        partition,\n        message\n      } = _ref2;\n      const store = storage.getStore();\n      const childOf = extract(this.tracer, message.headers);\n      const span = this.tracer.startSpan('kafka.consume', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || `${this.tracer._service}-kafka`,\n          'span.kind': 'consumer',\n          'span.type': 'worker',\n          'component': 'kafkajs',\n          'resource.name': topic,\n          'kafka.topic': topic,\n          'kafka.partition': partition,\n          'kafka.message.offset': message.offset\n        }\n      });\n      analyticsSampler.sample(span, this.config.measured, true);\n      this.enter(span, store);\n    });\n    this.addSub(`apm:kafkajs:consume:error`, errorHandler);\n    this.addSub(`apm:kafkajs:consume:finish`, finishHandler);\n    this.addSub(`apm:kafkajs:produce:error`, errorHandler);\n    this.addSub(`apm:kafkajs:produce:finish`, finishHandler);\n  }\n\n}\n\nfunction finishHandler() {\n  storage.getStore().span.finish();\n}\n\nfunction errorHandler(error) {\n  storage.getStore().span.setTag('error', error);\n}\n\nfunction extract(tracer, bufferMap) {\n  if (!bufferMap) return null;\n  const textMap = {};\n\n  for (const key of Object.keys(bufferMap)) {\n    textMap[key] = bufferMap[key].toString();\n  }\n\n  return tracer.extract('text_map', textMap);\n}\n\nmodule.exports = KafkajsPlugin;","map":{"version":3,"names":["Plugin","require","storage","analyticsSampler","KafkajsPlugin","name","constructor","addSub","topic","messages","store","getStore","childOf","span","tracer","startSpan","tags","config","service","_service","sample","measured","enter","addTags","length","message","inject","headers","partition","extract","offset","errorHandler","finishHandler","finish","error","setTag","bufferMap","textMap","key","Object","keys","toString","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-kafkajs/src/index.js"],"sourcesContent":["'use strict'\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin')\nconst { storage } = require('../../datadog-core')\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\n\nclass KafkajsPlugin extends Plugin {\n  static get name () {\n    return 'kafkajs'\n  }\n\n  constructor (...args) {\n    super(...args)\n\n    this.addSub(`apm:kafkajs:produce:start`, ({ topic, messages }) => {\n      const store = storage.getStore()\n      const childOf = store ? store.span : store\n      const span = this.tracer.startSpan('kafka.produce', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || `${this.tracer._service}-kafka`,\n          'span.kind': 'producer',\n          'component': 'kafkajs'\n        }\n      })\n\n      analyticsSampler.sample(span, this.config.measured)\n      this.enter(span, store)\n\n      span.addTags({\n        'resource.name': topic,\n        'kafka.topic': topic,\n        'kafka.batch_size': messages.length\n      })\n      for (const message of messages) {\n        if (typeof message === 'object') {\n          this.tracer.inject(span, 'text_map', message.headers)\n        }\n      }\n    })\n\n    this.addSub(`apm:kafkajs:consume:start`, ({ topic, partition, message }) => {\n      const store = storage.getStore()\n      const childOf = extract(this.tracer, message.headers)\n      const span = this.tracer.startSpan('kafka.consume', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || `${this.tracer._service}-kafka`,\n          'span.kind': 'consumer',\n          'span.type': 'worker',\n          'component': 'kafkajs',\n          'resource.name': topic,\n          'kafka.topic': topic,\n          'kafka.partition': partition,\n          'kafka.message.offset': message.offset\n        }\n      })\n\n      analyticsSampler.sample(span, this.config.measured, true)\n      this.enter(span, store)\n    })\n\n    this.addSub(`apm:kafkajs:consume:error`, errorHandler)\n\n    this.addSub(`apm:kafkajs:consume:finish`, finishHandler)\n\n    this.addSub(`apm:kafkajs:produce:error`, errorHandler)\n\n    this.addSub(`apm:kafkajs:produce:finish`, finishHandler)\n  }\n}\n\nfunction finishHandler () {\n  storage.getStore().span.finish()\n}\n\nfunction errorHandler (error) {\n  storage.getStore().span.setTag('error', error)\n}\n\nfunction extract (tracer, bufferMap) {\n  if (!bufferMap) return null\n\n  const textMap = {}\n\n  for (const key of Object.keys(bufferMap)) {\n    textMap[key] = bufferMap[key].toString()\n  }\n\n  return tracer.extract('text_map', textMap)\n}\n\nmodule.exports = KafkajsPlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}