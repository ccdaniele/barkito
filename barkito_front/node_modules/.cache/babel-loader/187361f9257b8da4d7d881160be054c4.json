{"ast":null,"code":"'use strict';\n\nconst CachePlugin = require('../../dd-trace/src/plugins/cache');\n\nconst urlFilter = require('../../dd-trace/src/plugins/util/urlfilter');\n\nclass RedisPlugin extends CachePlugin {\n  static get name() {\n    return 'redis';\n  }\n\n  static get system() {\n    return 'redis';\n  }\n\n  start(_ref) {\n    let {\n      db,\n      command,\n      args,\n      connectionOptions = {},\n      connectionName\n    } = _ref;\n    if (!this.config.filter(command)) return this.skip();\n    this.startSpan('redis.command', {\n      service: getService(this.config, connectionName),\n      resource: command,\n      type: 'redis',\n      kind: 'client',\n      meta: {\n        'db.type': 'redis',\n        'db.name': db || '0',\n        'redis.raw_command': formatCommand(command, args),\n        'out.host': connectionOptions.host,\n        'out.port': connectionOptions.port\n      }\n    });\n  }\n\n  configure(config) {\n    super.configure(normalizeConfig(config));\n  }\n\n}\n\nfunction getService(config, connectionName) {\n  if (config.splitByInstance && connectionName) {\n    return config.service ? `${config.service}-${connectionName}` : connectionName;\n  }\n\n  return config.service;\n}\n\nfunction formatCommand(command, args) {\n  command = command.toUpperCase();\n  if (!args || command === 'AUTH') return command;\n\n  for (let i = 0, l = args.length; i < l; i++) {\n    if (typeof args[i] === 'function') continue;\n    command = `${command} ${formatArg(args[i])}`;\n    if (command.length > 1000) return trim(command, 1000);\n  }\n\n  return command;\n}\n\nfunction formatArg(arg) {\n  switch (typeof arg) {\n    case 'string':\n    case 'number':\n      return trim(String(arg), 100);\n\n    default:\n      return '?';\n  }\n}\n\nfunction trim(str, maxlen) {\n  if (str.length > maxlen) {\n    str = str.substr(0, maxlen - 3) + '...';\n  }\n\n  return str;\n}\n\nfunction normalizeConfig(config) {\n  const filter = urlFilter.getFilter(config);\n  return Object.assign({}, config, {\n    filter\n  });\n}\n\nmodule.exports = RedisPlugin;","map":{"version":3,"names":["CachePlugin","require","urlFilter","RedisPlugin","name","system","start","db","command","args","connectionOptions","connectionName","config","filter","skip","startSpan","service","getService","resource","type","kind","meta","formatCommand","host","port","configure","normalizeConfig","splitByInstance","toUpperCase","i","l","length","formatArg","trim","arg","String","str","maxlen","substr","getFilter","Object","assign","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-redis/src/index.js"],"sourcesContent":["'use strict'\n\nconst CachePlugin = require('../../dd-trace/src/plugins/cache')\nconst urlFilter = require('../../dd-trace/src/plugins/util/urlfilter')\n\nclass RedisPlugin extends CachePlugin {\n  static get name () { return 'redis' }\n  static get system () { return 'redis' }\n\n  start ({ db, command, args, connectionOptions = {}, connectionName }) {\n    if (!this.config.filter(command)) return this.skip()\n\n    this.startSpan('redis.command', {\n      service: getService(this.config, connectionName),\n      resource: command,\n      type: 'redis',\n      kind: 'client',\n      meta: {\n        'db.type': 'redis',\n        'db.name': db || '0',\n        'redis.raw_command': formatCommand(command, args),\n        'out.host': connectionOptions.host,\n        'out.port': connectionOptions.port\n      }\n    })\n  }\n\n  configure (config) {\n    super.configure(normalizeConfig(config))\n  }\n}\n\nfunction getService (config, connectionName) {\n  if (config.splitByInstance && connectionName) {\n    return config.service\n      ? `${config.service}-${connectionName}`\n      : connectionName\n  }\n\n  return config.service\n}\n\nfunction formatCommand (command, args) {\n  command = command.toUpperCase()\n\n  if (!args || command === 'AUTH') return command\n\n  for (let i = 0, l = args.length; i < l; i++) {\n    if (typeof args[i] === 'function') continue\n\n    command = `${command} ${formatArg(args[i])}`\n\n    if (command.length > 1000) return trim(command, 1000)\n  }\n\n  return command\n}\n\nfunction formatArg (arg) {\n  switch (typeof arg) {\n    case 'string':\n    case 'number':\n      return trim(String(arg), 100)\n    default:\n      return '?'\n  }\n}\n\nfunction trim (str, maxlen) {\n  if (str.length > maxlen) {\n    str = str.substr(0, maxlen - 3) + '...'\n  }\n\n  return str\n}\n\nfunction normalizeConfig (config) {\n  const filter = urlFilter.getFilter(config)\n\n  return Object.assign({}, config, {\n    filter\n  })\n}\n\nmodule.exports = RedisPlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}