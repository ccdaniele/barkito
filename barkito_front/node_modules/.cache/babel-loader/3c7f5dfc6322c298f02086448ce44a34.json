{"ast":null,"code":"'use strict';\n\nconst lookup = require('dns').lookup; // cache to avoid instrumentation\n\n\nconst dgram = require('dgram');\n\nconst isIP = require('net').isIP;\n\nconst log = require('./log');\n\nconst MAX_BUFFER_SIZE = 1024; // limit from the agent\n\nclass Client {\n  constructor(options) {\n    options = options || {};\n    this._host = options.host || 'localhost';\n    this._family = isIP(this._host);\n    this._port = options.port || 8125;\n    this._prefix = options.prefix || '';\n    this._tags = options.tags || [];\n    this._queue = [];\n    this._buffer = '';\n    this._offset = 0;\n    this._udp4 = this._socket('udp4');\n    this._udp6 = this._socket('udp6');\n  }\n\n  gauge(stat, value, tags) {\n    this._add(stat, value, 'g', tags);\n  }\n\n  increment(stat, value, tags) {\n    this._add(stat, value, 'c', tags);\n  }\n\n  flush() {\n    const queue = this._enqueue();\n\n    if (this._queue.length === 0) return;\n    this._queue = [];\n\n    if (this._family !== 0) {\n      this._sendAll(queue, this._host, this._family);\n    } else {\n      lookup(this._host, (err, address, family) => {\n        if (err) return log.error(err);\n\n        this._sendAll(queue, address, family);\n      });\n    }\n  }\n\n  _send(address, family, buffer) {\n    const socket = family === 6 ? this._udp6 : this._udp4;\n    log.debug(`Sending to DogStatsD: ${buffer}`);\n    socket.send(buffer, 0, buffer.length, this._port, address);\n  }\n\n  _sendAll(queue, address, family) {\n    queue.forEach(buffer => this._send(address, family, buffer));\n  }\n\n  _add(stat, value, type, tags) {\n    const message = `${this._prefix + stat}:${value}|${type}`;\n    tags = tags ? this._tags.concat(tags) : this._tags;\n\n    if (tags.length > 0) {\n      this._write(`${message}|#${tags.join(',')}\\n`);\n    } else {\n      this._write(`${message}\\n`);\n    }\n  }\n\n  _write(message) {\n    const offset = Buffer.byteLength(message);\n\n    if (this._offset + offset > MAX_BUFFER_SIZE) {\n      this._enqueue();\n    }\n\n    this._offset += offset;\n    this._buffer += message;\n  }\n\n  _enqueue() {\n    if (this._offset > 0) {\n      this._queue.push(Buffer.from(this._buffer));\n\n      this._buffer = '';\n      this._offset = 0;\n    }\n\n    return this._queue;\n  }\n\n  _socket(type) {\n    const socket = dgram.createSocket(type);\n    socket.on('error', () => {});\n    socket.unref();\n    return socket;\n  }\n\n}\n\nmodule.exports = Client;","map":{"version":3,"names":["lookup","require","dgram","isIP","log","MAX_BUFFER_SIZE","Client","constructor","options","_host","host","_family","_port","port","_prefix","prefix","_tags","tags","_queue","_buffer","_offset","_udp4","_socket","_udp6","gauge","stat","value","_add","increment","flush","queue","_enqueue","length","_sendAll","err","address","family","error","_send","buffer","socket","debug","send","forEach","type","message","concat","_write","join","offset","Buffer","byteLength","push","from","createSocket","on","unref","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/dogstatsd.js"],"sourcesContent":["'use strict'\n\nconst lookup = require('dns').lookup // cache to avoid instrumentation\nconst dgram = require('dgram')\nconst isIP = require('net').isIP\nconst log = require('./log')\n\nconst MAX_BUFFER_SIZE = 1024 // limit from the agent\n\nclass Client {\n  constructor (options) {\n    options = options || {}\n\n    this._host = options.host || 'localhost'\n    this._family = isIP(this._host)\n    this._port = options.port || 8125\n    this._prefix = options.prefix || ''\n    this._tags = options.tags || []\n    this._queue = []\n    this._buffer = ''\n    this._offset = 0\n    this._udp4 = this._socket('udp4')\n    this._udp6 = this._socket('udp6')\n  }\n\n  gauge (stat, value, tags) {\n    this._add(stat, value, 'g', tags)\n  }\n\n  increment (stat, value, tags) {\n    this._add(stat, value, 'c', tags)\n  }\n\n  flush () {\n    const queue = this._enqueue()\n\n    if (this._queue.length === 0) return\n\n    this._queue = []\n\n    if (this._family !== 0) {\n      this._sendAll(queue, this._host, this._family)\n    } else {\n      lookup(this._host, (err, address, family) => {\n        if (err) return log.error(err)\n        this._sendAll(queue, address, family)\n      })\n    }\n  }\n\n  _send (address, family, buffer) {\n    const socket = family === 6 ? this._udp6 : this._udp4\n\n    log.debug(`Sending to DogStatsD: ${buffer}`)\n\n    socket.send(buffer, 0, buffer.length, this._port, address)\n  }\n\n  _sendAll (queue, address, family) {\n    queue.forEach((buffer) => this._send(address, family, buffer))\n  }\n\n  _add (stat, value, type, tags) {\n    const message = `${this._prefix + stat}:${value}|${type}`\n\n    tags = tags ? this._tags.concat(tags) : this._tags\n\n    if (tags.length > 0) {\n      this._write(`${message}|#${tags.join(',')}\\n`)\n    } else {\n      this._write(`${message}\\n`)\n    }\n  }\n\n  _write (message) {\n    const offset = Buffer.byteLength(message)\n\n    if (this._offset + offset > MAX_BUFFER_SIZE) {\n      this._enqueue()\n    }\n\n    this._offset += offset\n    this._buffer += message\n  }\n\n  _enqueue () {\n    if (this._offset > 0) {\n      this._queue.push(Buffer.from(this._buffer))\n      this._buffer = ''\n      this._offset = 0\n    }\n\n    return this._queue\n  }\n\n  _socket (type) {\n    const socket = dgram.createSocket(type)\n\n    socket.on('error', () => {})\n    socket.unref()\n\n    return socket\n  }\n}\n\nmodule.exports = Client\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}