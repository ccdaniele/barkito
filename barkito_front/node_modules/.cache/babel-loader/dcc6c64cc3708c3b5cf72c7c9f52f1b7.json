{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst startCh = channel('apm:mariadb:query:start');\nconst finishCh = channel('apm:mariadb:query:finish');\nconst errorCh = channel('apm:mariadb:query:error');\n\nfunction wrapConnectionAddCommand(addCommand) {\n  return function (cmd) {\n    if (!startCh.hasSubscribers) return addCommand.apply(this, arguments);\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    const name = cmd && cmd.constructor && cmd.constructor.name;\n    const isCommand = typeof cmd.start === 'function';\n    const isQuery = isCommand && (name === 'Execute' || name === 'Query'); // TODO: consider supporting all commands and not just queries\n\n    cmd.start = isQuery ? wrapStart(cmd, cmd.start, asyncResource, this.opts) : bindStart(cmd, cmd.start, asyncResource);\n    return asyncResource.bind(addCommand, this).apply(this, arguments);\n  };\n}\n\nfunction bindStart(cmd, start, asyncResource) {\n  return asyncResource.bind(function (packet, connection) {\n    if (this.resolve) {\n      this.resolve = asyncResource.bind(this.resolve);\n    }\n\n    if (this.reject) {\n      this.reject = asyncResource.bind(this.reject);\n    }\n\n    return start.apply(this, arguments);\n  }, cmd);\n}\n\nfunction wrapStart(cmd, start, asyncResource, config) {\n  const callbackResource = new AsyncResource('bound-anonymous-fn');\n  return asyncResource.bind(function (packet, connection) {\n    if (!this.resolve || !this.reject) return start.apply(this, arguments);\n    const sql = cmd.statement ? cmd.statement.query : cmd.sql;\n    startCh.publish({\n      sql,\n      conf: config\n    });\n    const resolve = callbackResource.bind(this.resolve);\n    const reject = callbackResource.bind(this.reject);\n    this.resolve = asyncResource.bind(function () {\n      finishCh.publish(undefined);\n      resolve.apply(this, arguments);\n    }, 'bound-anonymous-fn', this);\n    this.reject = asyncResource.bind(function (error) {\n      errorCh.publish(error);\n      finishCh.publish(undefined);\n      reject.apply(this, arguments);\n    }, 'bound-anonymous-fn', this);\n    this.start = start;\n\n    try {\n      return start.apply(this, arguments);\n    } catch (err) {\n      errorCh.publish(err);\n    }\n  }, cmd);\n}\n\naddHook({\n  name: 'mariadb',\n  file: 'lib/connection.js',\n  versions: ['>=3']\n}, Connection => {\n  shimmer.wrap(Connection.prototype, 'addCommandEnable', wrapConnectionAddCommand);\n  shimmer.wrap(Connection.prototype, 'addCommandEnablePipeline', wrapConnectionAddCommand);\n  return Connection;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startCh","finishCh","errorCh","wrapConnectionAddCommand","addCommand","cmd","hasSubscribers","apply","arguments","asyncResource","name","constructor","isCommand","start","isQuery","wrapStart","opts","bindStart","bind","packet","connection","resolve","reject","config","callbackResource","sql","statement","query","publish","conf","undefined","error","err","file","versions","Connection","wrap","prototype"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/mariadb.js"],"sourcesContent":["'use strict'\n\nconst { channel, addHook, AsyncResource } = require('./helpers/instrument')\n\nconst shimmer = require('../../datadog-shimmer')\n\nconst startCh = channel('apm:mariadb:query:start')\nconst finishCh = channel('apm:mariadb:query:finish')\nconst errorCh = channel('apm:mariadb:query:error')\n\nfunction wrapConnectionAddCommand (addCommand) {\n  return function (cmd) {\n    if (!startCh.hasSubscribers) return addCommand.apply(this, arguments)\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    const name = cmd && cmd.constructor && cmd.constructor.name\n    const isCommand = typeof cmd.start === 'function'\n    const isQuery = isCommand && (name === 'Execute' || name === 'Query')\n\n    // TODO: consider supporting all commands and not just queries\n    cmd.start = isQuery\n      ? wrapStart(cmd, cmd.start, asyncResource, this.opts)\n      : bindStart(cmd, cmd.start, asyncResource)\n\n    return asyncResource.bind(addCommand, this).apply(this, arguments)\n  }\n}\n\nfunction bindStart (cmd, start, asyncResource) {\n  return asyncResource.bind(function (packet, connection) {\n    if (this.resolve) {\n      this.resolve = asyncResource.bind(this.resolve)\n    }\n\n    if (this.reject) {\n      this.reject = asyncResource.bind(this.reject)\n    }\n\n    return start.apply(this, arguments)\n  }, cmd)\n}\n\nfunction wrapStart (cmd, start, asyncResource, config) {\n  const callbackResource = new AsyncResource('bound-anonymous-fn')\n\n  return asyncResource.bind(function (packet, connection) {\n    if (!this.resolve || !this.reject) return start.apply(this, arguments)\n\n    const sql = cmd.statement ? cmd.statement.query : cmd.sql\n\n    startCh.publish({ sql, conf: config })\n\n    const resolve = callbackResource.bind(this.resolve)\n    const reject = callbackResource.bind(this.reject)\n\n    this.resolve = asyncResource.bind(function () {\n      finishCh.publish(undefined)\n      resolve.apply(this, arguments)\n    }, 'bound-anonymous-fn', this)\n\n    this.reject = asyncResource.bind(function (error) {\n      errorCh.publish(error)\n      finishCh.publish(undefined)\n      reject.apply(this, arguments)\n    }, 'bound-anonymous-fn', this)\n\n    this.start = start\n\n    try {\n      return start.apply(this, arguments)\n    } catch (err) {\n      errorCh.publish(err)\n    }\n  }, cmd)\n}\n\naddHook(\n  {\n    name: 'mariadb',\n    file: 'lib/connection.js',\n    versions: ['>=3']\n  },\n  (Connection) => {\n    shimmer.wrap(Connection.prototype, 'addCommandEnable', wrapConnectionAddCommand)\n    shimmer.wrap(Connection.prototype, 'addCommandEnablePipeline', wrapConnectionAddCommand)\n\n    return Connection\n  }\n)\n"],"mappings":"AAAA;;AAEA,MAAM;EAAEA,OAAF;EAAWC,OAAX;EAAoBC;AAApB,IAAsCC,OAAO,CAAC,sBAAD,CAAnD;;AAEA,MAAMC,OAAO,GAAGD,OAAO,CAAC,uBAAD,CAAvB;;AAEA,MAAME,OAAO,GAAGL,OAAO,CAAC,yBAAD,CAAvB;AACA,MAAMM,QAAQ,GAAGN,OAAO,CAAC,0BAAD,CAAxB;AACA,MAAMO,OAAO,GAAGP,OAAO,CAAC,yBAAD,CAAvB;;AAEA,SAASQ,wBAAT,CAAmCC,UAAnC,EAA+C;EAC7C,OAAO,UAAUC,GAAV,EAAe;IACpB,IAAI,CAACL,OAAO,CAACM,cAAb,EAA6B,OAAOF,UAAU,CAACG,KAAX,CAAiB,IAAjB,EAAuBC,SAAvB,CAAP;IAE7B,MAAMC,aAAa,GAAG,IAAIZ,aAAJ,CAAkB,oBAAlB,CAAtB;IACA,MAAMa,IAAI,GAAGL,GAAG,IAAIA,GAAG,CAACM,WAAX,IAA0BN,GAAG,CAACM,WAAJ,CAAgBD,IAAvD;IACA,MAAME,SAAS,GAAG,OAAOP,GAAG,CAACQ,KAAX,KAAqB,UAAvC;IACA,MAAMC,OAAO,GAAGF,SAAS,KAAKF,IAAI,KAAK,SAAT,IAAsBA,IAAI,KAAK,OAApC,CAAzB,CANoB,CAQpB;;IACAL,GAAG,CAACQ,KAAJ,GAAYC,OAAO,GACfC,SAAS,CAACV,GAAD,EAAMA,GAAG,CAACQ,KAAV,EAAiBJ,aAAjB,EAAgC,KAAKO,IAArC,CADM,GAEfC,SAAS,CAACZ,GAAD,EAAMA,GAAG,CAACQ,KAAV,EAAiBJ,aAAjB,CAFb;IAIA,OAAOA,aAAa,CAACS,IAAd,CAAmBd,UAAnB,EAA+B,IAA/B,EAAqCG,KAArC,CAA2C,IAA3C,EAAiDC,SAAjD,CAAP;EACD,CAdD;AAeD;;AAED,SAASS,SAAT,CAAoBZ,GAApB,EAAyBQ,KAAzB,EAAgCJ,aAAhC,EAA+C;EAC7C,OAAOA,aAAa,CAACS,IAAd,CAAmB,UAAUC,MAAV,EAAkBC,UAAlB,EAA8B;IACtD,IAAI,KAAKC,OAAT,EAAkB;MAChB,KAAKA,OAAL,GAAeZ,aAAa,CAACS,IAAd,CAAmB,KAAKG,OAAxB,CAAf;IACD;;IAED,IAAI,KAAKC,MAAT,EAAiB;MACf,KAAKA,MAAL,GAAcb,aAAa,CAACS,IAAd,CAAmB,KAAKI,MAAxB,CAAd;IACD;;IAED,OAAOT,KAAK,CAACN,KAAN,CAAY,IAAZ,EAAkBC,SAAlB,CAAP;EACD,CAVM,EAUJH,GAVI,CAAP;AAWD;;AAED,SAASU,SAAT,CAAoBV,GAApB,EAAyBQ,KAAzB,EAAgCJ,aAAhC,EAA+Cc,MAA/C,EAAuD;EACrD,MAAMC,gBAAgB,GAAG,IAAI3B,aAAJ,CAAkB,oBAAlB,CAAzB;EAEA,OAAOY,aAAa,CAACS,IAAd,CAAmB,UAAUC,MAAV,EAAkBC,UAAlB,EAA8B;IACtD,IAAI,CAAC,KAAKC,OAAN,IAAiB,CAAC,KAAKC,MAA3B,EAAmC,OAAOT,KAAK,CAACN,KAAN,CAAY,IAAZ,EAAkBC,SAAlB,CAAP;IAEnC,MAAMiB,GAAG,GAAGpB,GAAG,CAACqB,SAAJ,GAAgBrB,GAAG,CAACqB,SAAJ,CAAcC,KAA9B,GAAsCtB,GAAG,CAACoB,GAAtD;IAEAzB,OAAO,CAAC4B,OAAR,CAAgB;MAAEH,GAAF;MAAOI,IAAI,EAAEN;IAAb,CAAhB;IAEA,MAAMF,OAAO,GAAGG,gBAAgB,CAACN,IAAjB,CAAsB,KAAKG,OAA3B,CAAhB;IACA,MAAMC,MAAM,GAAGE,gBAAgB,CAACN,IAAjB,CAAsB,KAAKI,MAA3B,CAAf;IAEA,KAAKD,OAAL,GAAeZ,aAAa,CAACS,IAAd,CAAmB,YAAY;MAC5CjB,QAAQ,CAAC2B,OAAT,CAAiBE,SAAjB;MACAT,OAAO,CAACd,KAAR,CAAc,IAAd,EAAoBC,SAApB;IACD,CAHc,EAGZ,oBAHY,EAGU,IAHV,CAAf;IAKA,KAAKc,MAAL,GAAcb,aAAa,CAACS,IAAd,CAAmB,UAAUa,KAAV,EAAiB;MAChD7B,OAAO,CAAC0B,OAAR,CAAgBG,KAAhB;MACA9B,QAAQ,CAAC2B,OAAT,CAAiBE,SAAjB;MACAR,MAAM,CAACf,KAAP,CAAa,IAAb,EAAmBC,SAAnB;IACD,CAJa,EAIX,oBAJW,EAIW,IAJX,CAAd;IAMA,KAAKK,KAAL,GAAaA,KAAb;;IAEA,IAAI;MACF,OAAOA,KAAK,CAACN,KAAN,CAAY,IAAZ,EAAkBC,SAAlB,CAAP;IACD,CAFD,CAEE,OAAOwB,GAAP,EAAY;MACZ9B,OAAO,CAAC0B,OAAR,CAAgBI,GAAhB;IACD;EACF,CA5BM,EA4BJ3B,GA5BI,CAAP;AA6BD;;AAEDT,OAAO,CACL;EACEc,IAAI,EAAE,SADR;EAEEuB,IAAI,EAAE,mBAFR;EAGEC,QAAQ,EAAE,CAAC,KAAD;AAHZ,CADK,EAMJC,UAAD,IAAgB;EACdpC,OAAO,CAACqC,IAAR,CAAaD,UAAU,CAACE,SAAxB,EAAmC,kBAAnC,EAAuDlC,wBAAvD;EACAJ,OAAO,CAACqC,IAAR,CAAaD,UAAU,CAACE,SAAxB,EAAmC,0BAAnC,EAA+DlC,wBAA/D;EAEA,OAAOgC,UAAP;AACD,CAXI,CAAP"},"metadata":{},"sourceType":"script"}