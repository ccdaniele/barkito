{"ast":null,"code":"'use strict';\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin');\n\nconst {\n  storage\n} = require('../../datadog-core');\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nclass NextPlugin extends Plugin {\n  static get name() {\n    return 'next';\n  }\n\n  constructor() {\n    super(...arguments);\n    this._requests = new WeakMap();\n    this.addSub('apm:next:request:start', _ref => {\n      let {\n        req,\n        res\n      } = _ref;\n      const store = storage.getStore();\n      const childOf = store ? store.span : store;\n      const span = this.tracer.startSpan('next.request', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || this.tracer._service,\n          'resource.name': req.method,\n          'span.type': 'web',\n          'span.kind': 'server',\n          'http.method': req.method\n        }\n      });\n      analyticsSampler.sample(span, this.config.measured, true);\n      this.enter(span, store);\n\n      this._requests.set(span, req);\n    });\n    this.addSub('apm:next:request:error', this.addError);\n    this.addSub('apm:next:request:finish', _ref2 => {\n      let {\n        req,\n        res\n      } = _ref2;\n      const store = storage.getStore();\n      if (!store) return;\n      const span = store.span;\n\n      const error = span.context()._tags['error'];\n\n      if (!this.config.validateStatus(res.statusCode) && !error) {\n        span.setTag('error', true);\n      }\n\n      span.addTags({\n        'http.status_code': res.statusCode\n      });\n      this.config.hooks.request(span, req, res);\n      span.finish();\n    });\n    this.addSub('apm:next:page:load', _ref3 => {\n      let {\n        page\n      } = _ref3;\n      const store = storage.getStore();\n      if (!store) return;\n      const span = store.span;\n\n      const req = this._requests.get(span);\n\n      span.addTags({\n        'resource.name': `${req.method} ${page}`.trim(),\n        'next.page': page\n      });\n    });\n  }\n\n  configure(config) {\n    return super.configure(normalizeConfig(config));\n  }\n\n}\n\nfunction normalizeConfig(config) {\n  const hooks = getHooks(config);\n  const validateStatus = typeof config.validateStatus === 'function' ? config.validateStatus : code => code < 500;\n  return Object.assign({}, config, {\n    hooks,\n    validateStatus\n  });\n}\n\nfunction getHooks(config) {\n  const noop = () => {};\n\n  const request = config.hooks && config.hooks.request || noop;\n  return {\n    request\n  };\n}\n\nmodule.exports = NextPlugin;","map":{"version":3,"names":["Plugin","require","storage","analyticsSampler","NextPlugin","name","constructor","_requests","WeakMap","addSub","req","res","store","getStore","childOf","span","tracer","startSpan","tags","config","service","_service","method","sample","measured","enter","set","addError","error","context","_tags","validateStatus","statusCode","setTag","addTags","hooks","request","finish","page","get","trim","configure","normalizeConfig","getHooks","code","Object","assign","noop","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-next/src/index.js"],"sourcesContent":["'use strict'\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin')\nconst { storage } = require('../../datadog-core')\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\n\nclass NextPlugin extends Plugin {\n  static get name () {\n    return 'next'\n  }\n\n  constructor (...args) {\n    super(...args)\n\n    this._requests = new WeakMap()\n\n    this.addSub('apm:next:request:start', ({ req, res }) => {\n      const store = storage.getStore()\n      const childOf = store ? store.span : store\n      const span = this.tracer.startSpan('next.request', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || this.tracer._service,\n          'resource.name': req.method,\n          'span.type': 'web',\n          'span.kind': 'server',\n          'http.method': req.method\n        }\n      })\n\n      analyticsSampler.sample(span, this.config.measured, true)\n\n      this.enter(span, store)\n\n      this._requests.set(span, req)\n    })\n\n    this.addSub('apm:next:request:error', this.addError)\n\n    this.addSub('apm:next:request:finish', ({ req, res }) => {\n      const store = storage.getStore()\n\n      if (!store) return\n\n      const span = store.span\n      const error = span.context()._tags['error']\n\n      if (!this.config.validateStatus(res.statusCode) && !error) {\n        span.setTag('error', true)\n      }\n\n      span.addTags({\n        'http.status_code': res.statusCode\n      })\n\n      this.config.hooks.request(span, req, res)\n\n      span.finish()\n    })\n\n    this.addSub('apm:next:page:load', ({ page }) => {\n      const store = storage.getStore()\n\n      if (!store) return\n\n      const span = store.span\n      const req = this._requests.get(span)\n\n      span.addTags({\n        'resource.name': `${req.method} ${page}`.trim(),\n        'next.page': page\n      })\n    })\n  }\n\n  configure (config) {\n    return super.configure(normalizeConfig(config))\n  }\n}\n\nfunction normalizeConfig (config) {\n  const hooks = getHooks(config)\n  const validateStatus = typeof config.validateStatus === 'function'\n    ? config.validateStatus\n    : code => code < 500\n\n  return Object.assign({}, config, { hooks, validateStatus })\n}\n\nfunction getHooks (config) {\n  const noop = () => {}\n  const request = (config.hooks && config.hooks.request) || noop\n\n  return { request }\n}\n\nmodule.exports = NextPlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}