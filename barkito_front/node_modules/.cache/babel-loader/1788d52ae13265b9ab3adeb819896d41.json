{"ast":null,"code":"'use strict';\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst {\n  addHook,\n  channel,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst handleChannel = channel('apm:hapi:request:handle');\nconst routeChannel = channel('apm:hapi:request:route');\nconst errorChannel = channel('apm:hapi:request:error');\nconst enterChannel = channel('apm:hapi:extension:enter');\n\nfunction wrapServer(server) {\n  return function (options) {\n    const app = server.apply(this, arguments);\n    if (!app) return app;\n\n    if (typeof app.ext === 'function') {\n      app.ext = wrapExt(app.ext);\n    }\n\n    if (typeof app.start === 'function') {\n      app.start = wrapStart(app.start);\n    }\n\n    return app;\n  };\n}\n\nfunction wrapStart(start) {\n  return function () {\n    if (this && typeof this.ext === 'function') {\n      this.ext('onPreResponse', onPreResponse);\n    }\n\n    return start.apply(this, arguments);\n  };\n}\n\nfunction wrapExt(ext) {\n  return function (events, method, options) {\n    if (typeof events === 'object') {\n      arguments[0] = wrapEvents(events);\n    } else {\n      arguments[1] = wrapExtension(method);\n    }\n\n    return ext.apply(this, arguments);\n  };\n}\n\nfunction wrapDispatch(dispatch) {\n  return function (options) {\n    const handler = dispatch.apply(this, arguments);\n    if (typeof handler !== 'function') return handler;\n    return function (req, res) {\n      handleChannel.publish({\n        req,\n        res\n      });\n      return handler.apply(this, arguments);\n    };\n  };\n}\n\nfunction wrapRebuild(rebuild) {\n  return function (event) {\n    const result = rebuild.apply(this, arguments);\n\n    if (this && Array.isArray(this._cycle)) {\n      this._cycle = this._cycle.map(wrapHandler);\n    }\n\n    return result;\n  };\n}\n\nfunction wrapExtension(method) {\n  return [].concat(method).map(wrapHandler);\n}\n\nfunction wrapEvents(events) {\n  return [].concat(events).map(event => {\n    if (!event || !event.method) return event;\n    return Object.assign({}, event, {\n      method: wrapExtension(event.method)\n    });\n  });\n}\n\nfunction wrapHandler(handler) {\n  if (typeof handler !== 'function') return handler;\n  return function (request, h) {\n    const req = request && request.raw && request.raw.req;\n    if (!req) return handler.apply(this, arguments);\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      enterChannel.publish({\n        req\n      });\n      return handler.apply(this, arguments);\n    });\n  };\n}\n\nfunction onPreResponse(request, h) {\n  if (!request || !request.raw) return reply(request, h);\n  const req = request.raw.req;\n\n  if (request.response instanceof Error) {\n    errorChannel.publish(request.response);\n  }\n\n  if (request.route) {\n    routeChannel.publish({\n      req,\n      route: request.route.path\n    });\n  }\n\n  return reply(request, h);\n}\n\nfunction reply(request, h) {\n  if (h.continue) {\n    return typeof h.continue === 'function' ? h.continue() : h.continue;\n  } else if (typeof h === 'function') {\n    return h();\n  }\n}\n\naddHook({\n  name: '@hapi/hapi',\n  versions: ['>=17.9']\n}, hapi => {\n  shimmer.massWrap(hapi, ['server', 'Server'], wrapServer);\n  return hapi;\n});\naddHook({\n  name: '@hapi/hapi',\n  versions: ['>=17.9'],\n  file: 'lib/core.js'\n}, Core => {\n  shimmer.wrap(Core.prototype, '_dispatch', wrapDispatch);\n  return Core;\n});\naddHook({\n  name: '@hapi/hapi',\n  versions: ['>=17.9'],\n  file: 'lib/route.js'\n}, Route => {\n  shimmer.wrap(Route.prototype, 'rebuild', wrapRebuild);\n  return Route;\n});\naddHook({\n  name: 'hapi',\n  versions: ['>=17']\n}, hapi => {\n  shimmer.massWrap(hapi, ['server', 'Server'], wrapServer);\n  return hapi;\n});\naddHook({\n  name: 'hapi',\n  versions: ['16']\n}, hapi => {\n  shimmer.wrap(hapi.Server.prototype, 'start', wrapStart);\n  shimmer.wrap(hapi.Server.prototype, 'ext', wrapExt);\n  return hapi;\n});\naddHook({\n  name: 'hapi',\n  versions: ['16'],\n  file: 'lib/connection.js'\n}, Connection => {\n  shimmer.wrap(Connection.prototype, '_dispatch', wrapDispatch);\n  return Connection;\n});\naddHook({\n  name: 'hapi',\n  versions: ['>=17'],\n  file: 'lib/core.js'\n}, Core => {\n  shimmer.wrap(Core.prototype, '_dispatch', wrapDispatch);\n  return Core;\n});\naddHook({\n  name: 'hapi',\n  versions: ['>=16'],\n  file: 'lib/route.js'\n}, Route => {\n  shimmer.wrap(Route.prototype, 'rebuild', wrapRebuild);\n  return Route;\n});","map":{"version":3,"names":["shimmer","require","addHook","channel","AsyncResource","handleChannel","routeChannel","errorChannel","enterChannel","wrapServer","server","options","app","apply","arguments","ext","wrapExt","start","wrapStart","onPreResponse","events","method","wrapEvents","wrapExtension","wrapDispatch","dispatch","handler","req","res","publish","wrapRebuild","rebuild","event","result","Array","isArray","_cycle","map","wrapHandler","concat","Object","assign","request","h","raw","asyncResource","runInAsyncScope","reply","response","Error","route","path","continue","name","versions","hapi","massWrap","file","Core","wrap","prototype","Route","Server","Connection"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/hapi.js"],"sourcesContent":["'use strict'\n\nconst shimmer = require('../../datadog-shimmer')\nconst { addHook, channel, AsyncResource } = require('./helpers/instrument')\n\nconst handleChannel = channel('apm:hapi:request:handle')\nconst routeChannel = channel('apm:hapi:request:route')\nconst errorChannel = channel('apm:hapi:request:error')\nconst enterChannel = channel('apm:hapi:extension:enter')\n\nfunction wrapServer (server) {\n  return function (options) {\n    const app = server.apply(this, arguments)\n\n    if (!app) return app\n\n    if (typeof app.ext === 'function') {\n      app.ext = wrapExt(app.ext)\n    }\n\n    if (typeof app.start === 'function') {\n      app.start = wrapStart(app.start)\n    }\n\n    return app\n  }\n}\n\nfunction wrapStart (start) {\n  return function () {\n    if (this && typeof this.ext === 'function') {\n      this.ext('onPreResponse', onPreResponse)\n    }\n\n    return start.apply(this, arguments)\n  }\n}\n\nfunction wrapExt (ext) {\n  return function (events, method, options) {\n    if (typeof events === 'object') {\n      arguments[0] = wrapEvents(events)\n    } else {\n      arguments[1] = wrapExtension(method)\n    }\n\n    return ext.apply(this, arguments)\n  }\n}\n\nfunction wrapDispatch (dispatch) {\n  return function (options) {\n    const handler = dispatch.apply(this, arguments)\n\n    if (typeof handler !== 'function') return handler\n\n    return function (req, res) {\n      handleChannel.publish({ req, res })\n\n      return handler.apply(this, arguments)\n    }\n  }\n}\n\nfunction wrapRebuild (rebuild) {\n  return function (event) {\n    const result = rebuild.apply(this, arguments)\n\n    if (this && Array.isArray(this._cycle)) {\n      this._cycle = this._cycle.map(wrapHandler)\n    }\n\n    return result\n  }\n}\n\nfunction wrapExtension (method) {\n  return [].concat(method).map(wrapHandler)\n}\n\nfunction wrapEvents (events) {\n  return [].concat(events).map(event => {\n    if (!event || !event.method) return event\n\n    return Object.assign({}, event, {\n      method: wrapExtension(event.method)\n    })\n  })\n}\n\nfunction wrapHandler (handler) {\n  if (typeof handler !== 'function') return handler\n\n  return function (request, h) {\n    const req = request && request.raw && request.raw.req\n\n    if (!req) return handler.apply(this, arguments)\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n    return asyncResource.runInAsyncScope(() => {\n      enterChannel.publish({ req })\n\n      return handler.apply(this, arguments)\n    })\n  }\n}\n\nfunction onPreResponse (request, h) {\n  if (!request || !request.raw) return reply(request, h)\n\n  const req = request.raw.req\n\n  if (request.response instanceof Error) {\n    errorChannel.publish(request.response)\n  }\n\n  if (request.route) {\n    routeChannel.publish({ req, route: request.route.path })\n  }\n\n  return reply(request, h)\n}\n\nfunction reply (request, h) {\n  if (h.continue) {\n    return typeof h.continue === 'function'\n      ? h.continue()\n      : h.continue\n  } else if (typeof h === 'function') {\n    return h()\n  }\n}\n\naddHook({ name: '@hapi/hapi', versions: ['>=17.9'] }, hapi => {\n  shimmer.massWrap(hapi, ['server', 'Server'], wrapServer)\n\n  return hapi\n})\n\naddHook({ name: '@hapi/hapi', versions: ['>=17.9'], file: 'lib/core.js' }, Core => {\n  shimmer.wrap(Core.prototype, '_dispatch', wrapDispatch)\n\n  return Core\n})\n\naddHook({ name: '@hapi/hapi', versions: ['>=17.9'], file: 'lib/route.js' }, Route => {\n  shimmer.wrap(Route.prototype, 'rebuild', wrapRebuild)\n\n  return Route\n})\n\naddHook({ name: 'hapi', versions: ['>=17'] }, hapi => {\n  shimmer.massWrap(hapi, ['server', 'Server'], wrapServer)\n\n  return hapi\n})\n\naddHook({ name: 'hapi', versions: ['16'] }, hapi => {\n  shimmer.wrap(hapi.Server.prototype, 'start', wrapStart)\n  shimmer.wrap(hapi.Server.prototype, 'ext', wrapExt)\n\n  return hapi\n})\n\naddHook({ name: 'hapi', versions: ['16'], file: 'lib/connection.js' }, Connection => {\n  shimmer.wrap(Connection.prototype, '_dispatch', wrapDispatch)\n\n  return Connection\n})\n\naddHook({ name: 'hapi', versions: ['>=17'], file: 'lib/core.js' }, Core => {\n  shimmer.wrap(Core.prototype, '_dispatch', wrapDispatch)\n\n  return Core\n})\n\naddHook({ name: 'hapi', versions: ['>=16'], file: 'lib/route.js' }, Route => {\n  shimmer.wrap(Route.prototype, 'rebuild', wrapRebuild)\n\n  return Route\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}