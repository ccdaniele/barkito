{"ast":null,"code":"'use strict';\n\nconst net = require('net');\n\nconst uniq = require('lodash.uniq');\n\nconst analyticsSampler = require('../../analytics_sampler');\n\nconst FORMAT_HTTP_HEADERS = 'http_headers';\n\nconst log = require('../../log');\n\nconst tags = require('../../../../../ext/tags');\n\nconst types = require('../../../../../ext/types');\n\nconst kinds = require('../../../../../ext/kinds');\n\nconst urlFilter = require('./urlfilter');\n\nconst BlockList = require('./ip_blocklist');\n\nconst {\n  incomingHttpRequestEnd\n} = require('../../appsec/gateway/channels');\n\nconst WEB = types.WEB;\nconst SERVER = kinds.SERVER;\nconst RESOURCE_NAME = tags.RESOURCE_NAME;\nconst SERVICE_NAME = tags.SERVICE_NAME;\nconst SPAN_TYPE = tags.SPAN_TYPE;\nconst SPAN_KIND = tags.SPAN_KIND;\nconst ERROR = tags.ERROR;\nconst HTTP_METHOD = tags.HTTP_METHOD;\nconst HTTP_URL = tags.HTTP_URL;\nconst HTTP_STATUS_CODE = tags.HTTP_STATUS_CODE;\nconst HTTP_ROUTE = tags.HTTP_ROUTE;\nconst HTTP_REQUEST_HEADERS = tags.HTTP_REQUEST_HEADERS;\nconst HTTP_RESPONSE_HEADERS = tags.HTTP_RESPONSE_HEADERS;\nconst HTTP_USERAGENT = tags.HTTP_USERAGENT;\nconst HTTP_CLIENT_IP = tags.HTTP_CLIENT_IP;\nconst MANUAL_DROP = tags.MANUAL_DROP;\nconst HTTP2_HEADER_AUTHORITY = ':authority';\nconst HTTP2_HEADER_SCHEME = ':scheme';\nconst HTTP2_HEADER_PATH = ':path';\nconst ipHeaderList = ['x-forwarded-for', 'x-real-ip', 'client-ip', 'x-forwarded', 'x-cluster-client-ip', 'forwarded-for', 'forwarded', 'via', 'true-client-ip'];\nconst contexts = new WeakMap();\nconst ends = new WeakMap();\nconst web = {\n  // Ensure the configuration has the correct structure and defaults.\n  normalizeConfig(config) {\n    config = config.server || config;\n    const headers = getHeadersToRecord(config);\n    const validateStatus = getStatusValidator(config);\n    const hooks = getHooks(config);\n    const filter = urlFilter.getFilter(config);\n    const middleware = getMiddlewareSetting(config);\n    return Object.assign({}, config, {\n      headers,\n      validateStatus,\n      hooks,\n      filter,\n      middleware\n    });\n  },\n\n  setFramework(req, name, config) {\n    const context = this.patch(req);\n    const span = context.span;\n    if (!span) return;\n    span.context()._name = `${name}.request`;\n    web.setConfig(req, config);\n  },\n\n  setConfig(req, config) {\n    const context = contexts.get(req);\n    const span = context.span;\n    context.config = config;\n\n    if (!config.filter(req.url)) {\n      span.setTag(MANUAL_DROP, true);\n      span.context()._trace.isRecording = false;\n    }\n\n    if (config.service) {\n      span.setTag(SERVICE_NAME, config.service);\n    }\n\n    analyticsSampler.sample(span, config.measured, true);\n  },\n\n  startSpan(tracer, config, req, res, name) {\n    const context = this.patch(req);\n    let span;\n\n    if (context.span) {\n      context.span.context()._name = name;\n      span = context.span;\n    } else {\n      span = web.startChildSpan(tracer, name, req.headers);\n    }\n\n    context.tracer = tracer;\n    context.span = span;\n    context.res = res;\n    this.setConfig(req, config);\n    return span;\n  },\n\n  wrap(req) {\n    const context = contexts.get(req);\n\n    if (!context.instrumented) {\n      this.wrapEnd(context);\n      context.instrumented = true;\n    }\n  },\n\n  // Start a span and activate a scope for a request.\n  instrument(tracer, config, req, res, name, callback) {\n    const span = this.startSpan(tracer, config, req, res, name);\n    this.wrap(req);\n    return callback && tracer.scope().activate(span, () => callback(span));\n  },\n\n  // Reactivate the request scope in case it was changed by a middleware.\n  reactivate(req, fn) {\n    return reactivate(req, fn);\n  },\n\n  // Add a route segment that will be used for the resource name.\n  enterRoute(req, path) {\n    if (typeof path === 'string') {\n      contexts.get(req).paths.push(path);\n    }\n  },\n\n  setRoute(req, path) {\n    const context = contexts.get(req);\n    if (!context) return;\n    context.paths = [path];\n  },\n\n  // Remove the current route segment.\n  exitRoute(req) {\n    contexts.get(req).paths.pop();\n  },\n\n  // Start a new middleware span and activate a new scope with the span.\n  wrapMiddleware(req, middleware, name, fn) {\n    if (!this.active(req)) return fn();\n    const context = contexts.get(req);\n    const tracer = context.tracer;\n    const childOf = this.active(req);\n    const config = context.config;\n    if (config.middleware === false) return this.bindAndWrapMiddlewareErrors(fn, req, tracer, childOf);\n    const span = tracer.startSpan(name, {\n      childOf\n    });\n    analyticsSampler.sample(span, config.measured);\n    span.addTags({\n      [RESOURCE_NAME]: middleware._name || middleware.name || '<anonymous>'\n    });\n    context.middleware.push(span);\n    return tracer.scope().activate(span, fn);\n  },\n\n  // catch errors and apply to active span\n  bindAndWrapMiddlewareErrors(fn, req, tracer, activeSpan) {\n    try {\n      return tracer.scope().bind(fn, activeSpan).apply(this, arguments);\n    } catch (e) {\n      web.addError(req, e); // TODO: remove when error formatting is moved to Span\n\n      throw e;\n    }\n  },\n\n  // Finish the active middleware span.\n  finish(req, error) {\n    if (!this.active(req)) return;\n    const context = contexts.get(req);\n    const span = context.middleware.pop();\n\n    if (span) {\n      if (error) {\n        span.addTags({\n          'error.type': error.name,\n          'error.msg': error.message,\n          'error.stack': error.stack\n        });\n      }\n\n      span.finish();\n    }\n  },\n\n  // Register a callback to run before res.end() is called.\n  beforeEnd(req, callback) {\n    contexts.get(req).beforeEnd.push(callback);\n  },\n\n  // Prepare the request for instrumentation.\n  patch(req) {\n    let context = contexts.get(req);\n    if (context) return context;\n    context = req.stream && contexts.get(req.stream);\n\n    if (context) {\n      contexts.set(req, context);\n      return context;\n    }\n\n    context = {\n      req,\n      span: null,\n      paths: [],\n      middleware: [],\n      beforeEnd: [],\n      config: {}\n    };\n    contexts.set(req, context);\n    return context;\n  },\n\n  // Return the request root span.\n  root(req) {\n    const context = contexts.get(req);\n    return context ? context.span : null;\n  },\n\n  // Return the active span.\n  active(req) {\n    const context = contexts.get(req);\n    if (!context) return null;\n    if (context.middleware.length === 0) return context.span || null;\n    return context.middleware.slice(-1)[0];\n  },\n\n  // Extract the parent span from the headers and start a new span as its child\n  startChildSpan(tracer, name, headers) {\n    const childOf = tracer.scope().active() || tracer.extract(FORMAT_HTTP_HEADERS, headers);\n    const span = tracer.startSpan(name, {\n      childOf\n    });\n    return span;\n  },\n\n  // Validate a request's status code and then add error tags if necessary\n  addStatusError(req, statusCode) {\n    const context = contexts.get(req);\n    const span = context.span;\n    const error = context.error;\n\n    const hasExistingError = span.context()._tags['error'] || span.context()._tags['error.msg'];\n\n    if (!hasExistingError && !context.config.validateStatus(statusCode)) {\n      span.setTag(ERROR, error || true);\n    }\n  },\n\n  // Add an error to the request\n  addError(req, error) {\n    if (error instanceof Error) {\n      const context = contexts.get(req);\n\n      if (context) {\n        context.error = error;\n      }\n    }\n  },\n\n  finishMiddleware(context) {\n    if (context.finished) return;\n    let span;\n\n    while (span = context.middleware.pop()) {\n      span.finish();\n    }\n  },\n\n  finishSpan(context) {\n    const {\n      req,\n      res\n    } = context;\n    if (context.finished && !req.stream) return;\n    addRequestTags(context);\n    addResponseTags(context);\n    context.config.hooks.request(context.span, req, res);\n    addResourceTag(context);\n    context.span.finish();\n    context.finished = true;\n  },\n\n  finishAll(context) {\n    const {\n      req,\n      res\n    } = context;\n\n    for (const beforeEnd of context.beforeEnd) {\n      beforeEnd();\n    }\n\n    web.finishMiddleware(context);\n\n    if (incomingHttpRequestEnd.hasSubscribers) {\n      incomingHttpRequestEnd.publish({\n        req,\n        res\n      });\n    }\n\n    web.finishSpan(context);\n  },\n\n  extractIp(context) {\n    const {\n      req,\n      config\n    } = context;\n    if (config.clientIpHeaderDisabled) return;\n    const headers = req.headers;\n\n    if (config.clientIpHeader) {\n      const header = headers[config.clientIpHeader];\n      if (!header) return;\n      return findFirstIp(header);\n    }\n\n    const foundHeaders = [];\n\n    for (let i = 0; i < ipHeaderList.length; i++) {\n      if (headers[ipHeaderList[i]]) {\n        foundHeaders.push(ipHeaderList[i]);\n      }\n    }\n\n    if (foundHeaders.length === 1) {\n      const header = headers[foundHeaders[0]];\n      const firstIp = findFirstIp(header);\n      if (firstIp) return firstIp;\n    } else if (foundHeaders.length > 1) {\n      log.error(`Cannot find client IP: multiple IP headers detected ${foundHeaders}`);\n      return;\n    }\n\n    return req.socket && req.socket.remoteAddress;\n  },\n\n  wrapWriteHead(context) {\n    const {\n      req,\n      res\n    } = context;\n    const writeHead = res.writeHead;\n    return function (statusCode, statusMessage, headers) {\n      headers = typeof statusMessage === 'string' ? headers : statusMessage;\n      headers = Object.assign(res.getHeaders(), headers);\n\n      if (req.method.toLowerCase() === 'options' && isOriginAllowed(req, headers)) {\n        addAllowHeaders(req, res, headers);\n      }\n\n      return writeHead.apply(this, arguments);\n    };\n  },\n\n  getContext(req) {\n    return contexts.get(req);\n  },\n\n  wrapRes(context, req, res, end) {\n    return function () {\n      web.finishAll(context);\n      return end.apply(res, arguments);\n    };\n  },\n\n  wrapEnd(context) {\n    const scope = context.tracer.scope();\n    const req = context.req;\n    const res = context.res;\n    const end = res.end;\n    res.writeHead = web.wrapWriteHead(context);\n    ends.set(res, this.wrapRes(context, req, res, end));\n    Object.defineProperty(res, 'end', {\n      configurable: true,\n\n      get() {\n        return ends.get(this);\n      },\n\n      set(value) {\n        ends.set(this, scope.bind(value, context.span));\n      }\n\n    });\n  }\n\n};\n\nfunction addAllowHeaders(req, res, headers) {\n  const allowHeaders = splitHeader(headers['access-control-allow-headers']);\n  const requestHeaders = splitHeader(req.headers['access-control-request-headers']);\n  const contextHeaders = ['x-datadog-origin', 'x-datadog-parent-id', 'x-datadog-sampled', // Deprecated, but still accept it in case it's sent.\n  'x-datadog-sampling-priority', 'x-datadog-trace-id', 'x-datadog-tags'];\n\n  for (const header of contextHeaders) {\n    if (~requestHeaders.indexOf(header)) {\n      allowHeaders.push(header);\n    }\n  }\n\n  if (allowHeaders.length > 0) {\n    res.setHeader('access-control-allow-headers', uniq(allowHeaders).join(','));\n  }\n}\n\nfunction isOriginAllowed(req, headers) {\n  const origin = req.headers['origin'];\n  const allowOrigin = headers['access-control-allow-origin'];\n  return origin && (allowOrigin === '*' || allowOrigin === origin);\n}\n\nfunction splitHeader(str) {\n  return typeof str === 'string' ? str.split(/\\s*,\\s*/) : [];\n}\n\nfunction reactivate(req, fn) {\n  const context = contexts.get(req);\n  return context ? context.tracer.scope().activate(context.span, fn) : fn();\n}\n\nfunction addRequestTags(context) {\n  const {\n    req,\n    span\n  } = context;\n  const url = extractURL(req);\n  span.addTags({\n    [HTTP_URL]: url.split('?')[0],\n    [HTTP_METHOD]: req.method,\n    [SPAN_KIND]: SERVER,\n    [SPAN_TYPE]: WEB,\n    [HTTP_USERAGENT]: req.headers['user-agent'],\n    [HTTP_CLIENT_IP]: web.extractIp(context)\n  });\n  addHeaders(context);\n}\n\nfunction addResponseTags(context) {\n  const {\n    req,\n    res,\n    paths,\n    span\n  } = context;\n\n  if (paths.length > 0) {\n    span.setTag(HTTP_ROUTE, paths.join(''));\n  }\n\n  span.addTags({\n    [HTTP_STATUS_CODE]: res.statusCode\n  });\n  web.addStatusError(req, res.statusCode);\n}\n\nfunction addResourceTag(context) {\n  const {\n    req,\n    span\n  } = context;\n\n  const tags = span.context()._tags;\n\n  if (tags['resource.name']) return;\n  const resource = [req.method, tags[HTTP_ROUTE]].filter(val => val).join(' ');\n  span.setTag(RESOURCE_NAME, resource);\n}\n\nfunction addHeaders(context) {\n  const {\n    req,\n    res,\n    config,\n    span\n  } = context;\n  config.headers.forEach(key => {\n    const reqHeader = req.headers[key];\n    const resHeader = res.getHeader(key);\n\n    if (reqHeader) {\n      span.setTag(`${HTTP_REQUEST_HEADERS}.${key}`, reqHeader);\n    }\n\n    if (resHeader) {\n      span.setTag(`${HTTP_RESPONSE_HEADERS}.${key}`, resHeader);\n    }\n  });\n}\n\nfunction extractURL(req) {\n  const headers = req.headers;\n\n  if (req.stream) {\n    return `${headers[HTTP2_HEADER_SCHEME]}://${headers[HTTP2_HEADER_AUTHORITY]}${headers[HTTP2_HEADER_PATH]}`;\n  } else {\n    const protocol = getProtocol(req);\n    return `${protocol}://${req.headers['host']}${req.originalUrl || req.url}`;\n  }\n}\n\nfunction getProtocol(req) {\n  if (req.socket && req.socket.encrypted) return 'https';\n  if (req.connection && req.connection.encrypted) return 'https';\n  return 'http';\n}\n\nconst privateCIDRs = ['127.0.0.0/8', '10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '169.254.0.0/16', '::1/128', 'fec0::/10', 'fe80::/10', 'fc00::/7', 'fd00::/8'];\nconst privateIPMatcher = new BlockList();\n\nfor (const cidr of privateCIDRs) {\n  const [address, prefix] = cidr.split('/');\n  privateIPMatcher.addSubnet(address, parseInt(prefix), net.isIPv6(address) ? 'ipv6' : 'ipv4');\n}\n\nfunction findFirstIp(str) {\n  let firstPrivateIp;\n  const splitted = str.split(',');\n\n  for (let i = 0; i < splitted.length; i++) {\n    const chunk = splitted[i].trim(); // TODO: strip port and interface data ?\n\n    const type = net.isIP(chunk);\n    if (!type) continue;\n\n    if (!privateIPMatcher.check(chunk, type === 6 ? 'ipv6' : 'ipv4')) {\n      // it's public, return it immediately\n      return chunk;\n    } // it's private, only save the first one found\n\n\n    if (!firstPrivateIp) firstPrivateIp = chunk;\n  }\n\n  return firstPrivateIp;\n}\n\nfunction getHeadersToRecord(config) {\n  if (Array.isArray(config.headers)) {\n    try {\n      return config.headers.map(key => key.toLowerCase());\n    } catch (err) {\n      log.error(err);\n    }\n  } else if (config.hasOwnProperty('headers')) {\n    log.error('Expected `headers` to be an array of strings.');\n  }\n\n  return [];\n}\n\nfunction getStatusValidator(config) {\n  if (typeof config.validateStatus === 'function') {\n    return config.validateStatus;\n  } else if (config.hasOwnProperty('validateStatus')) {\n    log.error('Expected `validateStatus` to be a function.');\n  }\n\n  return code => code < 500;\n}\n\nfunction getHooks(config) {\n  const noop = () => {};\n\n  const request = config.hooks && config.hooks.request || noop;\n  return {\n    request\n  };\n}\n\nfunction getMiddlewareSetting(config) {\n  if (config && typeof config.middleware === 'boolean') {\n    return config.middleware;\n  } else if (config && config.hasOwnProperty('middleware')) {\n    log.error('Expected `middleware` to be a boolean.');\n  }\n\n  return true;\n}\n\nmodule.exports = web;","map":{"version":3,"names":["net","require","uniq","analyticsSampler","FORMAT_HTTP_HEADERS","log","tags","types","kinds","urlFilter","BlockList","incomingHttpRequestEnd","WEB","SERVER","RESOURCE_NAME","SERVICE_NAME","SPAN_TYPE","SPAN_KIND","ERROR","HTTP_METHOD","HTTP_URL","HTTP_STATUS_CODE","HTTP_ROUTE","HTTP_REQUEST_HEADERS","HTTP_RESPONSE_HEADERS","HTTP_USERAGENT","HTTP_CLIENT_IP","MANUAL_DROP","HTTP2_HEADER_AUTHORITY","HTTP2_HEADER_SCHEME","HTTP2_HEADER_PATH","ipHeaderList","contexts","WeakMap","ends","web","normalizeConfig","config","server","headers","getHeadersToRecord","validateStatus","getStatusValidator","hooks","getHooks","filter","getFilter","middleware","getMiddlewareSetting","Object","assign","setFramework","req","name","context","patch","span","_name","setConfig","get","url","setTag","_trace","isRecording","service","sample","measured","startSpan","tracer","res","startChildSpan","wrap","instrumented","wrapEnd","instrument","callback","scope","activate","reactivate","fn","enterRoute","path","paths","push","setRoute","exitRoute","pop","wrapMiddleware","active","childOf","bindAndWrapMiddlewareErrors","addTags","activeSpan","bind","apply","arguments","e","addError","finish","error","message","stack","beforeEnd","stream","set","root","length","slice","extract","addStatusError","statusCode","hasExistingError","_tags","Error","finishMiddleware","finished","finishSpan","addRequestTags","addResponseTags","request","addResourceTag","finishAll","hasSubscribers","publish","extractIp","clientIpHeaderDisabled","clientIpHeader","header","findFirstIp","foundHeaders","i","firstIp","socket","remoteAddress","wrapWriteHead","writeHead","statusMessage","getHeaders","method","toLowerCase","isOriginAllowed","addAllowHeaders","getContext","wrapRes","end","defineProperty","configurable","value","allowHeaders","splitHeader","requestHeaders","contextHeaders","indexOf","setHeader","join","origin","allowOrigin","str","split","extractURL","addHeaders","resource","val","forEach","key","reqHeader","resHeader","getHeader","protocol","getProtocol","originalUrl","encrypted","connection","privateCIDRs","privateIPMatcher","cidr","address","prefix","addSubnet","parseInt","isIPv6","firstPrivateIp","splitted","chunk","trim","type","isIP","check","Array","isArray","map","err","hasOwnProperty","code","noop","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/plugins/util/web.js"],"sourcesContent":["'use strict'\n\nconst net = require('net')\nconst uniq = require('lodash.uniq')\nconst analyticsSampler = require('../../analytics_sampler')\nconst FORMAT_HTTP_HEADERS = 'http_headers'\nconst log = require('../../log')\nconst tags = require('../../../../../ext/tags')\nconst types = require('../../../../../ext/types')\nconst kinds = require('../../../../../ext/kinds')\nconst urlFilter = require('./urlfilter')\nconst BlockList = require('./ip_blocklist')\nconst { incomingHttpRequestEnd } = require('../../appsec/gateway/channels')\n\nconst WEB = types.WEB\nconst SERVER = kinds.SERVER\nconst RESOURCE_NAME = tags.RESOURCE_NAME\nconst SERVICE_NAME = tags.SERVICE_NAME\nconst SPAN_TYPE = tags.SPAN_TYPE\nconst SPAN_KIND = tags.SPAN_KIND\nconst ERROR = tags.ERROR\nconst HTTP_METHOD = tags.HTTP_METHOD\nconst HTTP_URL = tags.HTTP_URL\nconst HTTP_STATUS_CODE = tags.HTTP_STATUS_CODE\nconst HTTP_ROUTE = tags.HTTP_ROUTE\nconst HTTP_REQUEST_HEADERS = tags.HTTP_REQUEST_HEADERS\nconst HTTP_RESPONSE_HEADERS = tags.HTTP_RESPONSE_HEADERS\nconst HTTP_USERAGENT = tags.HTTP_USERAGENT\nconst HTTP_CLIENT_IP = tags.HTTP_CLIENT_IP\nconst MANUAL_DROP = tags.MANUAL_DROP\n\nconst HTTP2_HEADER_AUTHORITY = ':authority'\nconst HTTP2_HEADER_SCHEME = ':scheme'\nconst HTTP2_HEADER_PATH = ':path'\n\nconst ipHeaderList = [\n  'x-forwarded-for',\n  'x-real-ip',\n  'client-ip',\n  'x-forwarded',\n  'x-cluster-client-ip',\n  'forwarded-for',\n  'forwarded',\n  'via',\n  'true-client-ip'\n]\n\nconst contexts = new WeakMap()\nconst ends = new WeakMap()\n\nconst web = {\n  // Ensure the configuration has the correct structure and defaults.\n  normalizeConfig (config) {\n    config = config.server || config\n\n    const headers = getHeadersToRecord(config)\n    const validateStatus = getStatusValidator(config)\n    const hooks = getHooks(config)\n    const filter = urlFilter.getFilter(config)\n    const middleware = getMiddlewareSetting(config)\n\n    return Object.assign({}, config, {\n      headers,\n      validateStatus,\n      hooks,\n      filter,\n      middleware\n    })\n  },\n\n  setFramework (req, name, config) {\n    const context = this.patch(req)\n    const span = context.span\n\n    if (!span) return\n\n    span.context()._name = `${name}.request`\n\n    web.setConfig(req, config)\n  },\n\n  setConfig (req, config) {\n    const context = contexts.get(req)\n    const span = context.span\n\n    context.config = config\n\n    if (!config.filter(req.url)) {\n      span.setTag(MANUAL_DROP, true)\n      span.context()._trace.isRecording = false\n    }\n\n    if (config.service) {\n      span.setTag(SERVICE_NAME, config.service)\n    }\n\n    analyticsSampler.sample(span, config.measured, true)\n  },\n\n  startSpan (tracer, config, req, res, name) {\n    const context = this.patch(req)\n\n    let span\n\n    if (context.span) {\n      context.span.context()._name = name\n      span = context.span\n    } else {\n      span = web.startChildSpan(tracer, name, req.headers)\n    }\n\n    context.tracer = tracer\n    context.span = span\n    context.res = res\n\n    this.setConfig(req, config)\n\n    return span\n  },\n  wrap (req) {\n    const context = contexts.get(req)\n    if (!context.instrumented) {\n      this.wrapEnd(context)\n      context.instrumented = true\n    }\n  },\n  // Start a span and activate a scope for a request.\n  instrument (tracer, config, req, res, name, callback) {\n    const span = this.startSpan(tracer, config, req, res, name)\n\n    this.wrap(req)\n\n    return callback && tracer.scope().activate(span, () => callback(span))\n  },\n\n  // Reactivate the request scope in case it was changed by a middleware.\n  reactivate (req, fn) {\n    return reactivate(req, fn)\n  },\n\n  // Add a route segment that will be used for the resource name.\n  enterRoute (req, path) {\n    if (typeof path === 'string') {\n      contexts.get(req).paths.push(path)\n    }\n  },\n\n  setRoute (req, path) {\n    const context = contexts.get(req)\n\n    if (!context) return\n\n    context.paths = [path]\n  },\n\n  // Remove the current route segment.\n  exitRoute (req) {\n    contexts.get(req).paths.pop()\n  },\n\n  // Start a new middleware span and activate a new scope with the span.\n  wrapMiddleware (req, middleware, name, fn) {\n    if (!this.active(req)) return fn()\n\n    const context = contexts.get(req)\n    const tracer = context.tracer\n    const childOf = this.active(req)\n    const config = context.config\n\n    if (config.middleware === false) return this.bindAndWrapMiddlewareErrors(fn, req, tracer, childOf)\n\n    const span = tracer.startSpan(name, { childOf })\n\n    analyticsSampler.sample(span, config.measured)\n\n    span.addTags({\n      [RESOURCE_NAME]: middleware._name || middleware.name || '<anonymous>'\n    })\n\n    context.middleware.push(span)\n\n    return tracer.scope().activate(span, fn)\n  },\n\n  // catch errors and apply to active span\n  bindAndWrapMiddlewareErrors (fn, req, tracer, activeSpan) {\n    try {\n      return tracer.scope().bind(fn, activeSpan).apply(this, arguments)\n    } catch (e) {\n      web.addError(req, e) // TODO: remove when error formatting is moved to Span\n      throw e\n    }\n  },\n\n  // Finish the active middleware span.\n  finish (req, error) {\n    if (!this.active(req)) return\n\n    const context = contexts.get(req)\n    const span = context.middleware.pop()\n\n    if (span) {\n      if (error) {\n        span.addTags({\n          'error.type': error.name,\n          'error.msg': error.message,\n          'error.stack': error.stack\n        })\n      }\n\n      span.finish()\n    }\n  },\n\n  // Register a callback to run before res.end() is called.\n  beforeEnd (req, callback) {\n    contexts.get(req).beforeEnd.push(callback)\n  },\n\n  // Prepare the request for instrumentation.\n  patch (req) {\n    let context = contexts.get(req)\n\n    if (context) return context\n\n    context = req.stream && contexts.get(req.stream)\n\n    if (context) {\n      contexts.set(req, context)\n      return context\n    }\n\n    context = {\n      req,\n      span: null,\n      paths: [],\n      middleware: [],\n      beforeEnd: [],\n      config: {}\n    }\n\n    contexts.set(req, context)\n\n    return context\n  },\n\n  // Return the request root span.\n  root (req) {\n    const context = contexts.get(req)\n    return context ? context.span : null\n  },\n\n  // Return the active span.\n  active (req) {\n    const context = contexts.get(req)\n\n    if (!context) return null\n    if (context.middleware.length === 0) return context.span || null\n\n    return context.middleware.slice(-1)[0]\n  },\n\n  // Extract the parent span from the headers and start a new span as its child\n  startChildSpan (tracer, name, headers) {\n    const childOf = tracer.scope().active() || tracer.extract(FORMAT_HTTP_HEADERS, headers)\n\n    const span = tracer.startSpan(name, { childOf })\n\n    return span\n  },\n\n  // Validate a request's status code and then add error tags if necessary\n  addStatusError (req, statusCode) {\n    const context = contexts.get(req)\n    const span = context.span\n    const error = context.error\n    const hasExistingError = span.context()._tags['error'] || span.context()._tags['error.msg']\n\n    if (!hasExistingError && !context.config.validateStatus(statusCode)) {\n      span.setTag(ERROR, error || true)\n    }\n  },\n\n  // Add an error to the request\n  addError (req, error) {\n    if (error instanceof Error) {\n      const context = contexts.get(req)\n\n      if (context) {\n        context.error = error\n      }\n    }\n  },\n\n  finishMiddleware (context) {\n    if (context.finished) return\n\n    let span\n\n    while ((span = context.middleware.pop())) {\n      span.finish()\n    }\n  },\n\n  finishSpan (context) {\n    const { req, res } = context\n\n    if (context.finished && !req.stream) return\n\n    addRequestTags(context)\n    addResponseTags(context)\n\n    context.config.hooks.request(context.span, req, res)\n    addResourceTag(context)\n\n    context.span.finish()\n    context.finished = true\n  },\n\n  finishAll (context) {\n    const { req, res } = context\n\n    for (const beforeEnd of context.beforeEnd) {\n      beforeEnd()\n    }\n\n    web.finishMiddleware(context)\n\n    if (incomingHttpRequestEnd.hasSubscribers) {\n      incomingHttpRequestEnd.publish({ req, res })\n    }\n\n    web.finishSpan(context)\n  },\n\n  extractIp (context) {\n    const { req, config } = context\n\n    if (config.clientIpHeaderDisabled) return\n\n    const headers = req.headers\n\n    if (config.clientIpHeader) {\n      const header = headers[config.clientIpHeader]\n      if (!header) return\n\n      return findFirstIp(header)\n    }\n\n    const foundHeaders = []\n\n    for (let i = 0; i < ipHeaderList.length; i++) {\n      if (headers[ipHeaderList[i]]) {\n        foundHeaders.push(ipHeaderList[i])\n      }\n    }\n\n    if (foundHeaders.length === 1) {\n      const header = headers[foundHeaders[0]]\n      const firstIp = findFirstIp(header)\n\n      if (firstIp) return firstIp\n    } else if (foundHeaders.length > 1) {\n      log.error(`Cannot find client IP: multiple IP headers detected ${foundHeaders}`)\n      return\n    }\n\n    return req.socket && req.socket.remoteAddress\n  },\n\n  wrapWriteHead (context) {\n    const { req, res } = context\n    const writeHead = res.writeHead\n\n    return function (statusCode, statusMessage, headers) {\n      headers = typeof statusMessage === 'string' ? headers : statusMessage\n      headers = Object.assign(res.getHeaders(), headers)\n\n      if (req.method.toLowerCase() === 'options' && isOriginAllowed(req, headers)) {\n        addAllowHeaders(req, res, headers)\n      }\n\n      return writeHead.apply(this, arguments)\n    }\n  },\n  getContext (req) {\n    return contexts.get(req)\n  },\n  wrapRes (context, req, res, end) {\n    return function () {\n      web.finishAll(context)\n\n      return end.apply(res, arguments)\n    }\n  },\n  wrapEnd (context) {\n    const scope = context.tracer.scope()\n    const req = context.req\n    const res = context.res\n    const end = res.end\n\n    res.writeHead = web.wrapWriteHead(context)\n\n    ends.set(res, this.wrapRes(context, req, res, end))\n\n    Object.defineProperty(res, 'end', {\n      configurable: true,\n      get () {\n        return ends.get(this)\n      },\n      set (value) {\n        ends.set(this, scope.bind(value, context.span))\n      }\n    })\n  }\n}\n\nfunction addAllowHeaders (req, res, headers) {\n  const allowHeaders = splitHeader(headers['access-control-allow-headers'])\n  const requestHeaders = splitHeader(req.headers['access-control-request-headers'])\n  const contextHeaders = [\n    'x-datadog-origin',\n    'x-datadog-parent-id',\n    'x-datadog-sampled', // Deprecated, but still accept it in case it's sent.\n    'x-datadog-sampling-priority',\n    'x-datadog-trace-id',\n    'x-datadog-tags'\n  ]\n\n  for (const header of contextHeaders) {\n    if (~requestHeaders.indexOf(header)) {\n      allowHeaders.push(header)\n    }\n  }\n\n  if (allowHeaders.length > 0) {\n    res.setHeader('access-control-allow-headers', uniq(allowHeaders).join(','))\n  }\n}\n\nfunction isOriginAllowed (req, headers) {\n  const origin = req.headers['origin']\n  const allowOrigin = headers['access-control-allow-origin']\n\n  return origin && (allowOrigin === '*' || allowOrigin === origin)\n}\n\nfunction splitHeader (str) {\n  return typeof str === 'string' ? str.split(/\\s*,\\s*/) : []\n}\n\nfunction reactivate (req, fn) {\n  const context = contexts.get(req)\n\n  return context\n    ? context.tracer.scope().activate(context.span, fn)\n    : fn()\n}\n\nfunction addRequestTags (context) {\n  const { req, span } = context\n  const url = extractURL(req)\n\n  span.addTags({\n    [HTTP_URL]: url.split('?')[0],\n    [HTTP_METHOD]: req.method,\n    [SPAN_KIND]: SERVER,\n    [SPAN_TYPE]: WEB,\n    [HTTP_USERAGENT]: req.headers['user-agent'],\n    [HTTP_CLIENT_IP]: web.extractIp(context)\n  })\n\n  addHeaders(context)\n}\n\nfunction addResponseTags (context) {\n  const { req, res, paths, span } = context\n\n  if (paths.length > 0) {\n    span.setTag(HTTP_ROUTE, paths.join(''))\n  }\n\n  span.addTags({\n    [HTTP_STATUS_CODE]: res.statusCode\n  })\n\n  web.addStatusError(req, res.statusCode)\n}\n\nfunction addResourceTag (context) {\n  const { req, span } = context\n  const tags = span.context()._tags\n\n  if (tags['resource.name']) return\n\n  const resource = [req.method, tags[HTTP_ROUTE]]\n    .filter(val => val)\n    .join(' ')\n\n  span.setTag(RESOURCE_NAME, resource)\n}\n\nfunction addHeaders (context) {\n  const { req, res, config, span } = context\n\n  config.headers.forEach(key => {\n    const reqHeader = req.headers[key]\n    const resHeader = res.getHeader(key)\n\n    if (reqHeader) {\n      span.setTag(`${HTTP_REQUEST_HEADERS}.${key}`, reqHeader)\n    }\n\n    if (resHeader) {\n      span.setTag(`${HTTP_RESPONSE_HEADERS}.${key}`, resHeader)\n    }\n  })\n}\n\nfunction extractURL (req) {\n  const headers = req.headers\n\n  if (req.stream) {\n    return `${headers[HTTP2_HEADER_SCHEME]}://${headers[HTTP2_HEADER_AUTHORITY]}${headers[HTTP2_HEADER_PATH]}`\n  } else {\n    const protocol = getProtocol(req)\n    return `${protocol}://${req.headers['host']}${req.originalUrl || req.url}`\n  }\n}\n\nfunction getProtocol (req) {\n  if (req.socket && req.socket.encrypted) return 'https'\n  if (req.connection && req.connection.encrypted) return 'https'\n\n  return 'http'\n}\n\nconst privateCIDRs = [\n  '127.0.0.0/8',\n  '10.0.0.0/8',\n  '172.16.0.0/12',\n  '192.168.0.0/16',\n  '169.254.0.0/16',\n  '::1/128',\n  'fec0::/10',\n  'fe80::/10',\n  'fc00::/7',\n  'fd00::/8'\n]\n\nconst privateIPMatcher = new BlockList()\n\nfor (const cidr of privateCIDRs) {\n  const [ address, prefix ] = cidr.split('/')\n\n  privateIPMatcher.addSubnet(address, parseInt(prefix), net.isIPv6(address) ? 'ipv6' : 'ipv4')\n}\n\nfunction findFirstIp (str) {\n  let firstPrivateIp\n  const splitted = str.split(',')\n\n  for (let i = 0; i < splitted.length; i++) {\n    const chunk = splitted[i].trim()\n\n    // TODO: strip port and interface data ?\n\n    const type = net.isIP(chunk)\n    if (!type) continue\n\n    if (!privateIPMatcher.check(chunk, type === 6 ? 'ipv6' : 'ipv4')) {\n      // it's public, return it immediately\n      return chunk\n    }\n\n    // it's private, only save the first one found\n    if (!firstPrivateIp) firstPrivateIp = chunk\n  }\n\n  return firstPrivateIp\n}\n\nfunction getHeadersToRecord (config) {\n  if (Array.isArray(config.headers)) {\n    try {\n      return config.headers.map(key => key.toLowerCase())\n    } catch (err) {\n      log.error(err)\n    }\n  } else if (config.hasOwnProperty('headers')) {\n    log.error('Expected `headers` to be an array of strings.')\n  }\n  return []\n}\n\nfunction getStatusValidator (config) {\n  if (typeof config.validateStatus === 'function') {\n    return config.validateStatus\n  } else if (config.hasOwnProperty('validateStatus')) {\n    log.error('Expected `validateStatus` to be a function.')\n  }\n  return code => code < 500\n}\n\nfunction getHooks (config) {\n  const noop = () => {}\n  const request = (config.hooks && config.hooks.request) || noop\n\n  return { request }\n}\n\nfunction getMiddlewareSetting (config) {\n  if (config && typeof config.middleware === 'boolean') {\n    return config.middleware\n  } else if (config && config.hasOwnProperty('middleware')) {\n    log.error('Expected `middleware` to be a boolean.')\n  }\n\n  return true\n}\n\nmodule.exports = web\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}