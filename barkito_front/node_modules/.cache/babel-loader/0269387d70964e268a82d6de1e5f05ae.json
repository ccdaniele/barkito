{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n/**\n * @description The enum values in this map are not exposed from ShareDB, so the keys are hard-coded here.\n * The values were derived from: https://github.com/share/sharedb/blob/master/lib/client/connection.js#L196\n */\n\n\nconst READABLE_ACTION_NAMES = {\n  hs: 'handshake',\n  qf: 'query-fetch',\n  qs: 'query-subscribe',\n  qu: 'query-unsubscribe',\n  bf: 'bulk-fetch',\n  bs: 'bulk-subscribe',\n  bu: 'bulk-unsubscribe',\n  f: 'fetch',\n  s: 'subscribe',\n  u: 'unsubscribe',\n  op: 'op',\n  nf: 'snapshot-fetch',\n  nt: 'snapshot-fetch-by-ts',\n  p: 'presence-broadcast',\n  pr: 'presence-request',\n  ps: 'presence-subscribe',\n  pu: 'presence-unsubscribe'\n};\naddHook({\n  name: 'sharedb',\n  versions: ['>=1'],\n  file: 'lib/agent.js'\n}, Agent => {\n  const startCh = channel('apm:sharedb:request:start');\n  const finishCh = channel('apm:sharedb:request:finish');\n  const errorCh = channel('apm:sharedb:request:error');\n  shimmer.wrap(Agent.prototype, '_handleMessage', origHandleMessageFn => function (request, callback) {\n    const callbackResource = new AsyncResource('bound-anonymous-fn');\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    const action = request.a;\n    const actionName = getReadableActionName(action);\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({\n        actionName,\n        request\n      });\n      callback = callbackResource.bind(callback);\n      arguments[1] = asyncResource.bind(function (error, res) {\n        if (error) {\n          errorCh.publish(error);\n        }\n\n        finishCh.publish({\n          request,\n          res\n        });\n        return callback.apply(this, arguments);\n      });\n\n      try {\n        return origHandleMessageFn.apply(this, arguments);\n      } catch (error) {\n        errorCh.publish(error);\n        throw error;\n      }\n    });\n  });\n  return Agent;\n});\n\nfunction getReadableActionName(action) {\n  const actionName = READABLE_ACTION_NAMES[action];\n\n  if (actionName === undefined) {\n    return action;\n  }\n\n  return actionName;\n}","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","READABLE_ACTION_NAMES","hs","qf","qs","qu","bf","bs","bu","f","s","u","op","nf","nt","p","pr","ps","pu","name","versions","file","Agent","startCh","finishCh","errorCh","wrap","prototype","origHandleMessageFn","request","callback","callbackResource","asyncResource","action","a","actionName","getReadableActionName","runInAsyncScope","publish","bind","arguments","error","res","apply","undefined"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/sharedb.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\n/**\n * @description The enum values in this map are not exposed from ShareDB, so the keys are hard-coded here.\n * The values were derived from: https://github.com/share/sharedb/blob/master/lib/client/connection.js#L196\n */\nconst READABLE_ACTION_NAMES = {\n  hs: 'handshake',\n  qf: 'query-fetch',\n  qs: 'query-subscribe',\n  qu: 'query-unsubscribe',\n  bf: 'bulk-fetch',\n  bs: 'bulk-subscribe',\n  bu: 'bulk-unsubscribe',\n  f: 'fetch',\n  s: 'subscribe',\n  u: 'unsubscribe',\n  op: 'op',\n  nf: 'snapshot-fetch',\n  nt: 'snapshot-fetch-by-ts',\n  p: 'presence-broadcast',\n  pr: 'presence-request',\n  ps: 'presence-subscribe',\n  pu: 'presence-unsubscribe'\n}\n\naddHook({ name: 'sharedb', versions: ['>=1'], file: 'lib/agent.js' }, Agent => {\n  const startCh = channel('apm:sharedb:request:start')\n  const finishCh = channel('apm:sharedb:request:finish')\n  const errorCh = channel('apm:sharedb:request:error')\n\n  shimmer.wrap(Agent.prototype, '_handleMessage', origHandleMessageFn => function (request, callback) {\n    const callbackResource = new AsyncResource('bound-anonymous-fn')\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n    const action = request.a\n    const actionName = getReadableActionName(action)\n\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({ actionName, request })\n\n      callback = callbackResource.bind(callback)\n\n      arguments[1] = asyncResource.bind(function (error, res) {\n        if (error) {\n          errorCh.publish(error)\n        }\n        finishCh.publish({ request, res })\n\n        return callback.apply(this, arguments)\n      })\n\n      try {\n        return origHandleMessageFn.apply(this, arguments)\n      } catch (error) {\n        errorCh.publish(error)\n\n        throw error\n      }\n    })\n  })\n  return Agent\n})\n\nfunction getReadableActionName (action) {\n  const actionName = READABLE_ACTION_NAMES[action]\n  if (actionName === undefined) {\n    return action\n  }\n  return actionName\n}\n"],"mappings":"AAAA;;AAEA,MAAM;EACJA,OADI;EAEJC,OAFI;EAGJC;AAHI,IAIFC,OAAO,CAAC,sBAAD,CAJX;;AAKA,MAAMC,OAAO,GAAGD,OAAO,CAAC,uBAAD,CAAvB;AAEA;AACA;AACA;AACA;;;AACA,MAAME,qBAAqB,GAAG;EAC5BC,EAAE,EAAE,WADwB;EAE5BC,EAAE,EAAE,aAFwB;EAG5BC,EAAE,EAAE,iBAHwB;EAI5BC,EAAE,EAAE,mBAJwB;EAK5BC,EAAE,EAAE,YALwB;EAM5BC,EAAE,EAAE,gBANwB;EAO5BC,EAAE,EAAE,kBAPwB;EAQ5BC,CAAC,EAAE,OARyB;EAS5BC,CAAC,EAAE,WATyB;EAU5BC,CAAC,EAAE,aAVyB;EAW5BC,EAAE,EAAE,IAXwB;EAY5BC,EAAE,EAAE,gBAZwB;EAa5BC,EAAE,EAAE,sBAbwB;EAc5BC,CAAC,EAAE,oBAdyB;EAe5BC,EAAE,EAAE,kBAfwB;EAgB5BC,EAAE,EAAE,oBAhBwB;EAiB5BC,EAAE,EAAE;AAjBwB,CAA9B;AAoBArB,OAAO,CAAC;EAAEsB,IAAI,EAAE,SAAR;EAAmBC,QAAQ,EAAE,CAAC,KAAD,CAA7B;EAAsCC,IAAI,EAAE;AAA5C,CAAD,EAA+DC,KAAK,IAAI;EAC7E,MAAMC,OAAO,GAAG3B,OAAO,CAAC,2BAAD,CAAvB;EACA,MAAM4B,QAAQ,GAAG5B,OAAO,CAAC,4BAAD,CAAxB;EACA,MAAM6B,OAAO,GAAG7B,OAAO,CAAC,2BAAD,CAAvB;EAEAI,OAAO,CAAC0B,IAAR,CAAaJ,KAAK,CAACK,SAAnB,EAA8B,gBAA9B,EAAgDC,mBAAmB,IAAI,UAAUC,OAAV,EAAmBC,QAAnB,EAA6B;IAClG,MAAMC,gBAAgB,GAAG,IAAIjC,aAAJ,CAAkB,oBAAlB,CAAzB;IACA,MAAMkC,aAAa,GAAG,IAAIlC,aAAJ,CAAkB,oBAAlB,CAAtB;IAEA,MAAMmC,MAAM,GAAGJ,OAAO,CAACK,CAAvB;IACA,MAAMC,UAAU,GAAGC,qBAAqB,CAACH,MAAD,CAAxC;IAEA,OAAOD,aAAa,CAACK,eAAd,CAA8B,MAAM;MACzCd,OAAO,CAACe,OAAR,CAAgB;QAAEH,UAAF;QAAcN;MAAd,CAAhB;MAEAC,QAAQ,GAAGC,gBAAgB,CAACQ,IAAjB,CAAsBT,QAAtB,CAAX;MAEAU,SAAS,CAAC,CAAD,CAAT,GAAeR,aAAa,CAACO,IAAd,CAAmB,UAAUE,KAAV,EAAiBC,GAAjB,EAAsB;QACtD,IAAID,KAAJ,EAAW;UACThB,OAAO,CAACa,OAAR,CAAgBG,KAAhB;QACD;;QACDjB,QAAQ,CAACc,OAAT,CAAiB;UAAET,OAAF;UAAWa;QAAX,CAAjB;QAEA,OAAOZ,QAAQ,CAACa,KAAT,CAAe,IAAf,EAAqBH,SAArB,CAAP;MACD,CAPc,CAAf;;MASA,IAAI;QACF,OAAOZ,mBAAmB,CAACe,KAApB,CAA0B,IAA1B,EAAgCH,SAAhC,CAAP;MACD,CAFD,CAEE,OAAOC,KAAP,EAAc;QACdhB,OAAO,CAACa,OAAR,CAAgBG,KAAhB;QAEA,MAAMA,KAAN;MACD;IACF,CArBM,CAAP;EAsBD,CA7BD;EA8BA,OAAOnB,KAAP;AACD,CApCM,CAAP;;AAsCA,SAASc,qBAAT,CAAgCH,MAAhC,EAAwC;EACtC,MAAME,UAAU,GAAGlC,qBAAqB,CAACgC,MAAD,CAAxC;;EACA,IAAIE,UAAU,KAAKS,SAAnB,EAA8B;IAC5B,OAAOX,MAAP;EACD;;EACD,OAAOE,UAAP;AACD"},"metadata":{},"sourceType":"script"}