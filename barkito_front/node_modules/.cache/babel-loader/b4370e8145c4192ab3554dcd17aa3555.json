{"ast":null,"code":"'use strict';\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin');\n\nconst {\n  storage\n} = require('../../datadog-core');\n\nclass SharedbPlugin extends Plugin {\n  static get name() {\n    return 'sharedb';\n  }\n\n  constructor() {\n    super(...arguments);\n    this.addSub(`apm:sharedb:request:start`, _ref => {\n      let {\n        actionName,\n        request\n      } = _ref;\n      const store = storage.getStore();\n      const childOf = store ? store.span : store;\n      const span = this.tracer.startSpan('sharedb.request', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || this.tracer._service,\n          'span.kind': 'server',\n          'sharedb.action': actionName,\n          'resource.name': getReadableResourceName(actionName, request.c, request.q)\n        }\n      });\n\n      if (this.config.hooks && this.config.hooks.receive) {\n        this.config.hooks.receive(span, request);\n      }\n\n      this.enter(span, store);\n    });\n    this.addSub(`apm:sharedb:request:error`, err => {\n      const span = storage.getStore().span;\n      span.setTag('error', err);\n    });\n    this.addSub(`apm:sharedb:request:finish`, _ref2 => {\n      let {\n        request,\n        res\n      } = _ref2;\n      const span = storage.getStore().span;\n\n      if (this.config.hooks && this.config.hooks.reply) {\n        this.config.hooks.reply(span, request, res);\n      }\n\n      span.finish();\n    });\n  }\n\n}\n\nfunction getReadableResourceName(readableActionName, collection, query) {\n  if (collection) {\n    readableActionName += ' ' + collection;\n  }\n\n  if (query) {\n    readableActionName += ' ' + JSON.stringify(sanitize(query));\n  }\n\n  return readableActionName;\n}\n\nfunction sanitize(input) {\n  const output = {};\n  if (!isObject(input) || Buffer.isBuffer(input)) return '?';\n\n  for (const key in input) {\n    if (typeof input[key] === 'function') continue;\n    output[key] = sanitize(input[key]);\n  }\n\n  return output;\n}\n\nfunction isObject(val) {\n  return typeof val === 'object' && val !== null && !(val instanceof Array);\n}\n\nmodule.exports = SharedbPlugin;","map":{"version":3,"names":["Plugin","require","storage","SharedbPlugin","name","constructor","addSub","actionName","request","store","getStore","childOf","span","tracer","startSpan","tags","config","service","_service","getReadableResourceName","c","q","hooks","receive","enter","err","setTag","res","reply","finish","readableActionName","collection","query","JSON","stringify","sanitize","input","output","isObject","Buffer","isBuffer","key","val","Array","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-sharedb/src/index.js"],"sourcesContent":["'use strict'\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin')\nconst { storage } = require('../../datadog-core')\n\nclass SharedbPlugin extends Plugin {\n  static get name () {\n    return 'sharedb'\n  }\n\n  constructor (...args) {\n    super(...args)\n\n    this.addSub(`apm:sharedb:request:start`, ({ actionName, request }) => {\n      const store = storage.getStore()\n      const childOf = store ? store.span : store\n      const span = this.tracer.startSpan('sharedb.request', {\n        childOf,\n        tags: {\n          'service.name': this.config.service || this.tracer._service,\n          'span.kind': 'server',\n          'sharedb.action': actionName,\n          'resource.name': getReadableResourceName(actionName, request.c, request.q)\n        }\n      })\n\n      if (this.config.hooks && this.config.hooks.receive) {\n        this.config.hooks.receive(span, request)\n      }\n\n      this.enter(span, store)\n    })\n\n    this.addSub(`apm:sharedb:request:error`, err => {\n      const span = storage.getStore().span\n      span.setTag('error', err)\n    })\n\n    this.addSub(`apm:sharedb:request:finish`, ({ request, res }) => {\n      const span = storage.getStore().span\n      if (this.config.hooks && this.config.hooks.reply) {\n        this.config.hooks.reply(span, request, res)\n      }\n      span.finish()\n    })\n  }\n}\n\nfunction getReadableResourceName (readableActionName, collection, query) {\n  if (collection) {\n    readableActionName += ' ' + collection\n  }\n  if (query) {\n    readableActionName += ' ' + JSON.stringify(sanitize(query))\n  }\n  return readableActionName\n}\n\nfunction sanitize (input) {\n  const output = {}\n\n  if (!isObject(input) || Buffer.isBuffer(input)) return '?'\n\n  for (const key in input) {\n    if (typeof input[key] === 'function') continue\n\n    output[key] = sanitize(input[key])\n  }\n\n  return output\n}\n\nfunction isObject (val) {\n  return typeof val === 'object' && val !== null && !(val instanceof Array)\n}\n\nmodule.exports = SharedbPlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}