{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('../helpers/instrument');\n\nconst shimmer = require('../../../datadog-shimmer');\n\nconst startChannel = channel('apm:moleculer:call:start');\nconst finishChannel = channel('apm:moleculer:call:finish');\nconst errorChannel = channel('apm:moleculer:call:error');\n\nfunction wrapCall(call) {\n  return function (actionName, params, opts) {\n    const callResource = new AsyncResource('bound-anonymous-fn');\n    opts = arguments[2] = opts || {};\n    opts.meta = opts.meta || {};\n    arguments.length = Math.max(3, arguments.length);\n    return callResource.runInAsyncScope(() => {\n      startChannel.publish({\n        actionName,\n        params,\n        opts\n      });\n      const promise = call.apply(this, arguments);\n      const broker = this;\n      const ctx = promise.ctx;\n      return promise.then(result => {\n        finishChannel.publish({\n          broker,\n          ctx\n        });\n        return result;\n      }, error => {\n        errorChannel.publish(error);\n        finishChannel.publish({\n          broker,\n          ctx\n        });\n        throw error;\n      });\n    });\n  };\n}\n\naddHook({\n  name: 'moleculer',\n  versions: ['>=0.14']\n}, moleculer => {\n  shimmer.wrap(moleculer.ServiceBroker.prototype, 'call', wrapCall);\n  return moleculer;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startChannel","finishChannel","errorChannel","wrapCall","call","actionName","params","opts","callResource","arguments","meta","length","Math","max","runInAsyncScope","publish","promise","apply","broker","ctx","then","result","error","name","versions","moleculer","wrap","ServiceBroker","prototype"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/moleculer/client.js"],"sourcesContent":["'use strict'\n\nconst { channel, addHook, AsyncResource } = require('../helpers/instrument')\nconst shimmer = require('../../../datadog-shimmer')\n\nconst startChannel = channel('apm:moleculer:call:start')\nconst finishChannel = channel('apm:moleculer:call:finish')\nconst errorChannel = channel('apm:moleculer:call:error')\n\nfunction wrapCall (call) {\n  return function (actionName, params, opts) {\n    const callResource = new AsyncResource('bound-anonymous-fn')\n\n    opts = arguments[2] = opts || {}\n    opts.meta = opts.meta || {}\n\n    arguments.length = Math.max(3, arguments.length)\n\n    return callResource.runInAsyncScope(() => {\n      startChannel.publish({ actionName, params, opts })\n\n      const promise = call.apply(this, arguments)\n      const broker = this\n      const ctx = promise.ctx\n\n      return promise\n        .then(\n          result => {\n            finishChannel.publish({ broker, ctx })\n            return result\n          },\n          error => {\n            errorChannel.publish(error)\n            finishChannel.publish({ broker, ctx })\n            throw error\n          }\n        )\n    })\n  }\n}\n\naddHook({ name: 'moleculer', versions: ['>=0.14'] }, moleculer => {\n  shimmer.wrap(moleculer.ServiceBroker.prototype, 'call', wrapCall)\n\n  return moleculer\n})\n"],"mappings":"AAAA;;AAEA,MAAM;EAAEA,OAAF;EAAWC,OAAX;EAAoBC;AAApB,IAAsCC,OAAO,CAAC,uBAAD,CAAnD;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,0BAAD,CAAvB;;AAEA,MAAME,YAAY,GAAGL,OAAO,CAAC,0BAAD,CAA5B;AACA,MAAMM,aAAa,GAAGN,OAAO,CAAC,2BAAD,CAA7B;AACA,MAAMO,YAAY,GAAGP,OAAO,CAAC,0BAAD,CAA5B;;AAEA,SAASQ,QAAT,CAAmBC,IAAnB,EAAyB;EACvB,OAAO,UAAUC,UAAV,EAAsBC,MAAtB,EAA8BC,IAA9B,EAAoC;IACzC,MAAMC,YAAY,GAAG,IAAIX,aAAJ,CAAkB,oBAAlB,CAArB;IAEAU,IAAI,GAAGE,SAAS,CAAC,CAAD,CAAT,GAAeF,IAAI,IAAI,EAA9B;IACAA,IAAI,CAACG,IAAL,GAAYH,IAAI,CAACG,IAAL,IAAa,EAAzB;IAEAD,SAAS,CAACE,MAAV,GAAmBC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYJ,SAAS,CAACE,MAAtB,CAAnB;IAEA,OAAOH,YAAY,CAACM,eAAb,CAA6B,MAAM;MACxCd,YAAY,CAACe,OAAb,CAAqB;QAAEV,UAAF;QAAcC,MAAd;QAAsBC;MAAtB,CAArB;MAEA,MAAMS,OAAO,GAAGZ,IAAI,CAACa,KAAL,CAAW,IAAX,EAAiBR,SAAjB,CAAhB;MACA,MAAMS,MAAM,GAAG,IAAf;MACA,MAAMC,GAAG,GAAGH,OAAO,CAACG,GAApB;MAEA,OAAOH,OAAO,CACXI,IADI,CAEHC,MAAM,IAAI;QACRpB,aAAa,CAACc,OAAd,CAAsB;UAAEG,MAAF;UAAUC;QAAV,CAAtB;QACA,OAAOE,MAAP;MACD,CALE,EAMHC,KAAK,IAAI;QACPpB,YAAY,CAACa,OAAb,CAAqBO,KAArB;QACArB,aAAa,CAACc,OAAd,CAAsB;UAAEG,MAAF;UAAUC;QAAV,CAAtB;QACA,MAAMG,KAAN;MACD,CAVE,CAAP;IAYD,CAnBM,CAAP;EAoBD,CA5BD;AA6BD;;AAED1B,OAAO,CAAC;EAAE2B,IAAI,EAAE,WAAR;EAAqBC,QAAQ,EAAE,CAAC,QAAD;AAA/B,CAAD,EAA8CC,SAAS,IAAI;EAChE1B,OAAO,CAAC2B,IAAR,CAAaD,SAAS,CAACE,aAAV,CAAwBC,SAArC,EAAgD,MAAhD,EAAwDzB,QAAxD;EAEA,OAAOsB,SAAP;AACD,CAJM,CAAP"},"metadata":{},"sourceType":"script"}