{"ast":null,"code":"'use strict';\n\nconst {\n  addHook,\n  channel\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst logChannel = channel('apm:paperplane:log');\nconst handleChannel = channel('apm:paperplane:request:handle');\nconst routeChannel = channel('apm:paperplane:request:route');\nconst nodeMajor = Number(process.versions.node.split('.')[0]);\nconst name = 'paperplane';\nconst versions = nodeMajor <= 12 ? ['>=2.3.2'] : nodeMajor <= 14 ? ['>=3.1.1'] : [];\n\nconst wrapRoute = handler => req => {\n  const {\n    original,\n    route\n  } = req;\n\n  if (routeChannel.hasSubscribers) {\n    routeChannel.publish({\n      req: original,\n      route\n    });\n  }\n\n  return handler(req);\n};\n\nconst wrapLogger = logger => record => {\n  const event = {\n    message: record\n  };\n  logChannel.publish(event);\n  return logger(event.message);\n};\n\nconst wrapMount = mount => opts => {\n  const handler = mount(opts);\n  return function (req, res) {\n    handleChannel.publish(req);\n    return handler.apply(this, arguments);\n  };\n};\n\nconst wrapRoutes = routes => handlers => {\n  const traced = {};\n\n  for (const route in handlers) {\n    traced[route] = wrapRoute(handlers[route]);\n  }\n\n  return routes(traced);\n};\n\naddHook({\n  name,\n  versions,\n  file: 'lib/logger.js'\n}, exports => {\n  shimmer.wrap(exports, 'logger', wrapLogger);\n  return exports;\n});\naddHook({\n  name,\n  versions,\n  file: 'lib/mount.js'\n}, exports => {\n  shimmer.wrap(exports, 'mount', wrapMount);\n  return exports;\n});\naddHook({\n  name,\n  versions,\n  file: 'lib/routes.js'\n}, exports => {\n  shimmer.wrap(exports, 'routes', wrapRoutes);\n  return exports;\n});\n\nif (nodeMajor <= 12) {\n  addHook({\n    name,\n    versions: ['2.3.0 - 2.3.1']\n  }, paperplane => {\n    shimmer.wrap(paperplane, 'mount', wrapMount);\n    shimmer.wrap(paperplane, 'routes', wrapRoutes);\n    return paperplane;\n  });\n}","map":{"version":3,"names":["addHook","channel","require","shimmer","logChannel","handleChannel","routeChannel","nodeMajor","Number","process","versions","node","split","name","wrapRoute","handler","req","original","route","hasSubscribers","publish","wrapLogger","logger","record","event","message","wrapMount","mount","opts","res","apply","arguments","wrapRoutes","routes","handlers","traced","file","exports","wrap","paperplane"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/paperplane.js"],"sourcesContent":["'use strict'\n\nconst { addHook, channel } = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst logChannel = channel('apm:paperplane:log')\nconst handleChannel = channel('apm:paperplane:request:handle')\nconst routeChannel = channel('apm:paperplane:request:route')\n\nconst nodeMajor = Number(process.versions.node.split('.')[0])\nconst name = 'paperplane'\nconst versions = nodeMajor <= 12 ? ['>=2.3.2'] : nodeMajor <= 14 ? ['>=3.1.1'] : []\n\nconst wrapRoute = handler => req => {\n  const { original, route } = req\n\n  if (routeChannel.hasSubscribers) {\n    routeChannel.publish({ req: original, route })\n  }\n\n  return handler(req)\n}\n\nconst wrapLogger = logger => record => {\n  const event = { message: record }\n\n  logChannel.publish(event)\n\n  return logger(event.message)\n}\n\nconst wrapMount = mount => opts => {\n  const handler = mount(opts)\n\n  return function (req, res) {\n    handleChannel.publish(req)\n\n    return handler.apply(this, arguments)\n  }\n}\n\nconst wrapRoutes = routes => handlers => {\n  const traced = {}\n\n  for (const route in handlers) {\n    traced[route] = wrapRoute(handlers[route])\n  }\n\n  return routes(traced)\n}\n\naddHook({ name, versions, file: 'lib/logger.js' }, exports => {\n  shimmer.wrap(exports, 'logger', wrapLogger)\n\n  return exports\n})\n\naddHook({ name, versions, file: 'lib/mount.js' }, exports => {\n  shimmer.wrap(exports, 'mount', wrapMount)\n\n  return exports\n})\n\naddHook({ name, versions, file: 'lib/routes.js' }, exports => {\n  shimmer.wrap(exports, 'routes', wrapRoutes)\n\n  return exports\n})\n\nif (nodeMajor <= 12) {\n  addHook({ name, versions: ['2.3.0 - 2.3.1'] }, paperplane => {\n    shimmer.wrap(paperplane, 'mount', wrapMount)\n    shimmer.wrap(paperplane, 'routes', wrapRoutes)\n\n    return paperplane\n  })\n}\n"],"mappings":"AAAA;;AAEA,MAAM;EAAEA,OAAF;EAAWC;AAAX,IAAuBC,OAAO,CAAC,sBAAD,CAApC;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,uBAAD,CAAvB;;AAEA,MAAME,UAAU,GAAGH,OAAO,CAAC,oBAAD,CAA1B;AACA,MAAMI,aAAa,GAAGJ,OAAO,CAAC,+BAAD,CAA7B;AACA,MAAMK,YAAY,GAAGL,OAAO,CAAC,8BAAD,CAA5B;AAEA,MAAMM,SAAS,GAAGC,MAAM,CAACC,OAAO,CAACC,QAAR,CAAiBC,IAAjB,CAAsBC,KAAtB,CAA4B,GAA5B,EAAiC,CAAjC,CAAD,CAAxB;AACA,MAAMC,IAAI,GAAG,YAAb;AACA,MAAMH,QAAQ,GAAGH,SAAS,IAAI,EAAb,GAAkB,CAAC,SAAD,CAAlB,GAAgCA,SAAS,IAAI,EAAb,GAAkB,CAAC,SAAD,CAAlB,GAAgC,EAAjF;;AAEA,MAAMO,SAAS,GAAGC,OAAO,IAAIC,GAAG,IAAI;EAClC,MAAM;IAAEC,QAAF;IAAYC;EAAZ,IAAsBF,GAA5B;;EAEA,IAAIV,YAAY,CAACa,cAAjB,EAAiC;IAC/Bb,YAAY,CAACc,OAAb,CAAqB;MAAEJ,GAAG,EAAEC,QAAP;MAAiBC;IAAjB,CAArB;EACD;;EAED,OAAOH,OAAO,CAACC,GAAD,CAAd;AACD,CARD;;AAUA,MAAMK,UAAU,GAAGC,MAAM,IAAIC,MAAM,IAAI;EACrC,MAAMC,KAAK,GAAG;IAAEC,OAAO,EAAEF;EAAX,CAAd;EAEAnB,UAAU,CAACgB,OAAX,CAAmBI,KAAnB;EAEA,OAAOF,MAAM,CAACE,KAAK,CAACC,OAAP,CAAb;AACD,CAND;;AAQA,MAAMC,SAAS,GAAGC,KAAK,IAAIC,IAAI,IAAI;EACjC,MAAMb,OAAO,GAAGY,KAAK,CAACC,IAAD,CAArB;EAEA,OAAO,UAAUZ,GAAV,EAAea,GAAf,EAAoB;IACzBxB,aAAa,CAACe,OAAd,CAAsBJ,GAAtB;IAEA,OAAOD,OAAO,CAACe,KAAR,CAAc,IAAd,EAAoBC,SAApB,CAAP;EACD,CAJD;AAKD,CARD;;AAUA,MAAMC,UAAU,GAAGC,MAAM,IAAIC,QAAQ,IAAI;EACvC,MAAMC,MAAM,GAAG,EAAf;;EAEA,KAAK,MAAMjB,KAAX,IAAoBgB,QAApB,EAA8B;IAC5BC,MAAM,CAACjB,KAAD,CAAN,GAAgBJ,SAAS,CAACoB,QAAQ,CAAChB,KAAD,CAAT,CAAzB;EACD;;EAED,OAAOe,MAAM,CAACE,MAAD,CAAb;AACD,CARD;;AAUAnC,OAAO,CAAC;EAAEa,IAAF;EAAQH,QAAR;EAAkB0B,IAAI,EAAE;AAAxB,CAAD,EAA4CC,OAAO,IAAI;EAC5DlC,OAAO,CAACmC,IAAR,CAAaD,OAAb,EAAsB,QAAtB,EAAgChB,UAAhC;EAEA,OAAOgB,OAAP;AACD,CAJM,CAAP;AAMArC,OAAO,CAAC;EAAEa,IAAF;EAAQH,QAAR;EAAkB0B,IAAI,EAAE;AAAxB,CAAD,EAA2CC,OAAO,IAAI;EAC3DlC,OAAO,CAACmC,IAAR,CAAaD,OAAb,EAAsB,OAAtB,EAA+BX,SAA/B;EAEA,OAAOW,OAAP;AACD,CAJM,CAAP;AAMArC,OAAO,CAAC;EAAEa,IAAF;EAAQH,QAAR;EAAkB0B,IAAI,EAAE;AAAxB,CAAD,EAA4CC,OAAO,IAAI;EAC5DlC,OAAO,CAACmC,IAAR,CAAaD,OAAb,EAAsB,QAAtB,EAAgCL,UAAhC;EAEA,OAAOK,OAAP;AACD,CAJM,CAAP;;AAMA,IAAI9B,SAAS,IAAI,EAAjB,EAAqB;EACnBP,OAAO,CAAC;IAAEa,IAAF;IAAQH,QAAQ,EAAE,CAAC,eAAD;EAAlB,CAAD,EAAwC6B,UAAU,IAAI;IAC3DpC,OAAO,CAACmC,IAAR,CAAaC,UAAb,EAAyB,OAAzB,EAAkCb,SAAlC;IACAvB,OAAO,CAACmC,IAAR,CAAaC,UAAb,EAAyB,QAAzB,EAAmCP,UAAnC;IAEA,OAAOO,UAAP;EACD,CALM,CAAP;AAMD"},"metadata":{},"sourceType":"script"}