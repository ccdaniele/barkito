{"ast":null,"code":"'use strict';\n\nconst {\n  addHook,\n  channel,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst runStartCh = channel('ci:cucumber:run:start');\nconst runFinishCh = channel('ci:cucumber:run:finish');\nconst runStepStartCh = channel('ci:cucumber:run-step:start');\nconst errorCh = channel('ci:cucumber:error');\nconst sessionFinishCh = channel('ci:cucumber:session:finish'); // TODO: remove in a later major version\n\nconst patched = new WeakSet();\n\nfunction getStatusFromResult(result) {\n  if (result.status === 1) {\n    return {\n      status: 'pass'\n    };\n  }\n\n  if (result.status === 2) {\n    return {\n      status: 'skip'\n    };\n  }\n\n  if (result.status === 4) {\n    return {\n      status: 'skip',\n      skipReason: 'not implemented'\n    };\n  }\n\n  return {\n    status: 'fail',\n    errorMessage: result.message\n  };\n}\n\nfunction getStatusFromResultLatest(result) {\n  if (result.status === 'PASSED') {\n    return {\n      status: 'pass'\n    };\n  }\n\n  if (result.status === 'SKIPPED' || result.status === 'PENDING') {\n    return {\n      status: 'skip'\n    };\n  }\n\n  if (result.status === 'UNDEFINED') {\n    return {\n      status: 'skip',\n      skipReason: 'not implemented'\n    };\n  }\n\n  return {\n    status: 'fail',\n    errorMessage: result.message\n  };\n}\n\nfunction wrapRun(pl, isLatestVersion) {\n  if (patched.has(pl)) return;\n  patched.add(pl);\n  shimmer.wrap(pl.prototype, 'run', run => function () {\n    if (!runStartCh.hasSubscribers) {\n      return run.apply(this, arguments);\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      runStartCh.publish({\n        pickleName: this.pickle.name,\n        pickleUri: this.pickle.uri\n      });\n\n      try {\n        const promise = run.apply(this, arguments);\n        promise.finally(() => {\n          const result = this.getWorstStepResult();\n          const {\n            status,\n            skipReason,\n            errorMessage\n          } = isLatestVersion ? getStatusFromResultLatest(result) : getStatusFromResult(result);\n          runFinishCh.publish({\n            status,\n            skipReason,\n            errorMessage\n          });\n        });\n        return promise;\n      } catch (err) {\n        errorCh.publish(err);\n        throw err;\n      }\n    });\n  });\n  shimmer.wrap(pl.prototype, 'runStep', runStep => function () {\n    if (!runStepStartCh.hasSubscribers) {\n      return runStep.apply(this, arguments);\n    }\n\n    const testStep = arguments[0];\n    let resource;\n\n    if (isLatestVersion) {\n      resource = testStep.text;\n    } else {\n      resource = testStep.isHook ? 'hook' : testStep.pickleStep.text;\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      runStepStartCh.publish({\n        resource\n      });\n\n      try {\n        const promise = runStep.apply(this, arguments);\n        promise.then(result => {\n          const {\n            status,\n            skipReason,\n            errorMessage\n          } = isLatestVersion ? getStatusFromResultLatest(result) : getStatusFromResult(result);\n          runFinishCh.publish({\n            isStep: true,\n            status,\n            skipReason,\n            errorMessage\n          });\n        });\n        return promise;\n      } catch (err) {\n        errorCh.publish(err);\n        throw err;\n      }\n    });\n  });\n}\n\nfunction pickleHook(PickleRunner) {\n  const pl = PickleRunner.default;\n  wrapRun(pl, false);\n  return PickleRunner;\n}\n\nfunction testCaseHook(TestCaseRunner) {\n  const pl = TestCaseRunner.default;\n  wrapRun(pl, true);\n  return TestCaseRunner;\n}\n\naddHook({\n  name: '@cucumber/cucumber',\n  versions: ['7.0.0 - 7.2.1'],\n  file: 'lib/runtime/pickle_runner.js'\n}, pickleHook);\naddHook({\n  name: '@cucumber/cucumber',\n  versions: ['>=7.3.0'],\n  file: 'lib/runtime/test_case_runner.js'\n}, testCaseHook);\naddHook({\n  name: '@cucumber/cucumber',\n  versions: ['>=7.0.0'],\n  file: 'lib/runtime/index.js'\n}, Runtime => {\n  shimmer.wrap(Runtime.default.prototype, 'start', start => async function () {\n    const result = await start.apply(this, arguments);\n    sessionFinishCh.publish(undefined);\n    return result;\n  });\n  return Runtime;\n});\nmodule.exports = {\n  pickleHook,\n  testCaseHook\n};","map":{"version":3,"names":["addHook","channel","AsyncResource","require","shimmer","runStartCh","runFinishCh","runStepStartCh","errorCh","sessionFinishCh","patched","WeakSet","getStatusFromResult","result","status","skipReason","errorMessage","message","getStatusFromResultLatest","wrapRun","pl","isLatestVersion","has","add","wrap","prototype","run","hasSubscribers","apply","arguments","asyncResource","runInAsyncScope","publish","pickleName","pickle","name","pickleUri","uri","promise","finally","getWorstStepResult","err","runStep","testStep","resource","text","isHook","pickleStep","then","isStep","pickleHook","PickleRunner","default","testCaseHook","TestCaseRunner","versions","file","Runtime","start","undefined","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/cucumber.js"],"sourcesContent":["'use strict'\n\nconst { addHook, channel, AsyncResource } = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst runStartCh = channel('ci:cucumber:run:start')\nconst runFinishCh = channel('ci:cucumber:run:finish')\nconst runStepStartCh = channel('ci:cucumber:run-step:start')\nconst errorCh = channel('ci:cucumber:error')\nconst sessionFinishCh = channel('ci:cucumber:session:finish')\n\n// TODO: remove in a later major version\nconst patched = new WeakSet()\n\nfunction getStatusFromResult (result) {\n  if (result.status === 1) {\n    return { status: 'pass' }\n  }\n  if (result.status === 2) {\n    return { status: 'skip' }\n  }\n  if (result.status === 4) {\n    return { status: 'skip', skipReason: 'not implemented' }\n  }\n  return { status: 'fail', errorMessage: result.message }\n}\n\nfunction getStatusFromResultLatest (result) {\n  if (result.status === 'PASSED') {\n    return { status: 'pass' }\n  }\n  if (result.status === 'SKIPPED' || result.status === 'PENDING') {\n    return { status: 'skip' }\n  }\n  if (result.status === 'UNDEFINED') {\n    return { status: 'skip', skipReason: 'not implemented' }\n  }\n  return { status: 'fail', errorMessage: result.message }\n}\n\nfunction wrapRun (pl, isLatestVersion) {\n  if (patched.has(pl)) return\n\n  patched.add(pl)\n\n  shimmer.wrap(pl.prototype, 'run', run => function () {\n    if (!runStartCh.hasSubscribers) {\n      return run.apply(this, arguments)\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    return asyncResource.runInAsyncScope(() => {\n      runStartCh.publish({ pickleName: this.pickle.name, pickleUri: this.pickle.uri })\n      try {\n        const promise = run.apply(this, arguments)\n        promise.finally(() => {\n          const result = this.getWorstStepResult()\n          const { status, skipReason, errorMessage } = isLatestVersion\n            ? getStatusFromResultLatest(result) : getStatusFromResult(result)\n\n          runFinishCh.publish({ status, skipReason, errorMessage })\n        })\n        return promise\n      } catch (err) {\n        errorCh.publish(err)\n        throw err\n      }\n    })\n  })\n  shimmer.wrap(pl.prototype, 'runStep', runStep => function () {\n    if (!runStepStartCh.hasSubscribers) {\n      return runStep.apply(this, arguments)\n    }\n    const testStep = arguments[0]\n    let resource\n\n    if (isLatestVersion) {\n      resource = testStep.text\n    } else {\n      resource = testStep.isHook ? 'hook' : testStep.pickleStep.text\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    return asyncResource.runInAsyncScope(() => {\n      runStepStartCh.publish({ resource })\n      try {\n        const promise = runStep.apply(this, arguments)\n\n        promise.then((result) => {\n          const { status, skipReason, errorMessage } = isLatestVersion\n            ? getStatusFromResultLatest(result) : getStatusFromResult(result)\n\n          runFinishCh.publish({ isStep: true, status, skipReason, errorMessage })\n        })\n        return promise\n      } catch (err) {\n        errorCh.publish(err)\n        throw err\n      }\n    })\n  })\n}\n\nfunction pickleHook (PickleRunner) {\n  const pl = PickleRunner.default\n\n  wrapRun(pl, false)\n\n  return PickleRunner\n}\n\nfunction testCaseHook (TestCaseRunner) {\n  const pl = TestCaseRunner.default\n\n  wrapRun(pl, true)\n\n  return TestCaseRunner\n}\n\naddHook({\n  name: '@cucumber/cucumber',\n  versions: ['7.0.0 - 7.2.1'],\n  file: 'lib/runtime/pickle_runner.js'\n}, pickleHook)\n\naddHook({\n  name: '@cucumber/cucumber',\n  versions: ['>=7.3.0'],\n  file: 'lib/runtime/test_case_runner.js'\n}, testCaseHook)\n\naddHook({\n  name: '@cucumber/cucumber',\n  versions: ['>=7.0.0'],\n  file: 'lib/runtime/index.js'\n}, (Runtime) => {\n  shimmer.wrap(Runtime.default.prototype, 'start', start => async function () {\n    const result = await start.apply(this, arguments)\n    sessionFinishCh.publish(undefined)\n    return result\n  })\n\n  return Runtime\n})\n\nmodule.exports = { pickleHook, testCaseHook }\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}