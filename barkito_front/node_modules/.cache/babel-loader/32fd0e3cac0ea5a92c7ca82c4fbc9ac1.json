{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst rrtypes = {\n  resolveAny: 'ANY',\n  resolve4: 'A',\n  resolve6: 'AAAA',\n  resolveCname: 'CNAME',\n  resolveMx: 'MX',\n  resolveNs: 'NS',\n  resolveTxt: 'TXT',\n  resolveSrv: 'SRV',\n  resolvePtr: 'PTR',\n  resolveNaptr: 'NAPTR',\n  resolveSoa: 'SOA'\n};\nconst rrtypeMap = new WeakMap();\naddHook({\n  name: 'dns'\n}, dns => {\n  dns.lookup = wrap('apm:dns:lookup', dns.lookup, 2);\n  dns.lookupService = wrap('apm:dns:lookup_service', dns.lookupService, 3);\n  dns.resolve = wrap('apm:dns:resolve', dns.resolve, 2);\n  dns.reverse = wrap('apm:dns:reverse', dns.reverse, 2);\n  patchResolveShorthands(dns);\n\n  if (dns.Resolver) {\n    dns.Resolver.prototype.resolve = wrap('apm:dns:resolve', dns.Resolver.prototype.resolve, 2);\n    dns.Resolver.prototype.reverse = wrap('apm:dns:reverse', dns.Resolver.prototype.reverse, 2);\n    patchResolveShorthands(dns.Resolver.prototype);\n  }\n\n  return dns;\n});\n\nfunction patchResolveShorthands(prototype) {\n  Object.keys(rrtypes).filter(method => !!prototype[method]).forEach(method => {\n    rrtypeMap.set(prototype[method], rrtypes[method]);\n    prototype[method] = wrap('apm:dns:resolve', prototype[method], 2, rrtypes[method]);\n  });\n}\n\nfunction wrap(prefix, fn, expectedArgs, rrtype) {\n  const startCh = channel(prefix + ':start');\n  const finishCh = channel(prefix + ':finish');\n  const errorCh = channel(prefix + ':error');\n\n  const wrapped = function () {\n    const cb = AsyncResource.bind(arguments[arguments.length - 1]);\n\n    if (!startCh.hasSubscribers || arguments.length < expectedArgs || typeof cb !== 'function') {\n      return fn.apply(this, arguments);\n    }\n\n    const startArgs = Array.from(arguments);\n    startArgs.pop(); // gets rid of the callback\n\n    if (rrtype) {\n      startArgs.push(rrtype);\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish(startArgs);\n      arguments[arguments.length - 1] = asyncResource.bind(function (error, result) {\n        if (error) {\n          errorCh.publish(error);\n        }\n\n        finishCh.publish(result);\n        cb.apply(this, arguments);\n      });\n\n      try {\n        return fn.apply(this, arguments); // TODO deal with promise versions when we support `dns/promises`\n      } catch (error) {\n        error.stack; // trigger getting the stack at the original throwing point\n\n        errorCh.publish(error);\n        throw error;\n      }\n    });\n  };\n\n  return shimmer.wrap(fn, wrapped);\n}","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","rrtypes","resolveAny","resolve4","resolve6","resolveCname","resolveMx","resolveNs","resolveTxt","resolveSrv","resolvePtr","resolveNaptr","resolveSoa","rrtypeMap","WeakMap","name","dns","lookup","wrap","lookupService","resolve","reverse","patchResolveShorthands","Resolver","prototype","Object","keys","filter","method","forEach","set","prefix","fn","expectedArgs","rrtype","startCh","finishCh","errorCh","wrapped","cb","bind","arguments","length","hasSubscribers","apply","startArgs","Array","from","pop","push","asyncResource","runInAsyncScope","publish","error","result","stack"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/dns.js"],"sourcesContent":["'use strict'\n\nconst { channel, addHook, AsyncResource } = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst rrtypes = {\n  resolveAny: 'ANY',\n  resolve4: 'A',\n  resolve6: 'AAAA',\n  resolveCname: 'CNAME',\n  resolveMx: 'MX',\n  resolveNs: 'NS',\n  resolveTxt: 'TXT',\n  resolveSrv: 'SRV',\n  resolvePtr: 'PTR',\n  resolveNaptr: 'NAPTR',\n  resolveSoa: 'SOA'\n}\n\nconst rrtypeMap = new WeakMap()\n\naddHook({ name: 'dns' }, dns => {\n  dns.lookup = wrap('apm:dns:lookup', dns.lookup, 2)\n  dns.lookupService = wrap('apm:dns:lookup_service', dns.lookupService, 3)\n  dns.resolve = wrap('apm:dns:resolve', dns.resolve, 2)\n  dns.reverse = wrap('apm:dns:reverse', dns.reverse, 2)\n\n  patchResolveShorthands(dns)\n\n  if (dns.Resolver) {\n    dns.Resolver.prototype.resolve = wrap('apm:dns:resolve', dns.Resolver.prototype.resolve, 2)\n    dns.Resolver.prototype.reverse = wrap('apm:dns:reverse', dns.Resolver.prototype.reverse, 2)\n\n    patchResolveShorthands(dns.Resolver.prototype)\n  }\n\n  return dns\n})\n\nfunction patchResolveShorthands (prototype) {\n  Object.keys(rrtypes)\n    .filter(method => !!prototype[method])\n    .forEach(method => {\n      rrtypeMap.set(prototype[method], rrtypes[method])\n      prototype[method] = wrap('apm:dns:resolve', prototype[method], 2, rrtypes[method])\n    })\n}\n\nfunction wrap (prefix, fn, expectedArgs, rrtype) {\n  const startCh = channel(prefix + ':start')\n  const finishCh = channel(prefix + ':finish')\n  const errorCh = channel(prefix + ':error')\n\n  const wrapped = function () {\n    const cb = AsyncResource.bind(arguments[arguments.length - 1])\n    if (\n      !startCh.hasSubscribers ||\n      arguments.length < expectedArgs ||\n      typeof cb !== 'function'\n    ) {\n      return fn.apply(this, arguments)\n    }\n\n    const startArgs = Array.from(arguments)\n    startArgs.pop() // gets rid of the callback\n    if (rrtype) {\n      startArgs.push(rrtype)\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish(startArgs)\n\n      arguments[arguments.length - 1] = asyncResource.bind(function (error, result) {\n        if (error) {\n          errorCh.publish(error)\n        }\n        finishCh.publish(result)\n        cb.apply(this, arguments)\n      })\n\n      try {\n        return fn.apply(this, arguments)\n      // TODO deal with promise versions when we support `dns/promises`\n      } catch (error) {\n        error.stack // trigger getting the stack at the original throwing point\n        errorCh.publish(error)\n\n        throw error\n      }\n    })\n  }\n\n  return shimmer.wrap(fn, wrapped)\n}\n"],"mappings":"AAAA;;AAEA,MAAM;EAAEA,OAAF;EAAWC,OAAX;EAAoBC;AAApB,IAAsCC,OAAO,CAAC,sBAAD,CAAnD;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,uBAAD,CAAvB;;AAEA,MAAME,OAAO,GAAG;EACdC,UAAU,EAAE,KADE;EAEdC,QAAQ,EAAE,GAFI;EAGdC,QAAQ,EAAE,MAHI;EAIdC,YAAY,EAAE,OAJA;EAKdC,SAAS,EAAE,IALG;EAMdC,SAAS,EAAE,IANG;EAOdC,UAAU,EAAE,KAPE;EAQdC,UAAU,EAAE,KARE;EASdC,UAAU,EAAE,KATE;EAUdC,YAAY,EAAE,OAVA;EAWdC,UAAU,EAAE;AAXE,CAAhB;AAcA,MAAMC,SAAS,GAAG,IAAIC,OAAJ,EAAlB;AAEAjB,OAAO,CAAC;EAAEkB,IAAI,EAAE;AAAR,CAAD,EAAkBC,GAAG,IAAI;EAC9BA,GAAG,CAACC,MAAJ,GAAaC,IAAI,CAAC,gBAAD,EAAmBF,GAAG,CAACC,MAAvB,EAA+B,CAA/B,CAAjB;EACAD,GAAG,CAACG,aAAJ,GAAoBD,IAAI,CAAC,wBAAD,EAA2BF,GAAG,CAACG,aAA/B,EAA8C,CAA9C,CAAxB;EACAH,GAAG,CAACI,OAAJ,GAAcF,IAAI,CAAC,iBAAD,EAAoBF,GAAG,CAACI,OAAxB,EAAiC,CAAjC,CAAlB;EACAJ,GAAG,CAACK,OAAJ,GAAcH,IAAI,CAAC,iBAAD,EAAoBF,GAAG,CAACK,OAAxB,EAAiC,CAAjC,CAAlB;EAEAC,sBAAsB,CAACN,GAAD,CAAtB;;EAEA,IAAIA,GAAG,CAACO,QAAR,EAAkB;IAChBP,GAAG,CAACO,QAAJ,CAAaC,SAAb,CAAuBJ,OAAvB,GAAiCF,IAAI,CAAC,iBAAD,EAAoBF,GAAG,CAACO,QAAJ,CAAaC,SAAb,CAAuBJ,OAA3C,EAAoD,CAApD,CAArC;IACAJ,GAAG,CAACO,QAAJ,CAAaC,SAAb,CAAuBH,OAAvB,GAAiCH,IAAI,CAAC,iBAAD,EAAoBF,GAAG,CAACO,QAAJ,CAAaC,SAAb,CAAuBH,OAA3C,EAAoD,CAApD,CAArC;IAEAC,sBAAsB,CAACN,GAAG,CAACO,QAAJ,CAAaC,SAAd,CAAtB;EACD;;EAED,OAAOR,GAAP;AACD,CAhBM,CAAP;;AAkBA,SAASM,sBAAT,CAAiCE,SAAjC,EAA4C;EAC1CC,MAAM,CAACC,IAAP,CAAYzB,OAAZ,EACG0B,MADH,CACUC,MAAM,IAAI,CAAC,CAACJ,SAAS,CAACI,MAAD,CAD/B,EAEGC,OAFH,CAEWD,MAAM,IAAI;IACjBf,SAAS,CAACiB,GAAV,CAAcN,SAAS,CAACI,MAAD,CAAvB,EAAiC3B,OAAO,CAAC2B,MAAD,CAAxC;IACAJ,SAAS,CAACI,MAAD,CAAT,GAAoBV,IAAI,CAAC,iBAAD,EAAoBM,SAAS,CAACI,MAAD,CAA7B,EAAuC,CAAvC,EAA0C3B,OAAO,CAAC2B,MAAD,CAAjD,CAAxB;EACD,CALH;AAMD;;AAED,SAASV,IAAT,CAAea,MAAf,EAAuBC,EAAvB,EAA2BC,YAA3B,EAAyCC,MAAzC,EAAiD;EAC/C,MAAMC,OAAO,GAAGvC,OAAO,CAACmC,MAAM,GAAG,QAAV,CAAvB;EACA,MAAMK,QAAQ,GAAGxC,OAAO,CAACmC,MAAM,GAAG,SAAV,CAAxB;EACA,MAAMM,OAAO,GAAGzC,OAAO,CAACmC,MAAM,GAAG,QAAV,CAAvB;;EAEA,MAAMO,OAAO,GAAG,YAAY;IAC1B,MAAMC,EAAE,GAAGzC,aAAa,CAAC0C,IAAd,CAAmBC,SAAS,CAACA,SAAS,CAACC,MAAV,GAAmB,CAApB,CAA5B,CAAX;;IACA,IACE,CAACP,OAAO,CAACQ,cAAT,IACAF,SAAS,CAACC,MAAV,GAAmBT,YADnB,IAEA,OAAOM,EAAP,KAAc,UAHhB,EAIE;MACA,OAAOP,EAAE,CAACY,KAAH,CAAS,IAAT,EAAeH,SAAf,CAAP;IACD;;IAED,MAAMI,SAAS,GAAGC,KAAK,CAACC,IAAN,CAAWN,SAAX,CAAlB;IACAI,SAAS,CAACG,GAAV,GAX0B,CAWV;;IAChB,IAAId,MAAJ,EAAY;MACVW,SAAS,CAACI,IAAV,CAAef,MAAf;IACD;;IAED,MAAMgB,aAAa,GAAG,IAAIpD,aAAJ,CAAkB,oBAAlB,CAAtB;IACA,OAAOoD,aAAa,CAACC,eAAd,CAA8B,MAAM;MACzChB,OAAO,CAACiB,OAAR,CAAgBP,SAAhB;MAEAJ,SAAS,CAACA,SAAS,CAACC,MAAV,GAAmB,CAApB,CAAT,GAAkCQ,aAAa,CAACV,IAAd,CAAmB,UAAUa,KAAV,EAAiBC,MAAjB,EAAyB;QAC5E,IAAID,KAAJ,EAAW;UACThB,OAAO,CAACe,OAAR,CAAgBC,KAAhB;QACD;;QACDjB,QAAQ,CAACgB,OAAT,CAAiBE,MAAjB;QACAf,EAAE,CAACK,KAAH,CAAS,IAAT,EAAeH,SAAf;MACD,CANiC,CAAlC;;MAQA,IAAI;QACF,OAAOT,EAAE,CAACY,KAAH,CAAS,IAAT,EAAeH,SAAf,CAAP,CADE,CAEJ;MACC,CAHD,CAGE,OAAOY,KAAP,EAAc;QACdA,KAAK,CAACE,KAAN,CADc,CACF;;QACZlB,OAAO,CAACe,OAAR,CAAgBC,KAAhB;QAEA,MAAMA,KAAN;MACD;IACF,CApBM,CAAP;EAqBD,CAtCD;;EAwCA,OAAOrD,OAAO,CAACkB,IAAR,CAAac,EAAb,EAAiBM,OAAjB,CAAP;AACD"},"metadata":{},"sourceType":"script"}