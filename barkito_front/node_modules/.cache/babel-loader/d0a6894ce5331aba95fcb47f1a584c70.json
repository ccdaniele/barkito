{"ast":null,"code":"'use strict';\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst {\n  addHook,\n  channel,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst errorChannel = channel('apm:fastify:middleware:error');\nconst handleChannel = channel('apm:fastify:request:handle');\nconst parsingResources = new WeakMap();\n\nfunction wrapFastify(fastify, hasParsingEvents) {\n  if (typeof fastify !== 'function') return fastify;\n  return function fastifyWithTrace() {\n    const app = fastify.apply(this, arguments);\n    if (!app || typeof app.addHook !== 'function') return app;\n    app.addHook('onRequest', onRequest);\n    app.addHook('preHandler', preHandler);\n\n    if (hasParsingEvents) {\n      app.addHook('preParsing', preParsing);\n      app.addHook('preValidation', preValidation);\n    } else {\n      app.addHook('onRequest', preParsing);\n      app.addHook('preHandler', preValidation);\n    }\n\n    app.addHook = wrapAddHook(app.addHook);\n    return app;\n  };\n}\n\nfunction wrapAddHook(addHook) {\n  return function addHookWithTrace(name, fn) {\n    fn = arguments[arguments.length - 1];\n    if (typeof fn !== 'function') return addHook.apply(this, arguments);\n    arguments[arguments.length - 1] = shimmer.wrap(fn, function (request, reply, done) {\n      const req = getReq(request);\n\n      try {\n        if (typeof done === 'function') {\n          done = arguments[arguments.length - 1];\n\n          arguments[arguments.length - 1] = function (err) {\n            publishError(err, req);\n\n            if (name === 'onRequest' || name === 'preParsing') {\n              const parsingResource = new AsyncResource('bound-anonymous-fn');\n              parsingResources.set(req, parsingResource);\n              return parsingResource.runInAsyncScope(() => {\n                return done.apply(this, arguments);\n              });\n            } else {\n              return done.apply(this, arguments);\n            }\n          };\n\n          return fn.apply(this, arguments);\n        } else {\n          const promise = fn.apply(this, arguments);\n\n          if (promise && typeof promise.catch === 'function') {\n            return promise.catch(err => publishError(err, req));\n          }\n\n          return promise;\n        }\n      } catch (e) {\n        throw publishError(e, req);\n      }\n    });\n    return addHook.apply(this, arguments);\n  };\n}\n\nfunction onRequest(request, reply, done) {\n  if (typeof done !== 'function') return;\n  const req = getReq(request);\n  const res = getRes(reply);\n  handleChannel.publish({\n    req,\n    res\n  });\n  return done();\n}\n\nfunction preHandler(request, reply, done) {\n  if (typeof done !== 'function') return;\n  if (!reply || typeof reply.send !== 'function') return done();\n  const req = getReq(request);\n  reply.send = wrapSend(reply.send, req);\n  done();\n}\n\nfunction preValidation(request, reply, done) {\n  const req = getReq(request);\n  const parsingResource = parsingResources.get(req);\n  if (!parsingResource) return done();\n  parsingResource.runInAsyncScope(() => done());\n}\n\nfunction preParsing(request, reply, payload, done) {\n  if (typeof done !== 'function') {\n    done = payload;\n  }\n\n  const req = getReq(request);\n  const parsingResource = new AsyncResource('bound-anonymous-fn');\n  parsingResources.set(req, parsingResource);\n  parsingResource.runInAsyncScope(() => done());\n}\n\nfunction wrapSend(send, req) {\n  return function sendWithTrace(error) {\n    if (error instanceof Error) {\n      errorChannel.publish({\n        req,\n        error\n      });\n    }\n\n    return send.apply(this, arguments);\n  };\n}\n\nfunction getReq(request) {\n  return request && (request.raw || request.req || request);\n}\n\nfunction getRes(reply) {\n  return reply && (reply.raw || reply.res || reply);\n}\n\nfunction publishError(error, req) {\n  if (error) {\n    errorChannel.publish({\n      error,\n      req\n    });\n  }\n\n  return error;\n}\n\naddHook({\n  name: 'fastify',\n  versions: ['>=3']\n}, fastify => {\n  const wrapped = shimmer.wrap(fastify, wrapFastify(fastify, true));\n  wrapped.fastify = wrapped;\n  wrapped.default = wrapped;\n  return wrapped;\n});\naddHook({\n  name: 'fastify',\n  versions: ['2']\n}, fastify => {\n  return shimmer.wrap(fastify, wrapFastify(fastify, true));\n});\naddHook({\n  name: 'fastify',\n  versions: ['1']\n}, fastify => {\n  return shimmer.wrap(fastify, wrapFastify(fastify, false));\n});","map":{"version":3,"names":["shimmer","require","addHook","channel","AsyncResource","errorChannel","handleChannel","parsingResources","WeakMap","wrapFastify","fastify","hasParsingEvents","fastifyWithTrace","app","apply","arguments","onRequest","preHandler","preParsing","preValidation","wrapAddHook","addHookWithTrace","name","fn","length","wrap","request","reply","done","req","getReq","err","publishError","parsingResource","set","runInAsyncScope","promise","catch","e","res","getRes","publish","send","wrapSend","get","payload","sendWithTrace","error","Error","raw","versions","wrapped","default"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/fastify.js"],"sourcesContent":["'use strict'\n\nconst shimmer = require('../../datadog-shimmer')\nconst { addHook, channel, AsyncResource } = require('./helpers/instrument')\n\nconst errorChannel = channel('apm:fastify:middleware:error')\nconst handleChannel = channel('apm:fastify:request:handle')\n\nconst parsingResources = new WeakMap()\n\nfunction wrapFastify (fastify, hasParsingEvents) {\n  if (typeof fastify !== 'function') return fastify\n\n  return function fastifyWithTrace () {\n    const app = fastify.apply(this, arguments)\n\n    if (!app || typeof app.addHook !== 'function') return app\n\n    app.addHook('onRequest', onRequest)\n    app.addHook('preHandler', preHandler)\n\n    if (hasParsingEvents) {\n      app.addHook('preParsing', preParsing)\n      app.addHook('preValidation', preValidation)\n    } else {\n      app.addHook('onRequest', preParsing)\n      app.addHook('preHandler', preValidation)\n    }\n\n    app.addHook = wrapAddHook(app.addHook)\n\n    return app\n  }\n}\n\nfunction wrapAddHook (addHook) {\n  return function addHookWithTrace (name, fn) {\n    fn = arguments[arguments.length - 1]\n\n    if (typeof fn !== 'function') return addHook.apply(this, arguments)\n\n    arguments[arguments.length - 1] = shimmer.wrap(fn, function (request, reply, done) {\n      const req = getReq(request)\n\n      try {\n        if (typeof done === 'function') {\n          done = arguments[arguments.length - 1]\n\n          arguments[arguments.length - 1] = function (err) {\n            publishError(err, req)\n\n            if (name === 'onRequest' || name === 'preParsing') {\n              const parsingResource = new AsyncResource('bound-anonymous-fn')\n\n              parsingResources.set(req, parsingResource)\n\n              return parsingResource.runInAsyncScope(() => {\n                return done.apply(this, arguments)\n              })\n            } else {\n              return done.apply(this, arguments)\n            }\n          }\n\n          return fn.apply(this, arguments)\n        } else {\n          const promise = fn.apply(this, arguments)\n\n          if (promise && typeof promise.catch === 'function') {\n            return promise.catch(err => publishError(err, req))\n          }\n\n          return promise\n        }\n      } catch (e) {\n        throw publishError(e, req)\n      }\n    })\n\n    return addHook.apply(this, arguments)\n  }\n}\n\nfunction onRequest (request, reply, done) {\n  if (typeof done !== 'function') return\n\n  const req = getReq(request)\n  const res = getRes(reply)\n\n  handleChannel.publish({ req, res })\n\n  return done()\n}\n\nfunction preHandler (request, reply, done) {\n  if (typeof done !== 'function') return\n  if (!reply || typeof reply.send !== 'function') return done()\n\n  const req = getReq(request)\n\n  reply.send = wrapSend(reply.send, req)\n\n  done()\n}\n\nfunction preValidation (request, reply, done) {\n  const req = getReq(request)\n  const parsingResource = parsingResources.get(req)\n\n  if (!parsingResource) return done()\n\n  parsingResource.runInAsyncScope(() => done())\n}\n\nfunction preParsing (request, reply, payload, done) {\n  if (typeof done !== 'function') {\n    done = payload\n  }\n\n  const req = getReq(request)\n  const parsingResource = new AsyncResource('bound-anonymous-fn')\n\n  parsingResources.set(req, parsingResource)\n  parsingResource.runInAsyncScope(() => done())\n}\n\nfunction wrapSend (send, req) {\n  return function sendWithTrace (error) {\n    if (error instanceof Error) {\n      errorChannel.publish({ req, error })\n    }\n\n    return send.apply(this, arguments)\n  }\n}\n\nfunction getReq (request) {\n  return request && (request.raw || request.req || request)\n}\n\nfunction getRes (reply) {\n  return reply && (reply.raw || reply.res || reply)\n}\n\nfunction publishError (error, req) {\n  if (error) {\n    errorChannel.publish({ error, req })\n  }\n\n  return error\n}\n\naddHook({ name: 'fastify', versions: ['>=3'] }, fastify => {\n  const wrapped = shimmer.wrap(fastify, wrapFastify(fastify, true))\n\n  wrapped.fastify = wrapped\n  wrapped.default = wrapped\n\n  return wrapped\n})\n\naddHook({ name: 'fastify', versions: ['2'] }, fastify => {\n  return shimmer.wrap(fastify, wrapFastify(fastify, true))\n})\n\naddHook({ name: 'fastify', versions: ['1'] }, fastify => {\n  return shimmer.wrap(fastify, wrapFastify(fastify, false))\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}