{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\naddHook({\n  name: 'mysql',\n  file: 'lib/Connection.js',\n  versions: ['>=2']\n}, Connection => {\n  const startCh = channel('apm:mysql:query:start');\n  const finishCh = channel('apm:mysql:query:finish');\n  const errorCh = channel('apm:mysql:query:error');\n  shimmer.wrap(Connection.prototype, 'query', query => function () {\n    if (!startCh.hasSubscribers) {\n      return query.apply(this, arguments);\n    }\n\n    const sql = arguments[0].sql ? arguments[0].sql : arguments[0];\n    const conf = this.config;\n    const callbackResource = new AsyncResource('bound-anonymous-fn');\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({\n        sql,\n        conf\n      });\n\n      try {\n        const res = query.apply(this, arguments);\n\n        if (res._callback) {\n          const cb = callbackResource.bind(res._callback);\n          res._callback = asyncResource.bind(function (error, result) {\n            if (error) {\n              errorCh.publish(error);\n            }\n\n            finishCh.publish(result);\n            return cb.apply(this, arguments);\n          });\n        } else {\n          const cb = asyncResource.bind(function () {\n            finishCh.publish(undefined);\n          });\n          res.on('end', cb);\n        }\n\n        return res;\n      } catch (err) {\n        err.stack; // trigger getting the stack at the original throwing point\n\n        errorCh.publish(err);\n        throw err;\n      }\n    });\n  });\n  return Connection;\n});\naddHook({\n  name: 'mysql',\n  file: 'lib/Pool.js',\n  versions: ['>=2']\n}, Pool => {\n  shimmer.wrap(Pool.prototype, 'getConnection', getConnection => function (cb) {\n    arguments[0] = AsyncResource.bind(cb);\n    return getConnection.apply(this, arguments);\n  });\n  return Pool;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","name","file","versions","Connection","startCh","finishCh","errorCh","wrap","prototype","query","hasSubscribers","apply","arguments","sql","conf","config","callbackResource","asyncResource","runInAsyncScope","publish","res","_callback","cb","bind","error","result","undefined","on","err","stack","Pool","getConnection"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/mysql.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\naddHook({ name: 'mysql', file: 'lib/Connection.js', versions: ['>=2'] }, Connection => {\n  const startCh = channel('apm:mysql:query:start')\n  const finishCh = channel('apm:mysql:query:finish')\n  const errorCh = channel('apm:mysql:query:error')\n\n  shimmer.wrap(Connection.prototype, 'query', query => function () {\n    if (!startCh.hasSubscribers) {\n      return query.apply(this, arguments)\n    }\n\n    const sql = arguments[0].sql ? arguments[0].sql : arguments[0]\n    const conf = this.config\n\n    const callbackResource = new AsyncResource('bound-anonymous-fn')\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({ sql, conf })\n\n      try {\n        const res = query.apply(this, arguments)\n\n        if (res._callback) {\n          const cb = callbackResource.bind(res._callback)\n          res._callback = asyncResource.bind(function (error, result) {\n            if (error) {\n              errorCh.publish(error)\n            }\n            finishCh.publish(result)\n\n            return cb.apply(this, arguments)\n          })\n        } else {\n          const cb = asyncResource.bind(function () {\n            finishCh.publish(undefined)\n          })\n          res.on('end', cb)\n        }\n\n        return res\n      } catch (err) {\n        err.stack // trigger getting the stack at the original throwing point\n        errorCh.publish(err)\n\n        throw err\n      }\n    })\n  })\n\n  return Connection\n})\n\naddHook({ name: 'mysql', file: 'lib/Pool.js', versions: ['>=2'] }, Pool => {\n  shimmer.wrap(Pool.prototype, 'getConnection', getConnection => function (cb) {\n    arguments[0] = AsyncResource.bind(cb)\n    return getConnection.apply(this, arguments)\n  })\n  return Pool\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}