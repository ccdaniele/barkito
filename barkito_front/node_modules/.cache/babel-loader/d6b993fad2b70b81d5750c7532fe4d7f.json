{"ast":null,"code":"'use strict'; // TODO: either instrument all or none of the render functions\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst startChannel = channel('apm:next:request:start');\nconst finishChannel = channel('apm:next:request:finish');\nconst errorChannel = channel('apm:next:request:error');\nconst pageLoadChannel = channel('apm:next:page:load');\nconst requestResources = new WeakMap();\n\nfunction wrapHandleRequest(handleRequest) {\n  return function (req, res, pathname, query) {\n    return instrument(req, res, () => handleRequest.apply(this, arguments));\n  };\n}\n\nfunction wrapHandleApiRequest(handleApiRequest) {\n  return function (req, res, pathname, query) {\n    return instrument(req, res, () => {\n      const promise = handleApiRequest.apply(this, arguments);\n      return promise.then(handled => {\n        if (!handled) return handled;\n        const page = getPageFromPath(pathname, this.dynamicRoutes);\n        pageLoadChannel.publish({\n          page\n        });\n        return handled;\n      });\n    });\n  };\n}\n\nfunction wrapRenderToResponse(renderToResponse) {\n  return function (ctx) {\n    return instrument(ctx.req, ctx.res, () => renderToResponse.apply(this, arguments));\n  };\n}\n\nfunction wrapRenderErrorToResponse(renderErrorToResponse) {\n  return function (ctx) {\n    return instrument(ctx.req, ctx.res, () => renderErrorToResponse.apply(this, arguments));\n  };\n}\n\nfunction wrapRenderToHTML(renderToHTML) {\n  return function (req, res, pathname, query, parsedUrl) {\n    return instrument(req, res, () => renderToHTML.apply(this, arguments));\n  };\n}\n\nfunction wrapRenderErrorToHTML(renderErrorToHTML) {\n  return function (err, req, res, pathname, query) {\n    return instrument(req, res, () => renderErrorToHTML.apply(this, arguments));\n  };\n}\n\nfunction wrapFindPageComponents(findPageComponents) {\n  return function (pathname, query) {\n    const result = findPageComponents.apply(this, arguments);\n\n    if (result) {\n      pageLoadChannel.publish({\n        page: getPagePath(pathname)\n      });\n    }\n\n    return result;\n  };\n}\n\nfunction getPagePath(page) {\n  return typeof page === 'object' ? page.pathname : page;\n}\n\nfunction getPageFromPath(page) {\n  let dynamicRoutes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n\n  for (const dynamicRoute of dynamicRoutes) {\n    if (dynamicRoute.page.startsWith('/api') && dynamicRoute.match(page)) {\n      return getPagePath(dynamicRoute.page);\n    }\n  }\n\n  return getPagePath(page);\n}\n\nfunction instrument(req, res, handler) {\n  if (requestResources.has(req)) return handler();\n  const requestResource = new AsyncResource('bound-anonymous-fn');\n  requestResources.set(req, requestResource);\n  return requestResource.runInAsyncScope(() => {\n    startChannel.publish({\n      req,\n      res\n    });\n\n    try {\n      const promise = handler(); // promise should only reject when propagateError is true:\n      // https://github.com/vercel/next.js/blob/cee656238a/packages/next/server/api-utils/node.ts#L547\n\n      return promise.then(result => finish(req, res, result), err => finish(req, res, null, err));\n    } catch (e) {\n      // this will probably never happen as the handler caller is an async function:\n      // https://github.com/vercel/next.js/blob/cee656238a/packages/next/server/api-utils/node.ts#L420\n      return finish(req, res, null, e);\n    }\n  });\n}\n\nfunction finish(req, res, result, err) {\n  if (err) {\n    errorChannel.publish(err);\n  }\n\n  finishChannel.publish({\n    req,\n    res\n  });\n\n  if (err) {\n    throw err;\n  }\n\n  return result;\n}\n\naddHook({\n  name: 'next',\n  versions: ['>=11.1'],\n  file: 'dist/server/next-server.js'\n}, nextServer => {\n  const Server = nextServer.default;\n  shimmer.wrap(Server.prototype, 'handleRequest', wrapHandleRequest);\n  shimmer.wrap(Server.prototype, 'handleApiRequest', wrapHandleApiRequest);\n  shimmer.wrap(Server.prototype, 'renderToResponse', wrapRenderToResponse);\n  shimmer.wrap(Server.prototype, 'renderErrorToResponse', wrapRenderErrorToResponse);\n  shimmer.wrap(Server.prototype, 'findPageComponents', wrapFindPageComponents);\n  return nextServer;\n});\naddHook({\n  name: 'next',\n  versions: ['>=9.5 <11.1'],\n  file: 'dist/next-server/server/next-server.js'\n}, nextServer => {\n  const Server = nextServer.default;\n  shimmer.wrap(Server.prototype, 'handleRequest', wrapHandleRequest);\n  shimmer.wrap(Server.prototype, 'handleApiRequest', wrapHandleApiRequest);\n  shimmer.wrap(Server.prototype, 'renderToHTML', wrapRenderToHTML);\n  shimmer.wrap(Server.prototype, 'renderErrorToHTML', wrapRenderErrorToHTML);\n  shimmer.wrap(Server.prototype, 'findPageComponents', wrapFindPageComponents);\n  return nextServer;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startChannel","finishChannel","errorChannel","pageLoadChannel","requestResources","WeakMap","wrapHandleRequest","handleRequest","req","res","pathname","query","instrument","apply","arguments","wrapHandleApiRequest","handleApiRequest","promise","then","handled","page","getPageFromPath","dynamicRoutes","publish","wrapRenderToResponse","renderToResponse","ctx","wrapRenderErrorToResponse","renderErrorToResponse","wrapRenderToHTML","renderToHTML","parsedUrl","wrapRenderErrorToHTML","renderErrorToHTML","err","wrapFindPageComponents","findPageComponents","result","getPagePath","dynamicRoute","startsWith","match","handler","has","requestResource","set","runInAsyncScope","finish","e","name","versions","file","nextServer","Server","default","wrap","prototype"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/next.js"],"sourcesContent":["'use strict'\n\n// TODO: either instrument all or none of the render functions\n\nconst { channel, addHook, AsyncResource } = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst startChannel = channel('apm:next:request:start')\nconst finishChannel = channel('apm:next:request:finish')\nconst errorChannel = channel('apm:next:request:error')\nconst pageLoadChannel = channel('apm:next:page:load')\n\nconst requestResources = new WeakMap()\n\nfunction wrapHandleRequest (handleRequest) {\n  return function (req, res, pathname, query) {\n    return instrument(req, res, () => handleRequest.apply(this, arguments))\n  }\n}\n\nfunction wrapHandleApiRequest (handleApiRequest) {\n  return function (req, res, pathname, query) {\n    return instrument(req, res, () => {\n      const promise = handleApiRequest.apply(this, arguments)\n\n      return promise.then(handled => {\n        if (!handled) return handled\n\n        const page = getPageFromPath(pathname, this.dynamicRoutes)\n\n        pageLoadChannel.publish({ page })\n\n        return handled\n      })\n    })\n  }\n}\n\nfunction wrapRenderToResponse (renderToResponse) {\n  return function (ctx) {\n    return instrument(ctx.req, ctx.res, () => renderToResponse.apply(this, arguments))\n  }\n}\n\nfunction wrapRenderErrorToResponse (renderErrorToResponse) {\n  return function (ctx) {\n    return instrument(ctx.req, ctx.res, () => renderErrorToResponse.apply(this, arguments))\n  }\n}\n\nfunction wrapRenderToHTML (renderToHTML) {\n  return function (req, res, pathname, query, parsedUrl) {\n    return instrument(req, res, () => renderToHTML.apply(this, arguments))\n  }\n}\n\nfunction wrapRenderErrorToHTML (renderErrorToHTML) {\n  return function (err, req, res, pathname, query) {\n    return instrument(req, res, () => renderErrorToHTML.apply(this, arguments))\n  }\n}\n\nfunction wrapFindPageComponents (findPageComponents) {\n  return function (pathname, query) {\n    const result = findPageComponents.apply(this, arguments)\n\n    if (result) {\n      pageLoadChannel.publish({ page: getPagePath(pathname) })\n    }\n\n    return result\n  }\n}\n\nfunction getPagePath (page) {\n  return typeof page === 'object' ? page.pathname : page\n}\n\nfunction getPageFromPath (page, dynamicRoutes = []) {\n  for (const dynamicRoute of dynamicRoutes) {\n    if (dynamicRoute.page.startsWith('/api') && dynamicRoute.match(page)) {\n      return getPagePath(dynamicRoute.page)\n    }\n  }\n\n  return getPagePath(page)\n}\n\nfunction instrument (req, res, handler) {\n  if (requestResources.has(req)) return handler()\n\n  const requestResource = new AsyncResource('bound-anonymous-fn')\n\n  requestResources.set(req, requestResource)\n\n  return requestResource.runInAsyncScope(() => {\n    startChannel.publish({ req, res })\n\n    try {\n      const promise = handler()\n\n      // promise should only reject when propagateError is true:\n      // https://github.com/vercel/next.js/blob/cee656238a/packages/next/server/api-utils/node.ts#L547\n      return promise.then(\n        result => finish(req, res, result),\n        err => finish(req, res, null, err)\n      )\n    } catch (e) {\n      // this will probably never happen as the handler caller is an async function:\n      // https://github.com/vercel/next.js/blob/cee656238a/packages/next/server/api-utils/node.ts#L420\n      return finish(req, res, null, e)\n    }\n  })\n}\n\nfunction finish (req, res, result, err) {\n  if (err) {\n    errorChannel.publish(err)\n  }\n\n  finishChannel.publish({ req, res })\n\n  if (err) {\n    throw err\n  }\n\n  return result\n}\n\naddHook({ name: 'next', versions: ['>=11.1'], file: 'dist/server/next-server.js' }, nextServer => {\n  const Server = nextServer.default\n\n  shimmer.wrap(Server.prototype, 'handleRequest', wrapHandleRequest)\n  shimmer.wrap(Server.prototype, 'handleApiRequest', wrapHandleApiRequest)\n  shimmer.wrap(Server.prototype, 'renderToResponse', wrapRenderToResponse)\n  shimmer.wrap(Server.prototype, 'renderErrorToResponse', wrapRenderErrorToResponse)\n  shimmer.wrap(Server.prototype, 'findPageComponents', wrapFindPageComponents)\n\n  return nextServer\n})\n\naddHook({ name: 'next', versions: ['>=9.5 <11.1'], file: 'dist/next-server/server/next-server.js' }, nextServer => {\n  const Server = nextServer.default\n\n  shimmer.wrap(Server.prototype, 'handleRequest', wrapHandleRequest)\n  shimmer.wrap(Server.prototype, 'handleApiRequest', wrapHandleApiRequest)\n  shimmer.wrap(Server.prototype, 'renderToHTML', wrapRenderToHTML)\n  shimmer.wrap(Server.prototype, 'renderErrorToHTML', wrapRenderErrorToHTML)\n  shimmer.wrap(Server.prototype, 'findPageComponents', wrapFindPageComponents)\n\n  return nextServer\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}