{"ast":null,"code":"'use strict'; // Old instrumentation temporarily replaced with compatibility mode only instrumentation.\n// See https://github.com/DataDog/dd-trace-js/issues/312\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('../helpers/instrument');\n\nconst shimmer = require('../../../datadog-shimmer');\n\nconst startServerCh = channel('apm:http2:server:request:start');\nconst errorServerCh = channel('apm:http2:server:request:error');\nconst finishServerCh = channel('apm:http2:server:request:finish');\naddHook({\n  name: 'http2'\n}, http2 => {\n  shimmer.wrap(http2, 'createSecureServer', wrapCreateServer);\n  shimmer.wrap(http2, 'createServer', wrapCreateServer);\n  return http2;\n});\n\nfunction wrapCreateServer(createServer) {\n  return function () {\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    const server = createServer.apply(this, args);\n    shimmer.wrap(server, 'emit', wrapEmit);\n    return server;\n  };\n}\n\nfunction wrapResponseEmit(emit) {\n  const asyncResource = new AsyncResource('bound-anonymous-fn');\n  return function (eventName, event) {\n    return asyncResource.runInAsyncScope(() => {\n      if (eventName === 'close' && finishServerCh.hasSubscribers) {\n        finishServerCh.publish({\n          req: this.req\n        });\n      }\n\n      return emit.apply(this, arguments);\n    });\n  };\n}\n\nfunction wrapEmit(emit) {\n  return function (eventName, req, res) {\n    if (!startServerCh.hasSubscribers) {\n      return emit.apply(this, arguments);\n    }\n\n    if (eventName === 'request') {\n      res.req = req;\n      const asyncResource = new AsyncResource('bound-anonymous-fn');\n      return asyncResource.runInAsyncScope(() => {\n        startServerCh.publish({\n          req,\n          res\n        });\n        shimmer.wrap(res, 'emit', wrapResponseEmit);\n\n        try {\n          return emit.apply(this, arguments);\n        } catch (err) {\n          errorServerCh.publish(err);\n          throw err;\n        }\n      });\n    }\n\n    return emit.apply(this, arguments);\n  };\n}","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startServerCh","errorServerCh","finishServerCh","name","http2","wrap","wrapCreateServer","createServer","args","server","apply","wrapEmit","wrapResponseEmit","emit","asyncResource","eventName","event","runInAsyncScope","hasSubscribers","publish","req","arguments","res","err"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/http2/server.js"],"sourcesContent":["'use strict'\n\n// Old instrumentation temporarily replaced with compatibility mode only instrumentation.\n// See https://github.com/DataDog/dd-trace-js/issues/312\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('../helpers/instrument')\nconst shimmer = require('../../../datadog-shimmer')\n\nconst startServerCh = channel('apm:http2:server:request:start')\nconst errorServerCh = channel('apm:http2:server:request:error')\nconst finishServerCh = channel('apm:http2:server:request:finish')\n\naddHook({ name: 'http2' }, http2 => {\n  shimmer.wrap(http2, 'createSecureServer', wrapCreateServer)\n  shimmer.wrap(http2, 'createServer', wrapCreateServer)\n  return http2\n})\n\nfunction wrapCreateServer (createServer) {\n  return function (...args) {\n    const server = createServer.apply(this, args)\n    shimmer.wrap(server, 'emit', wrapEmit)\n    return server\n  }\n}\n\nfunction wrapResponseEmit (emit) {\n  const asyncResource = new AsyncResource('bound-anonymous-fn')\n  return function (eventName, event) {\n    return asyncResource.runInAsyncScope(() => {\n      if (eventName === 'close' && finishServerCh.hasSubscribers) {\n        finishServerCh.publish({ req: this.req })\n      }\n\n      return emit.apply(this, arguments)\n    })\n  }\n}\nfunction wrapEmit (emit) {\n  return function (eventName, req, res) {\n    if (!startServerCh.hasSubscribers) {\n      return emit.apply(this, arguments)\n    }\n\n    if (eventName === 'request') {\n      res.req = req\n\n      const asyncResource = new AsyncResource('bound-anonymous-fn')\n      return asyncResource.runInAsyncScope(() => {\n        startServerCh.publish({ req, res })\n\n        shimmer.wrap(res, 'emit', wrapResponseEmit)\n\n        try {\n          return emit.apply(this, arguments)\n        } catch (err) {\n          errorServerCh.publish(err)\n\n          throw err\n        }\n      })\n    }\n    return emit.apply(this, arguments)\n  }\n}\n"],"mappings":"AAAA,a,CAEA;AACA;;AAEA,MAAM;EACJA,OADI;EAEJC,OAFI;EAGJC;AAHI,IAIFC,OAAO,CAAC,uBAAD,CAJX;;AAKA,MAAMC,OAAO,GAAGD,OAAO,CAAC,0BAAD,CAAvB;;AAEA,MAAME,aAAa,GAAGL,OAAO,CAAC,gCAAD,CAA7B;AACA,MAAMM,aAAa,GAAGN,OAAO,CAAC,gCAAD,CAA7B;AACA,MAAMO,cAAc,GAAGP,OAAO,CAAC,iCAAD,CAA9B;AAEAC,OAAO,CAAC;EAAEO,IAAI,EAAE;AAAR,CAAD,EAAoBC,KAAK,IAAI;EAClCL,OAAO,CAACM,IAAR,CAAaD,KAAb,EAAoB,oBAApB,EAA0CE,gBAA1C;EACAP,OAAO,CAACM,IAAR,CAAaD,KAAb,EAAoB,cAApB,EAAoCE,gBAApC;EACA,OAAOF,KAAP;AACD,CAJM,CAAP;;AAMA,SAASE,gBAAT,CAA2BC,YAA3B,EAAyC;EACvC,OAAO,YAAmB;IAAA,kCAANC,IAAM;MAANA,IAAM;IAAA;;IACxB,MAAMC,MAAM,GAAGF,YAAY,CAACG,KAAb,CAAmB,IAAnB,EAAyBF,IAAzB,CAAf;IACAT,OAAO,CAACM,IAAR,CAAaI,MAAb,EAAqB,MAArB,EAA6BE,QAA7B;IACA,OAAOF,MAAP;EACD,CAJD;AAKD;;AAED,SAASG,gBAAT,CAA2BC,IAA3B,EAAiC;EAC/B,MAAMC,aAAa,GAAG,IAAIjB,aAAJ,CAAkB,oBAAlB,CAAtB;EACA,OAAO,UAAUkB,SAAV,EAAqBC,KAArB,EAA4B;IACjC,OAAOF,aAAa,CAACG,eAAd,CAA8B,MAAM;MACzC,IAAIF,SAAS,KAAK,OAAd,IAAyBb,cAAc,CAACgB,cAA5C,EAA4D;QAC1DhB,cAAc,CAACiB,OAAf,CAAuB;UAAEC,GAAG,EAAE,KAAKA;QAAZ,CAAvB;MACD;;MAED,OAAOP,IAAI,CAACH,KAAL,CAAW,IAAX,EAAiBW,SAAjB,CAAP;IACD,CANM,CAAP;EAOD,CARD;AASD;;AACD,SAASV,QAAT,CAAmBE,IAAnB,EAAyB;EACvB,OAAO,UAAUE,SAAV,EAAqBK,GAArB,EAA0BE,GAA1B,EAA+B;IACpC,IAAI,CAACtB,aAAa,CAACkB,cAAnB,EAAmC;MACjC,OAAOL,IAAI,CAACH,KAAL,CAAW,IAAX,EAAiBW,SAAjB,CAAP;IACD;;IAED,IAAIN,SAAS,KAAK,SAAlB,EAA6B;MAC3BO,GAAG,CAACF,GAAJ,GAAUA,GAAV;MAEA,MAAMN,aAAa,GAAG,IAAIjB,aAAJ,CAAkB,oBAAlB,CAAtB;MACA,OAAOiB,aAAa,CAACG,eAAd,CAA8B,MAAM;QACzCjB,aAAa,CAACmB,OAAd,CAAsB;UAAEC,GAAF;UAAOE;QAAP,CAAtB;QAEAvB,OAAO,CAACM,IAAR,CAAaiB,GAAb,EAAkB,MAAlB,EAA0BV,gBAA1B;;QAEA,IAAI;UACF,OAAOC,IAAI,CAACH,KAAL,CAAW,IAAX,EAAiBW,SAAjB,CAAP;QACD,CAFD,CAEE,OAAOE,GAAP,EAAY;UACZtB,aAAa,CAACkB,OAAd,CAAsBI,GAAtB;UAEA,MAAMA,GAAN;QACD;MACF,CAZM,CAAP;IAaD;;IACD,OAAOV,IAAI,CAACH,KAAL,CAAW,IAAX,EAAiBW,SAAjB,CAAP;EACD,CAxBD;AAyBD"},"metadata":{},"sourceType":"script"}