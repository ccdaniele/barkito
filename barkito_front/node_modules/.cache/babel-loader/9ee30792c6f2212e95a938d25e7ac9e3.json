{"ast":null,"code":"'use strict';\n/* eslint-disable no-fallthrough */\n\nconst url = require('url');\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('../helpers/instrument');\n\nconst shimmer = require('../../../datadog-shimmer');\n\nconst log = require('../../../dd-trace/src/log');\n\nconst startClientCh = channel('apm:http:client:request:start');\nconst finishClientCh = channel('apm:http:client:request:finish');\nconst errorClientCh = channel('apm:http:client:request:error');\naddHook({\n  name: 'https'\n}, hookFn);\naddHook({\n  name: 'http'\n}, hookFn);\n\nfunction hookFn(http) {\n  patch(http, 'request');\n  patch(http, 'get');\n  return http;\n}\n\nfunction patch(http, methodName) {\n  shimmer.wrap(http, methodName, instrumentRequest);\n\n  function instrumentRequest(request) {\n    return function () {\n      if (!startClientCh.hasSubscribers) {\n        return request.apply(this, arguments);\n      }\n\n      let args;\n\n      try {\n        args = normalizeArgs.apply(null, arguments);\n      } catch (e) {\n        log.error(e);\n        return request.apply(this, arguments);\n      }\n\n      const callbackResource = new AsyncResource('bound-anonymous-fn');\n      const asyncResource = new AsyncResource('bound-anonymous-fn');\n      return asyncResource.runInAsyncScope(() => {\n        startClientCh.publish({\n          args,\n          http\n        });\n        let finished = false;\n        let callback = args.callback;\n\n        if (callback) {\n          callback = callbackResource.bind(callback);\n        }\n\n        const options = args.options;\n        const req = request.call(this, options, callback);\n        const emit = req.emit;\n\n        const finish = (req, res) => {\n          if (!finished) {\n            finished = true;\n            finishClientCh.publish({\n              req,\n              res\n            });\n          }\n        };\n\n        req.emit = function (eventName, arg) {\n          asyncResource.runInAsyncScope(() => {\n            switch (eventName) {\n              case 'response':\n                {\n                  const res = arg;\n                  const listener = asyncResource.bind(() => finish(req, res));\n                  res.on('end', listener);\n                  res.on('error', listener);\n                  break;\n                }\n\n              case 'connect':\n              case 'upgrade':\n                finish(req, arg);\n                break;\n\n              case 'error':\n              case 'timeout':\n                errorClientCh.publish(arg);\n\n              case 'abort': // deprecated and replaced by `close` in node 17\n\n              case 'close':\n                finish(req);\n            }\n          });\n          return emit.apply(this, arguments);\n        };\n\n        return req;\n      });\n    };\n  }\n\n  function normalizeArgs(inputURL, inputOptions, cb) {\n    inputURL = normalizeOptions(inputURL);\n    const [callback, inputOptionsNormalized] = normalizeCallback(inputOptions, cb, inputURL);\n    const options = combineOptions(inputURL, inputOptionsNormalized);\n    normalizeHeaders(options);\n    const uri = url.format(options);\n    return {\n      uri,\n      options,\n      callback\n    };\n  }\n\n  function combineOptions(inputURL, inputOptions) {\n    if (typeof inputOptions === 'object') {\n      return Object.assign(inputURL || {}, inputOptions);\n    } else {\n      return inputURL;\n    }\n  }\n\n  function normalizeHeaders(options) {\n    options.headers = options.headers || {};\n  }\n\n  function normalizeCallback(inputOptions, callback, inputURL) {\n    if (typeof inputOptions === 'function') {\n      return [inputOptions, inputURL || {}];\n    } else {\n      return [callback, inputOptions];\n    }\n  }\n\n  function normalizeOptions(inputURL) {\n    if (typeof inputURL === 'string') {\n      try {\n        return urlToOptions(new url.URL(inputURL));\n      } catch (e) {\n        return url.parse(inputURL);\n      }\n    } else if (inputURL instanceof url.URL) {\n      return urlToOptions(inputURL);\n    } else {\n      return inputURL;\n    }\n  }\n\n  function urlToOptions(url) {\n    const agent = url.agent || http.globalAgent;\n    const options = {\n      protocol: url.protocol || agent.protocol,\n      hostname: typeof url.hostname === 'string' && url.hostname.startsWith('[') ? url.hostname.slice(1, -1) : url.hostname || url.host || 'localhost',\n      hash: url.hash,\n      search: url.search,\n      pathname: url.pathname,\n      path: `${url.pathname || ''}${url.search || ''}`,\n      href: url.href\n    };\n\n    if (url.port !== '') {\n      options.port = Number(url.port);\n    }\n\n    if (url.username || url.password) {\n      options.auth = `${url.username}:${url.password}`;\n    }\n\n    return options;\n  }\n}","map":{"version":3,"names":["url","require","channel","addHook","AsyncResource","shimmer","log","startClientCh","finishClientCh","errorClientCh","name","hookFn","http","patch","methodName","wrap","instrumentRequest","request","hasSubscribers","apply","arguments","args","normalizeArgs","e","error","callbackResource","asyncResource","runInAsyncScope","publish","finished","callback","bind","options","req","call","emit","finish","res","eventName","arg","listener","on","inputURL","inputOptions","cb","normalizeOptions","inputOptionsNormalized","normalizeCallback","combineOptions","normalizeHeaders","uri","format","Object","assign","headers","urlToOptions","URL","parse","agent","globalAgent","protocol","hostname","startsWith","slice","host","hash","search","pathname","path","href","port","Number","username","password","auth"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/http/client.js"],"sourcesContent":["'use strict'\n\n/* eslint-disable no-fallthrough */\n\nconst url = require('url')\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('../helpers/instrument')\nconst shimmer = require('../../../datadog-shimmer')\n\nconst log = require('../../../dd-trace/src/log')\n\nconst startClientCh = channel('apm:http:client:request:start')\nconst finishClientCh = channel('apm:http:client:request:finish')\nconst errorClientCh = channel('apm:http:client:request:error')\n\naddHook({ name: 'https' }, hookFn)\n\naddHook({ name: 'http' }, hookFn)\n\nfunction hookFn (http) {\n  patch(http, 'request')\n  patch(http, 'get')\n\n  return http\n}\n\nfunction patch (http, methodName) {\n  shimmer.wrap(http, methodName, instrumentRequest)\n\n  function instrumentRequest (request) {\n    return function () {\n      if (!startClientCh.hasSubscribers) {\n        return request.apply(this, arguments)\n      }\n\n      let args\n\n      try {\n        args = normalizeArgs.apply(null, arguments)\n      } catch (e) {\n        log.error(e)\n        return request.apply(this, arguments)\n      }\n\n      const callbackResource = new AsyncResource('bound-anonymous-fn')\n      const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n      return asyncResource.runInAsyncScope(() => {\n        startClientCh.publish({ args, http })\n\n        let finished = false\n        let callback = args.callback\n\n        if (callback) {\n          callback = callbackResource.bind(callback)\n        }\n\n        const options = args.options\n        const req = request.call(this, options, callback)\n        const emit = req.emit\n\n        const finish = (req, res) => {\n          if (!finished) {\n            finished = true\n            finishClientCh.publish({ req, res })\n          }\n        }\n\n        req.emit = function (eventName, arg) {\n          asyncResource.runInAsyncScope(() => {\n            switch (eventName) {\n              case 'response': {\n                const res = arg\n                const listener = asyncResource.bind(() => finish(req, res))\n                res.on('end', listener)\n                res.on('error', listener)\n                break\n              }\n              case 'connect':\n              case 'upgrade':\n                finish(req, arg)\n                break\n              case 'error':\n              case 'timeout':\n                errorClientCh.publish(arg)\n              case 'abort': // deprecated and replaced by `close` in node 17\n              case 'close':\n                finish(req)\n            }\n          })\n\n          return emit.apply(this, arguments)\n        }\n\n        return req\n      })\n    }\n  }\n\n  function normalizeArgs (inputURL, inputOptions, cb) {\n    inputURL = normalizeOptions(inputURL)\n\n    const [callback, inputOptionsNormalized] = normalizeCallback(inputOptions, cb, inputURL)\n    const options = combineOptions(inputURL, inputOptionsNormalized)\n    normalizeHeaders(options)\n    const uri = url.format(options)\n\n    return { uri, options, callback }\n  }\n\n  function combineOptions (inputURL, inputOptions) {\n    if (typeof inputOptions === 'object') {\n      return Object.assign(inputURL || {}, inputOptions)\n    } else {\n      return inputURL\n    }\n  }\n  function normalizeHeaders (options) {\n    options.headers = options.headers || {}\n  }\n\n  function normalizeCallback (inputOptions, callback, inputURL) {\n    if (typeof inputOptions === 'function') {\n      return [inputOptions, inputURL || {}]\n    } else {\n      return [callback, inputOptions]\n    }\n  }\n\n  function normalizeOptions (inputURL) {\n    if (typeof inputURL === 'string') {\n      try {\n        return urlToOptions(new url.URL(inputURL))\n      } catch (e) {\n        return url.parse(inputURL)\n      }\n    } else if (inputURL instanceof url.URL) {\n      return urlToOptions(inputURL)\n    } else {\n      return inputURL\n    }\n  }\n\n  function urlToOptions (url) {\n    const agent = url.agent || http.globalAgent\n    const options = {\n      protocol: url.protocol || agent.protocol,\n      hostname: typeof url.hostname === 'string' && url.hostname.startsWith('[')\n        ? url.hostname.slice(1, -1)\n        : url.hostname ||\n          url.host ||\n          'localhost',\n      hash: url.hash,\n      search: url.search,\n      pathname: url.pathname,\n      path: `${url.pathname || ''}${url.search || ''}`,\n      href: url.href\n    }\n    if (url.port !== '') {\n      options.port = Number(url.port)\n    }\n    if (url.username || url.password) {\n      options.auth = `${url.username}:${url.password}`\n    }\n    return options\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}