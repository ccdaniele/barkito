{"ast":null,"code":"'use strict';\n\nconst fs = require('fs');\n\nconst log = require('../log');\n\nconst RuleManager = require('./rule_manager');\n\nconst {\n  incomingHttpRequestStart,\n  incomingHttpRequestEnd\n} = require('./gateway/channels');\n\nconst Gateway = require('./gateway/engine');\n\nconst addresses = require('./addresses');\n\nconst Reporter = require('./reporter');\n\nconst web = require('../plugins/util/web');\n\nfunction enable(config) {\n  try {\n    // TODO: enable dc_blocking: config.appsec.blocking === true\n    let rules = fs.readFileSync(config.appsec.rules);\n    rules = JSON.parse(rules);\n    RuleManager.applyRules(rules, config.appsec);\n  } catch (err) {\n    log.error('Unable to start AppSec');\n    log.error(err); // abort AppSec start\n\n    RuleManager.clearAllRules();\n    return;\n  }\n\n  Reporter.setRateLimit(config.appsec.rateLimit);\n  incomingHttpRequestStart.subscribe(incomingHttpStartTranslator);\n  incomingHttpRequestEnd.subscribe(incomingHttpEndTranslator); // add fields needed for HTTP context reporting\n\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_HEADERS);\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_ENDPOINT);\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_RESPONSE_HEADERS);\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_REMOTE_IP);\n}\n\nfunction incomingHttpStartTranslator(data) {\n  // TODO: get span from datadog-core storage instead\n  const topSpan = web.root(data.req);\n\n  if (topSpan) {\n    topSpan.addTags({\n      '_dd.appsec.enabled': 1,\n      '_dd.runtime_family': 'nodejs'\n    });\n  }\n}\n\nfunction incomingHttpEndTranslator(data) {\n  const store = Gateway.startContext();\n  store.set('req', data.req);\n  store.set('res', data.res);\n  const context = store.get('context');\n  if (!context) return;\n  const requestHeaders = Object.assign({}, data.req.headers);\n  delete requestHeaders.cookie; // TODO: this doesn't support headers sent with res.writeHead()\n\n  const responseHeaders = Object.assign({}, data.res.getHeaders());\n  delete responseHeaders['set-cookie'];\n  const payload = {\n    [addresses.HTTP_INCOMING_URL]: data.req.url,\n    [addresses.HTTP_INCOMING_HEADERS]: requestHeaders,\n    [addresses.HTTP_INCOMING_METHOD]: data.req.method,\n    [addresses.HTTP_INCOMING_REMOTE_IP]: data.req.socket.remoteAddress,\n    [addresses.HTTP_INCOMING_REMOTE_PORT]: data.req.socket.remotePort,\n    [addresses.HTTP_INCOMING_RESPONSE_CODE]: data.res.statusCode,\n    [addresses.HTTP_INCOMING_RESPONSE_HEADERS]: responseHeaders\n  }; // TODO: temporary express instrumentation, will use express plugin later\n\n  if (data.req.body !== undefined && data.req.body !== null) {\n    payload[addresses.HTTP_INCOMING_BODY] = data.req.body;\n  }\n\n  if (data.req.query && typeof data.req.query === 'object') {\n    payload[addresses.HTTP_INCOMING_QUERY] = data.req.query;\n  }\n\n  if (data.req.route && typeof data.req.route.path === 'string') {\n    payload[addresses.HTTP_INCOMING_ENDPOINT] = data.req.route.path;\n  }\n\n  if (data.req.params && typeof data.req.params === 'object') {\n    payload[addresses.HTTP_INCOMING_PARAMS] = data.req.params;\n  }\n\n  if (data.req.cookies && typeof data.req.cookies === 'object') {\n    payload[addresses.HTTP_INCOMING_COOKIES] = {};\n\n    for (const k of Object.keys(data.req.cookies)) {\n      payload[addresses.HTTP_INCOMING_COOKIES][k] = [data.req.cookies[k]];\n    }\n  }\n\n  Gateway.propagate(payload, context);\n  Reporter.finishRequest(data.req, context);\n}\n\nfunction disable() {\n  RuleManager.clearAllRules(); // Channel#unsubscribe() is undefined for non active channels\n\n  if (incomingHttpRequestStart.hasSubscribers) incomingHttpRequestStart.unsubscribe(incomingHttpStartTranslator);\n  if (incomingHttpRequestEnd.hasSubscribers) incomingHttpRequestEnd.unsubscribe(incomingHttpEndTranslator);\n}\n\nmodule.exports = {\n  enable,\n  disable,\n  incomingHttpStartTranslator,\n  incomingHttpEndTranslator\n};","map":{"version":3,"names":["fs","require","log","RuleManager","incomingHttpRequestStart","incomingHttpRequestEnd","Gateway","addresses","Reporter","web","enable","config","rules","readFileSync","appsec","JSON","parse","applyRules","err","error","clearAllRules","setRateLimit","rateLimit","subscribe","incomingHttpStartTranslator","incomingHttpEndTranslator","manager","add","HTTP_INCOMING_HEADERS","HTTP_INCOMING_ENDPOINT","HTTP_INCOMING_RESPONSE_HEADERS","HTTP_INCOMING_REMOTE_IP","data","topSpan","root","req","addTags","store","startContext","set","res","context","get","requestHeaders","Object","assign","headers","cookie","responseHeaders","getHeaders","payload","HTTP_INCOMING_URL","url","HTTP_INCOMING_METHOD","method","socket","remoteAddress","HTTP_INCOMING_REMOTE_PORT","remotePort","HTTP_INCOMING_RESPONSE_CODE","statusCode","body","undefined","HTTP_INCOMING_BODY","query","HTTP_INCOMING_QUERY","route","path","params","HTTP_INCOMING_PARAMS","cookies","HTTP_INCOMING_COOKIES","k","keys","propagate","finishRequest","disable","hasSubscribers","unsubscribe","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/appsec/index.js"],"sourcesContent":["'use strict'\n\nconst fs = require('fs')\nconst log = require('../log')\nconst RuleManager = require('./rule_manager')\nconst { incomingHttpRequestStart, incomingHttpRequestEnd } = require('./gateway/channels')\nconst Gateway = require('./gateway/engine')\nconst addresses = require('./addresses')\nconst Reporter = require('./reporter')\nconst web = require('../plugins/util/web')\n\nfunction enable (config) {\n  try {\n    // TODO: enable dc_blocking: config.appsec.blocking === true\n\n    let rules = fs.readFileSync(config.appsec.rules)\n    rules = JSON.parse(rules)\n\n    RuleManager.applyRules(rules, config.appsec)\n  } catch (err) {\n    log.error('Unable to start AppSec')\n    log.error(err)\n\n    // abort AppSec start\n    RuleManager.clearAllRules()\n    return\n  }\n\n  Reporter.setRateLimit(config.appsec.rateLimit)\n\n  incomingHttpRequestStart.subscribe(incomingHttpStartTranslator)\n  incomingHttpRequestEnd.subscribe(incomingHttpEndTranslator)\n\n  // add fields needed for HTTP context reporting\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_HEADERS)\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_ENDPOINT)\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_RESPONSE_HEADERS)\n  Gateway.manager.addresses.add(addresses.HTTP_INCOMING_REMOTE_IP)\n}\n\nfunction incomingHttpStartTranslator (data) {\n  // TODO: get span from datadog-core storage instead\n  const topSpan = web.root(data.req)\n  if (topSpan) {\n    topSpan.addTags({\n      '_dd.appsec.enabled': 1,\n      '_dd.runtime_family': 'nodejs'\n    })\n  }\n}\n\nfunction incomingHttpEndTranslator (data) {\n  const store = Gateway.startContext()\n\n  store.set('req', data.req)\n  store.set('res', data.res)\n\n  const context = store.get('context')\n\n  if (!context) return\n\n  const requestHeaders = Object.assign({}, data.req.headers)\n  delete requestHeaders.cookie\n\n  // TODO: this doesn't support headers sent with res.writeHead()\n  const responseHeaders = Object.assign({}, data.res.getHeaders())\n  delete responseHeaders['set-cookie']\n\n  const payload = {\n    [addresses.HTTP_INCOMING_URL]: data.req.url,\n    [addresses.HTTP_INCOMING_HEADERS]: requestHeaders,\n    [addresses.HTTP_INCOMING_METHOD]: data.req.method,\n    [addresses.HTTP_INCOMING_REMOTE_IP]: data.req.socket.remoteAddress,\n    [addresses.HTTP_INCOMING_REMOTE_PORT]: data.req.socket.remotePort,\n    [addresses.HTTP_INCOMING_RESPONSE_CODE]: data.res.statusCode,\n    [addresses.HTTP_INCOMING_RESPONSE_HEADERS]: responseHeaders\n  }\n\n  // TODO: temporary express instrumentation, will use express plugin later\n  if (data.req.body !== undefined && data.req.body !== null) {\n    payload[addresses.HTTP_INCOMING_BODY] = data.req.body\n  }\n\n  if (data.req.query && typeof data.req.query === 'object') {\n    payload[addresses.HTTP_INCOMING_QUERY] = data.req.query\n  }\n\n  if (data.req.route && typeof data.req.route.path === 'string') {\n    payload[addresses.HTTP_INCOMING_ENDPOINT] = data.req.route.path\n  }\n\n  if (data.req.params && typeof data.req.params === 'object') {\n    payload[addresses.HTTP_INCOMING_PARAMS] = data.req.params\n  }\n\n  if (data.req.cookies && typeof data.req.cookies === 'object') {\n    payload[addresses.HTTP_INCOMING_COOKIES] = {}\n\n    for (const k of Object.keys(data.req.cookies)) {\n      payload[addresses.HTTP_INCOMING_COOKIES][k] = [ data.req.cookies[k] ]\n    }\n  }\n\n  Gateway.propagate(payload, context)\n\n  Reporter.finishRequest(data.req, context)\n}\n\nfunction disable () {\n  RuleManager.clearAllRules()\n\n  // Channel#unsubscribe() is undefined for non active channels\n  if (incomingHttpRequestStart.hasSubscribers) incomingHttpRequestStart.unsubscribe(incomingHttpStartTranslator)\n  if (incomingHttpRequestEnd.hasSubscribers) incomingHttpRequestEnd.unsubscribe(incomingHttpEndTranslator)\n}\n\nmodule.exports = {\n  enable,\n  disable,\n  incomingHttpStartTranslator,\n  incomingHttpEndTranslator\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}