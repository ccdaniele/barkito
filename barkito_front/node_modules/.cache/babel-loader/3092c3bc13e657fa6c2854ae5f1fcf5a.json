{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst requestStartCh = channel('apm:google-cloud-pubsub:request:start');\nconst requestFinishCh = channel('apm:google-cloud-pubsub:request:finish');\nconst requestErrorCh = channel('apm:google-cloud-pubsub:request:error');\nconst receiveStartCh = channel(`apm:google-cloud-pubsub:receive:start`);\nconst receiveFinishCh = channel('apm:google-cloud-pubsub:receive:finish');\nconst receiveErrorCh = channel('apm:google-cloud-pubsub:receive:error');\naddHook({\n  name: '@google-cloud/pubsub',\n  versions: ['>=1.2']\n}, obj => {\n  const PubSub = obj.PubSub;\n  const Subscription = obj.Subscription;\n  shimmer.wrap(PubSub.prototype, 'request', request => function () {\n    let cfg = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n      reqOpts: {}\n    };\n    let cb = arguments.length > 1 ? arguments[1] : undefined;\n\n    if (!requestStartCh.hasSubscribers) {\n      return request.apply(this, arguments);\n    }\n\n    const innerAsyncResource = new AsyncResource('bound-anonymous-fn');\n    const outerAsyncResource = new AsyncResource('bound-anonymous-fn');\n    return innerAsyncResource.runInAsyncScope(() => {\n      let messages = [];\n\n      if (cfg.reqOpts && cfg.method === 'publish') {\n        messages = cfg.reqOpts.messages;\n      }\n\n      requestStartCh.publish({\n        cfg,\n        projectId: this.projectId,\n        messages\n      });\n      cb = outerAsyncResource.bind(cb);\n\n      const fn = () => {\n        arguments[1] = innerAsyncResource.bind(function (error) {\n          if (error) {\n            requestErrorCh.publish(error);\n          }\n\n          requestFinishCh.publish(undefined);\n          return cb.apply(this, arguments);\n        });\n        return request.apply(this, arguments);\n      };\n\n      try {\n        return fn.apply(this, arguments);\n      } catch (e) {\n        requestErrorCh.publish(e);\n        throw e;\n      }\n    });\n  });\n  shimmer.wrap(Subscription.prototype, 'emit', emit => function (eventName, message) {\n    if (eventName !== 'message' || !message) return emit.apply(this, arguments);\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      try {\n        return emit.apply(this, arguments);\n      } catch (err) {\n        receiveErrorCh.publish({\n          err,\n          message\n        });\n        throw err;\n      }\n    });\n  });\n  return obj;\n});\naddHook({\n  name: '@google-cloud/pubsub',\n  versions: ['>=1.2'],\n  file: 'build/src/lease-manager.js'\n}, obj => {\n  const LeaseManager = obj.LeaseManager;\n  shimmer.wrap(LeaseManager.prototype, '_dispense', dispense => function (message) {\n    if (receiveStartCh.hasSubscribers) {\n      receiveStartCh.publish({\n        message\n      });\n    }\n\n    return dispense.apply(this, arguments);\n  });\n  shimmer.wrap(LeaseManager.prototype, 'remove', remove => function (message) {\n    receiveFinishCh.publish({\n      message\n    });\n    return remove.apply(this, arguments);\n  });\n  shimmer.wrap(LeaseManager.prototype, 'clear', clear => function () {\n    for (const message of this._messages) {\n      receiveFinishCh.publish({\n        message\n      });\n    }\n\n    return clear.apply(this, arguments);\n  });\n  return obj;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","requestStartCh","requestFinishCh","requestErrorCh","receiveStartCh","receiveFinishCh","receiveErrorCh","name","versions","obj","PubSub","Subscription","wrap","prototype","request","cfg","reqOpts","cb","hasSubscribers","apply","arguments","innerAsyncResource","outerAsyncResource","runInAsyncScope","messages","method","publish","projectId","bind","fn","error","undefined","e","emit","eventName","message","asyncResource","err","file","LeaseManager","dispense","remove","clear","_messages"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/google-cloud-pubsub.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst requestStartCh = channel('apm:google-cloud-pubsub:request:start')\nconst requestFinishCh = channel('apm:google-cloud-pubsub:request:finish')\nconst requestErrorCh = channel('apm:google-cloud-pubsub:request:error')\n\nconst receiveStartCh = channel(`apm:google-cloud-pubsub:receive:start`)\nconst receiveFinishCh = channel('apm:google-cloud-pubsub:receive:finish')\nconst receiveErrorCh = channel('apm:google-cloud-pubsub:receive:error')\n\naddHook({ name: '@google-cloud/pubsub', versions: ['>=1.2'] }, (obj) => {\n  const PubSub = obj.PubSub\n  const Subscription = obj.Subscription\n\n  shimmer.wrap(PubSub.prototype, 'request', request => function (cfg = { reqOpts: {} }, cb) {\n    if (!requestStartCh.hasSubscribers) {\n      return request.apply(this, arguments)\n    }\n\n    const innerAsyncResource = new AsyncResource('bound-anonymous-fn')\n    const outerAsyncResource = new AsyncResource('bound-anonymous-fn')\n\n    return innerAsyncResource.runInAsyncScope(() => {\n      let messages = []\n      if (cfg.reqOpts && cfg.method === 'publish') {\n        messages = cfg.reqOpts.messages\n      }\n\n      requestStartCh.publish({ cfg, projectId: this.projectId, messages })\n      cb = outerAsyncResource.bind(cb)\n\n      const fn = () => {\n        arguments[1] = innerAsyncResource.bind(function (error) {\n          if (error) {\n            requestErrorCh.publish(error)\n          }\n          requestFinishCh.publish(undefined)\n          return cb.apply(this, arguments)\n        })\n        return request.apply(this, arguments)\n      }\n\n      try {\n        return fn.apply(this, arguments)\n      } catch (e) {\n        requestErrorCh.publish(e)\n        throw e\n      }\n    })\n  })\n\n  shimmer.wrap(Subscription.prototype, 'emit', emit => function (eventName, message) {\n    if (eventName !== 'message' || !message) return emit.apply(this, arguments)\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n    return asyncResource.runInAsyncScope(() => {\n      try {\n        return emit.apply(this, arguments)\n      } catch (err) {\n        receiveErrorCh.publish({ err, message })\n        throw err\n      }\n    })\n  })\n\n  return obj\n})\n\naddHook({ name: '@google-cloud/pubsub', versions: ['>=1.2'], file: 'build/src/lease-manager.js' }, (obj) => {\n  const LeaseManager = obj.LeaseManager\n\n  shimmer.wrap(LeaseManager.prototype, '_dispense', dispense => function (message) {\n    if (receiveStartCh.hasSubscribers) {\n      receiveStartCh.publish({ message })\n    }\n    return dispense.apply(this, arguments)\n  })\n\n  shimmer.wrap(LeaseManager.prototype, 'remove', remove => function (message) {\n    receiveFinishCh.publish({ message })\n    return remove.apply(this, arguments)\n  })\n\n  shimmer.wrap(LeaseManager.prototype, 'clear', clear => function () {\n    for (const message of this._messages) {\n      receiveFinishCh.publish({ message })\n    }\n    return clear.apply(this, arguments)\n  })\n\n  return obj\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}