{"ast":null,"code":"'use strict';\n\nconst path = require('path');\n\nconst parse = require('module-details-from-path');\n\nconst requirePackageJson = require('../require-package-json');\n\nconst {\n  sendData\n} = require('./send-data');\n\nconst dc = require('diagnostics_channel');\n\nconst {\n  fileURLToPath\n} = require('url');\n\nconst savedDependencies = [];\nconst detectedDependencyNames = new Set();\nconst FILE_URI_START = `file://`;\nconst moduleLoadStartChannel = dc.channel('dd-trace:moduleLoadStart');\nlet immediate, config, application, host;\n\nfunction waitAndSend(config, application, host) {\n  if (!immediate) {\n    immediate = setImmediate(() => {\n      immediate = null;\n\n      if (savedDependencies.length > 0) {\n        const dependencies = savedDependencies.splice(0, 1000);\n        sendData(config, application, host, 'app-dependencies-loaded', {\n          dependencies\n        });\n\n        if (savedDependencies.length > 0) {\n          waitAndSend(config, application, host);\n        }\n      }\n    });\n    immediate.unref();\n  }\n}\n\nfunction onModuleLoad(data) {\n  if (data) {\n    let filename = data.filename;\n\n    if (filename && filename.startsWith(FILE_URI_START)) {\n      try {\n        filename = fileURLToPath(filename);\n      } catch (e) {// cannot transform url to path\n      }\n    }\n\n    const parseResult = filename && parse(filename);\n    const request = data.request || parseResult && parseResult.name;\n\n    if (filename && request && isDependency(filename, request) && !detectedDependencyNames.has(request)) {\n      detectedDependencyNames.add(request);\n\n      if (parseResult) {\n        const {\n          name,\n          basedir\n        } = parseResult;\n\n        if (basedir) {\n          try {\n            const {\n              version\n            } = requirePackageJson(basedir, module);\n            savedDependencies.push({\n              name,\n              version\n            });\n            waitAndSend(config, application, host);\n          } catch (e) {// can not read the package.json, do nothing\n          }\n        }\n      }\n    }\n  }\n}\n\nfunction start(_config, _application, _host) {\n  config = _config;\n  application = _application;\n  host = _host;\n  moduleLoadStartChannel.subscribe(onModuleLoad);\n}\n\nfunction isDependency(filename, request) {\n  return request.indexOf(`.${path.sep}`) !== 0 && request.indexOf(path.sep) !== 0;\n}\n\nfunction stop() {\n  config = null;\n  application = null;\n  host = null;\n  detectedDependencyNames.clear();\n  savedDependencies.splice(0, savedDependencies.length);\n\n  if (moduleLoadStartChannel.hasSubscribers) {\n    moduleLoadStartChannel.unsubscribe(onModuleLoad);\n  }\n}\n\nmodule.exports = {\n  start,\n  stop\n};","map":{"version":3,"names":["path","require","parse","requirePackageJson","sendData","dc","fileURLToPath","savedDependencies","detectedDependencyNames","Set","FILE_URI_START","moduleLoadStartChannel","channel","immediate","config","application","host","waitAndSend","setImmediate","length","dependencies","splice","unref","onModuleLoad","data","filename","startsWith","e","parseResult","request","name","isDependency","has","add","basedir","version","module","push","start","_config","_application","_host","subscribe","indexOf","sep","stop","clear","hasSubscribers","unsubscribe","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/telemetry/dependencies.js"],"sourcesContent":["'use strict'\n\nconst path = require('path')\nconst parse = require('module-details-from-path')\nconst requirePackageJson = require('../require-package-json')\nconst { sendData } = require('./send-data')\nconst dc = require('diagnostics_channel')\nconst { fileURLToPath } = require('url')\n\nconst savedDependencies = []\nconst detectedDependencyNames = new Set()\nconst FILE_URI_START = `file://`\nconst moduleLoadStartChannel = dc.channel('dd-trace:moduleLoadStart')\n\nlet immediate, config, application, host\n\nfunction waitAndSend (config, application, host) {\n  if (!immediate) {\n    immediate = setImmediate(() => {\n      immediate = null\n      if (savedDependencies.length > 0) {\n        const dependencies = savedDependencies.splice(0, 1000)\n        sendData(config, application, host, 'app-dependencies-loaded', { dependencies })\n        if (savedDependencies.length > 0) {\n          waitAndSend(config, application, host)\n        }\n      }\n    })\n    immediate.unref()\n  }\n}\n\nfunction onModuleLoad (data) {\n  if (data) {\n    let filename = data.filename\n    if (filename && filename.startsWith(FILE_URI_START)) {\n      try {\n        filename = fileURLToPath(filename)\n      } catch (e) {\n        // cannot transform url to path\n      }\n    }\n    const parseResult = filename && parse(filename)\n    const request = data.request || (parseResult && parseResult.name)\n    if (filename && request && isDependency(filename, request) && !detectedDependencyNames.has(request)) {\n      detectedDependencyNames.add(request)\n      if (parseResult) {\n        const { name, basedir } = parseResult\n        if (basedir) {\n          try {\n            const { version } = requirePackageJson(basedir, module)\n            savedDependencies.push({ name, version })\n            waitAndSend(config, application, host)\n          } catch (e) {\n            // can not read the package.json, do nothing\n          }\n        }\n      }\n    }\n  }\n}\nfunction start (_config, _application, _host) {\n  config = _config\n  application = _application\n  host = _host\n  moduleLoadStartChannel.subscribe(onModuleLoad)\n}\n\nfunction isDependency (filename, request) {\n  return request.indexOf(`.${path.sep}`) !== 0 && request.indexOf(path.sep) !== 0\n}\n\nfunction stop () {\n  config = null\n  application = null\n  host = null\n  detectedDependencyNames.clear()\n  savedDependencies.splice(0, savedDependencies.length)\n  if (moduleLoadStartChannel.hasSubscribers) {\n    moduleLoadStartChannel.unsubscribe(onModuleLoad)\n  }\n}\nmodule.exports = { start, stop }\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}