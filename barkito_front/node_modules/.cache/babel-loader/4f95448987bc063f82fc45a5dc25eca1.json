{"ast":null,"code":"'use strict';\n\nconst {\n  EventEmitter\n} = require('events');\n\nconst {\n  Config\n} = require('./config');\n\nfunction maybeSourceMap(sourceMap) {\n  if (!sourceMap) return;\n\n  const {\n    SourceMapper\n  } = require('@datadog/pprof');\n\n  return SourceMapper.create([process.cwd()]);\n}\n\nclass Profiler extends EventEmitter {\n  constructor() {\n    super();\n    this._enabled = false;\n    this._logger = undefined;\n    this._config = undefined;\n    this._timer = undefined;\n    this._lastStart = undefined;\n  }\n\n  start(options) {\n    this._start(options).catch(() => {});\n\n    return this;\n  }\n\n  async _start(options) {\n    if (this._enabled) return;\n    const config = this._config = new Config(options);\n    if (!config.enabled) return;\n    this._logger = config.logger;\n    this._enabled = true;\n\n    try {\n      const mapper = await maybeSourceMap(config.sourceMap);\n\n      for (const profiler of config.profilers) {\n        // TODO: move this out of Profiler when restoring sourcemap support\n        profiler.start({\n          mapper\n        });\n\n        this._logger.debug(`Started ${profiler.type} profiler`);\n      }\n\n      this._capture(config.flushInterval);\n    } catch (e) {\n      this._logger.error(e);\n\n      this.stop();\n    }\n  }\n\n  stop() {\n    if (!this._enabled) return;\n    this._enabled = false;\n\n    for (const profiler of this._config.profilers) {\n      profiler.stop();\n\n      this._logger.debug(`Stopped ${profiler.type} profiler`);\n    }\n\n    clearTimeout(this._timer);\n    this._timer = undefined;\n    return this;\n  }\n\n  _capture(timeout) {\n    if (!this._enabled) return;\n    this._lastStart = new Date();\n\n    if (!this._timer || timeout !== this._config.flushInterval) {\n      this._timer = setTimeout(() => this._collect(), timeout);\n\n      this._timer.unref();\n    } else {\n      this._timer.refresh();\n    }\n  }\n\n  async _collect() {\n    const start = this._lastStart;\n    const end = new Date();\n    const profiles = {};\n\n    try {\n      for (const profiler of this._config.profilers) {\n        const profile = profiler.profile();\n        if (!profile) continue;\n        profiles[profiler.type] = await profiler.encode(profile);\n\n        this._logger.debug(() => {\n          const profileJson = JSON.stringify(profile, (key, value) => {\n            return typeof value === 'bigint' ? value.toString() : value;\n          });\n          return `Collected ${profiler.type} profile: ` + profileJson;\n        });\n      }\n\n      this._capture(this._config.flushInterval);\n\n      await this._submit(profiles, start, end);\n\n      this._logger.debug('Submitted profiles');\n    } catch (err) {\n      this._logger.error(err);\n\n      this.stop();\n    }\n  }\n\n  _submit(profiles, start, end) {\n    if (!Object.keys(profiles).length) {\n      return Promise.reject(new Error('No profiles to submit'));\n    }\n\n    const {\n      tags\n    } = this._config;\n    const tasks = [];\n\n    for (const exporter of this._config.exporters) {\n      const task = exporter.export({\n        profiles,\n        start,\n        end,\n        tags\n      }).catch(err => this._logger.error(err));\n      tasks.push(task);\n    }\n\n    return Promise.all(tasks);\n  }\n\n}\n\nmodule.exports = {\n  Profiler\n};","map":{"version":3,"names":["EventEmitter","require","Config","maybeSourceMap","sourceMap","SourceMapper","create","process","cwd","Profiler","constructor","_enabled","_logger","undefined","_config","_timer","_lastStart","start","options","_start","catch","config","enabled","logger","mapper","profiler","profilers","debug","type","_capture","flushInterval","e","error","stop","clearTimeout","timeout","Date","setTimeout","_collect","unref","refresh","end","profiles","profile","encode","profileJson","JSON","stringify","key","value","toString","_submit","err","Object","keys","length","Promise","reject","Error","tags","tasks","exporter","exporters","task","export","push","all","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/profiling/profiler.js"],"sourcesContent":["'use strict'\n\nconst { EventEmitter } = require('events')\nconst { Config } = require('./config')\n\nfunction maybeSourceMap (sourceMap) {\n  if (!sourceMap) return\n\n  const { SourceMapper } = require('@datadog/pprof')\n  return SourceMapper.create([\n    process.cwd()\n  ])\n}\n\nclass Profiler extends EventEmitter {\n  constructor () {\n    super()\n    this._enabled = false\n    this._logger = undefined\n    this._config = undefined\n    this._timer = undefined\n    this._lastStart = undefined\n  }\n\n  start (options) {\n    this._start(options).catch(() => {})\n    return this\n  }\n\n  async _start (options) {\n    if (this._enabled) return\n\n    const config = this._config = new Config(options)\n    if (!config.enabled) return\n\n    this._logger = config.logger\n    this._enabled = true\n\n    try {\n      const mapper = await maybeSourceMap(config.sourceMap)\n\n      for (const profiler of config.profilers) {\n        // TODO: move this out of Profiler when restoring sourcemap support\n        profiler.start({ mapper })\n        this._logger.debug(`Started ${profiler.type} profiler`)\n      }\n\n      this._capture(config.flushInterval)\n    } catch (e) {\n      this._logger.error(e)\n      this.stop()\n    }\n  }\n\n  stop () {\n    if (!this._enabled) return\n\n    this._enabled = false\n\n    for (const profiler of this._config.profilers) {\n      profiler.stop()\n      this._logger.debug(`Stopped ${profiler.type} profiler`)\n    }\n\n    clearTimeout(this._timer)\n    this._timer = undefined\n\n    return this\n  }\n\n  _capture (timeout) {\n    if (!this._enabled) return\n    this._lastStart = new Date()\n\n    if (!this._timer || timeout !== this._config.flushInterval) {\n      this._timer = setTimeout(() => this._collect(), timeout)\n      this._timer.unref()\n    } else {\n      this._timer.refresh()\n    }\n  }\n\n  async _collect () {\n    const start = this._lastStart\n    const end = new Date()\n    const profiles = {}\n\n    try {\n      for (const profiler of this._config.profilers) {\n        const profile = profiler.profile()\n        if (!profile) continue\n\n        profiles[profiler.type] = await profiler.encode(profile)\n        this._logger.debug(() => {\n          const profileJson = JSON.stringify(profile, (key, value) => {\n            return typeof value === 'bigint' ? value.toString() : value\n          })\n          return `Collected ${profiler.type} profile: ` + profileJson\n        })\n      }\n\n      this._capture(this._config.flushInterval)\n      await this._submit(profiles, start, end)\n      this._logger.debug('Submitted profiles')\n    } catch (err) {\n      this._logger.error(err)\n      this.stop()\n    }\n  }\n\n  _submit (profiles, start, end) {\n    if (!Object.keys(profiles).length) {\n      return Promise.reject(new Error('No profiles to submit'))\n    }\n    const { tags } = this._config\n    const tasks = []\n\n    for (const exporter of this._config.exporters) {\n      const task = exporter.export({ profiles, start, end, tags })\n        .catch(err => this._logger.error(err))\n\n      tasks.push(task)\n    }\n\n    return Promise.all(tasks)\n  }\n}\n\nmodule.exports = { Profiler }\n"],"mappings":"AAAA;;AAEA,MAAM;EAAEA;AAAF,IAAmBC,OAAO,CAAC,QAAD,CAAhC;;AACA,MAAM;EAAEC;AAAF,IAAaD,OAAO,CAAC,UAAD,CAA1B;;AAEA,SAASE,cAAT,CAAyBC,SAAzB,EAAoC;EAClC,IAAI,CAACA,SAAL,EAAgB;;EAEhB,MAAM;IAAEC;EAAF,IAAmBJ,OAAO,CAAC,gBAAD,CAAhC;;EACA,OAAOI,YAAY,CAACC,MAAb,CAAoB,CACzBC,OAAO,CAACC,GAAR,EADyB,CAApB,CAAP;AAGD;;AAED,MAAMC,QAAN,SAAuBT,YAAvB,CAAoC;EAClCU,WAAW,GAAI;IACb;IACA,KAAKC,QAAL,GAAgB,KAAhB;IACA,KAAKC,OAAL,GAAeC,SAAf;IACA,KAAKC,OAAL,GAAeD,SAAf;IACA,KAAKE,MAAL,GAAcF,SAAd;IACA,KAAKG,UAAL,GAAkBH,SAAlB;EACD;;EAEDI,KAAK,CAAEC,OAAF,EAAW;IACd,KAAKC,MAAL,CAAYD,OAAZ,EAAqBE,KAArB,CAA2B,MAAM,CAAE,CAAnC;;IACA,OAAO,IAAP;EACD;;EAEW,MAAND,MAAM,CAAED,OAAF,EAAW;IACrB,IAAI,KAAKP,QAAT,EAAmB;IAEnB,MAAMU,MAAM,GAAG,KAAKP,OAAL,GAAe,IAAIZ,MAAJ,CAAWgB,OAAX,CAA9B;IACA,IAAI,CAACG,MAAM,CAACC,OAAZ,EAAqB;IAErB,KAAKV,OAAL,GAAeS,MAAM,CAACE,MAAtB;IACA,KAAKZ,QAAL,GAAgB,IAAhB;;IAEA,IAAI;MACF,MAAMa,MAAM,GAAG,MAAMrB,cAAc,CAACkB,MAAM,CAACjB,SAAR,CAAnC;;MAEA,KAAK,MAAMqB,QAAX,IAAuBJ,MAAM,CAACK,SAA9B,EAAyC;QACvC;QACAD,QAAQ,CAACR,KAAT,CAAe;UAAEO;QAAF,CAAf;;QACA,KAAKZ,OAAL,CAAae,KAAb,CAAoB,WAAUF,QAAQ,CAACG,IAAK,WAA5C;MACD;;MAED,KAAKC,QAAL,CAAcR,MAAM,CAACS,aAArB;IACD,CAVD,CAUE,OAAOC,CAAP,EAAU;MACV,KAAKnB,OAAL,CAAaoB,KAAb,CAAmBD,CAAnB;;MACA,KAAKE,IAAL;IACD;EACF;;EAEDA,IAAI,GAAI;IACN,IAAI,CAAC,KAAKtB,QAAV,EAAoB;IAEpB,KAAKA,QAAL,GAAgB,KAAhB;;IAEA,KAAK,MAAMc,QAAX,IAAuB,KAAKX,OAAL,CAAaY,SAApC,EAA+C;MAC7CD,QAAQ,CAACQ,IAAT;;MACA,KAAKrB,OAAL,CAAae,KAAb,CAAoB,WAAUF,QAAQ,CAACG,IAAK,WAA5C;IACD;;IAEDM,YAAY,CAAC,KAAKnB,MAAN,CAAZ;IACA,KAAKA,MAAL,GAAcF,SAAd;IAEA,OAAO,IAAP;EACD;;EAEDgB,QAAQ,CAAEM,OAAF,EAAW;IACjB,IAAI,CAAC,KAAKxB,QAAV,EAAoB;IACpB,KAAKK,UAAL,GAAkB,IAAIoB,IAAJ,EAAlB;;IAEA,IAAI,CAAC,KAAKrB,MAAN,IAAgBoB,OAAO,KAAK,KAAKrB,OAAL,CAAagB,aAA7C,EAA4D;MAC1D,KAAKf,MAAL,GAAcsB,UAAU,CAAC,MAAM,KAAKC,QAAL,EAAP,EAAwBH,OAAxB,CAAxB;;MACA,KAAKpB,MAAL,CAAYwB,KAAZ;IACD,CAHD,MAGO;MACL,KAAKxB,MAAL,CAAYyB,OAAZ;IACD;EACF;;EAEa,MAARF,QAAQ,GAAI;IAChB,MAAMrB,KAAK,GAAG,KAAKD,UAAnB;IACA,MAAMyB,GAAG,GAAG,IAAIL,IAAJ,EAAZ;IACA,MAAMM,QAAQ,GAAG,EAAjB;;IAEA,IAAI;MACF,KAAK,MAAMjB,QAAX,IAAuB,KAAKX,OAAL,CAAaY,SAApC,EAA+C;QAC7C,MAAMiB,OAAO,GAAGlB,QAAQ,CAACkB,OAAT,EAAhB;QACA,IAAI,CAACA,OAAL,EAAc;QAEdD,QAAQ,CAACjB,QAAQ,CAACG,IAAV,CAAR,GAA0B,MAAMH,QAAQ,CAACmB,MAAT,CAAgBD,OAAhB,CAAhC;;QACA,KAAK/B,OAAL,CAAae,KAAb,CAAmB,MAAM;UACvB,MAAMkB,WAAW,GAAGC,IAAI,CAACC,SAAL,CAAeJ,OAAf,EAAwB,CAACK,GAAD,EAAMC,KAAN,KAAgB;YAC1D,OAAO,OAAOA,KAAP,KAAiB,QAAjB,GAA4BA,KAAK,CAACC,QAAN,EAA5B,GAA+CD,KAAtD;UACD,CAFmB,CAApB;UAGA,OAAQ,aAAYxB,QAAQ,CAACG,IAAK,YAA3B,GAAyCiB,WAAhD;QACD,CALD;MAMD;;MAED,KAAKhB,QAAL,CAAc,KAAKf,OAAL,CAAagB,aAA3B;;MACA,MAAM,KAAKqB,OAAL,CAAaT,QAAb,EAAuBzB,KAAvB,EAA8BwB,GAA9B,CAAN;;MACA,KAAK7B,OAAL,CAAae,KAAb,CAAmB,oBAAnB;IACD,CAjBD,CAiBE,OAAOyB,GAAP,EAAY;MACZ,KAAKxC,OAAL,CAAaoB,KAAb,CAAmBoB,GAAnB;;MACA,KAAKnB,IAAL;IACD;EACF;;EAEDkB,OAAO,CAAET,QAAF,EAAYzB,KAAZ,EAAmBwB,GAAnB,EAAwB;IAC7B,IAAI,CAACY,MAAM,CAACC,IAAP,CAAYZ,QAAZ,EAAsBa,MAA3B,EAAmC;MACjC,OAAOC,OAAO,CAACC,MAAR,CAAe,IAAIC,KAAJ,CAAU,uBAAV,CAAf,CAAP;IACD;;IACD,MAAM;MAAEC;IAAF,IAAW,KAAK7C,OAAtB;IACA,MAAM8C,KAAK,GAAG,EAAd;;IAEA,KAAK,MAAMC,QAAX,IAAuB,KAAK/C,OAAL,CAAagD,SAApC,EAA+C;MAC7C,MAAMC,IAAI,GAAGF,QAAQ,CAACG,MAAT,CAAgB;QAAEtB,QAAF;QAAYzB,KAAZ;QAAmBwB,GAAnB;QAAwBkB;MAAxB,CAAhB,EACVvC,KADU,CACJgC,GAAG,IAAI,KAAKxC,OAAL,CAAaoB,KAAb,CAAmBoB,GAAnB,CADH,CAAb;MAGAQ,KAAK,CAACK,IAAN,CAAWF,IAAX;IACD;;IAED,OAAOP,OAAO,CAACU,GAAR,CAAYN,KAAZ,CAAP;EACD;;AA/GiC;;AAkHpCO,MAAM,CAACC,OAAP,GAAiB;EAAE3D;AAAF,CAAjB"},"metadata":{},"sourceType":"script"}