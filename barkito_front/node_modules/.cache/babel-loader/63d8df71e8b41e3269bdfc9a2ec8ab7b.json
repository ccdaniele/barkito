{"ast":null,"code":"'use strict';\n\nconst web = require('../../dd-trace/src/plugins/util/web');\n\nconst WebPlugin = require('../../datadog-plugin-web/src');\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nconst {\n  storage\n} = require('../../datadog-core');\n\nclass RouterPlugin extends WebPlugin {\n  static get name() {\n    return 'router';\n  }\n\n  constructor() {\n    super(...arguments);\n    this._contexts = new WeakMap();\n    this.addSub(`apm:${this.constructor.name}:middleware:enter`, _ref => {\n      let {\n        req,\n        name,\n        route\n      } = _ref;\n\n      const childOf = this._getActive(req) || this._getStoreSpan();\n\n      if (!childOf) return;\n\n      const span = this._getMiddlewareSpan(name, childOf);\n\n      const context = this._createContext(req, route, childOf);\n\n      if (childOf !== span) {\n        context.middleware.push(span);\n      }\n\n      this.enter(span);\n      web.patch(req);\n      web.setRoute(req, context.route);\n    });\n    this.addSub(`apm:${this.constructor.name}:middleware:next`, _ref2 => {\n      let {\n        req\n      } = _ref2;\n\n      const context = this._contexts.get(req);\n\n      if (!context) return;\n      context.stack.pop();\n    });\n    this.addSub(`apm:${this.constructor.name}:middleware:exit`, _ref3 => {\n      let {\n        req\n      } = _ref3;\n\n      const context = this._contexts.get(req);\n\n      if (!context || context.middleware.length === 0) return;\n      context.middleware.pop().finish();\n    });\n    this.addSub(`apm:${this.constructor.name}:middleware:error`, _ref4 => {\n      let {\n        req,\n        error\n      } = _ref4;\n      web.addError(req, error);\n      if (!this.config.middleware) return;\n\n      const span = this._getActive(req);\n\n      if (!span) return;\n      span.setTag('error', error);\n    });\n    this.addSub(`apm:http:server:request:finish`, _ref5 => {\n      let {\n        req\n      } = _ref5;\n\n      const context = this._contexts.get(req);\n\n      if (!context) return;\n      let span;\n\n      while (span = context.middleware.pop()) {\n        span.finish();\n      }\n    });\n  }\n\n  _getActive(req) {\n    const context = this._contexts.get(req);\n\n    if (!context) return;\n    if (context.middleware.length === 0) return context.span;\n    return context.middleware[context.middleware.length - 1];\n  }\n\n  _getStoreSpan() {\n    const store = storage.getStore();\n    return store && store.span;\n  }\n\n  _getMiddlewareSpan(name, childOf) {\n    if (this.config.middleware === false) {\n      return childOf;\n    }\n\n    const span = this.tracer.startSpan(`${this.constructor.name}.middleware`, {\n      childOf,\n      tags: {\n        'resource.name': name || '<anonymous>'\n      }\n    });\n    analyticsSampler.sample(span, this.config.measured);\n    return span;\n  }\n\n  _createContext(req, route, span) {\n    let context = this._contexts.get(req);\n\n    if (!route || route === '/' || route === '*') {\n      route = '';\n    }\n\n    if (context) {\n      context.stack.push(route);\n      route = context.stack.join(''); // Longer route is more likely to be the actual route handler route.\n\n      if (route.length > context.route.length) {\n        context.route = route;\n      }\n    } else {\n      context = {\n        span,\n        stack: [route],\n        route,\n        middleware: []\n      };\n\n      this._contexts.set(req, context);\n    }\n\n    return context;\n  }\n\n}\n\nmodule.exports = RouterPlugin;","map":{"version":3,"names":["web","require","WebPlugin","analyticsSampler","storage","RouterPlugin","name","constructor","_contexts","WeakMap","addSub","req","route","childOf","_getActive","_getStoreSpan","span","_getMiddlewareSpan","context","_createContext","middleware","push","enter","patch","setRoute","get","stack","pop","length","finish","error","addError","config","setTag","store","getStore","tracer","startSpan","tags","sample","measured","join","set","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-router/src/index.js"],"sourcesContent":["'use strict'\n\nconst web = require('../../dd-trace/src/plugins/util/web')\nconst WebPlugin = require('../../datadog-plugin-web/src')\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\nconst { storage } = require('../../datadog-core')\n\nclass RouterPlugin extends WebPlugin {\n  static get name () {\n    return 'router'\n  }\n\n  constructor (...args) {\n    super(...args)\n\n    this._contexts = new WeakMap()\n\n    this.addSub(`apm:${this.constructor.name}:middleware:enter`, ({ req, name, route }) => {\n      const childOf = this._getActive(req) || this._getStoreSpan()\n\n      if (!childOf) return\n\n      const span = this._getMiddlewareSpan(name, childOf)\n      const context = this._createContext(req, route, childOf)\n\n      if (childOf !== span) {\n        context.middleware.push(span)\n      }\n\n      this.enter(span)\n\n      web.patch(req)\n      web.setRoute(req, context.route)\n    })\n\n    this.addSub(`apm:${this.constructor.name}:middleware:next`, ({ req }) => {\n      const context = this._contexts.get(req)\n\n      if (!context) return\n\n      context.stack.pop()\n    })\n\n    this.addSub(`apm:${this.constructor.name}:middleware:exit`, ({ req }) => {\n      const context = this._contexts.get(req)\n\n      if (!context || context.middleware.length === 0) return\n\n      context.middleware.pop().finish()\n    })\n\n    this.addSub(`apm:${this.constructor.name}:middleware:error`, ({ req, error }) => {\n      web.addError(req, error)\n\n      if (!this.config.middleware) return\n\n      const span = this._getActive(req)\n\n      if (!span) return\n\n      span.setTag('error', error)\n    })\n\n    this.addSub(`apm:http:server:request:finish`, ({ req }) => {\n      const context = this._contexts.get(req)\n\n      if (!context) return\n\n      let span\n\n      while ((span = context.middleware.pop())) {\n        span.finish()\n      }\n    })\n  }\n\n  _getActive (req) {\n    const context = this._contexts.get(req)\n\n    if (!context) return\n    if (context.middleware.length === 0) return context.span\n\n    return context.middleware[context.middleware.length - 1]\n  }\n\n  _getStoreSpan () {\n    const store = storage.getStore()\n\n    return store && store.span\n  }\n\n  _getMiddlewareSpan (name, childOf) {\n    if (this.config.middleware === false) {\n      return childOf\n    }\n\n    const span = this.tracer.startSpan(`${this.constructor.name}.middleware`, {\n      childOf,\n      tags: {\n        'resource.name': name || '<anonymous>'\n      }\n    })\n\n    analyticsSampler.sample(span, this.config.measured)\n\n    return span\n  }\n\n  _createContext (req, route, span) {\n    let context = this._contexts.get(req)\n\n    if (!route || route === '/' || route === '*') {\n      route = ''\n    }\n\n    if (context) {\n      context.stack.push(route)\n\n      route = context.stack.join('')\n\n      // Longer route is more likely to be the actual route handler route.\n      if (route.length > context.route.length) {\n        context.route = route\n      }\n    } else {\n      context = {\n        span,\n        stack: [route],\n        route,\n        middleware: []\n      }\n\n      this._contexts.set(req, context)\n    }\n\n    return context\n  }\n}\n\nmodule.exports = RouterPlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}