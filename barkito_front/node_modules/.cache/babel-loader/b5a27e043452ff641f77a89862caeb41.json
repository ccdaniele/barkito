{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nfunction wrapRequest(send) {\n  return function wrappedRequest(cb) {\n    if (!this.service) return send.apply(this, arguments);\n    const serviceIdentifier = this.service.serviceIdentifier;\n    const channelSuffix = getChannelSuffix(serviceIdentifier);\n    const startCh = channel(`apm:aws:request:start:${channelSuffix}`);\n    if (!startCh.hasSubscribers) return send.apply(this, arguments);\n    const innerAr = new AsyncResource('apm:aws:request:inner');\n    const outerAr = new AsyncResource('apm:aws:request:outer');\n    return innerAr.runInAsyncScope(() => {\n      this.on('complete', innerAr.bind(response => {\n        channel(`apm:aws:request:complete:${channelSuffix}`).publish({\n          response\n        });\n      }));\n      startCh.publish({\n        serviceIdentifier,\n        operation: this.operation,\n        awsRegion: this.service.config && this.service.config.region,\n        awsService: this.service.api && this.service.api.className,\n        request: this\n      });\n\n      if (typeof cb === 'function') {\n        arguments[0] = wrapCb(cb, channelSuffix, this, outerAr);\n      }\n\n      return send.apply(this, arguments);\n    });\n  };\n}\n\nfunction wrapCb(cb, serviceName, request, ar) {\n  return function wrappedCb(err, response) {\n    const obj = {\n      request,\n      response\n    };\n    return ar.runInAsyncScope(() => {\n      channel(`apm:aws:response:start:${serviceName}`).publish(obj); // TODO(bengl) make this work without needing a needsFinish property added to the object\n\n      if (!obj.needsFinish) {\n        return cb.apply(this, arguments);\n      }\n\n      const finishChannel = channel(`apm:aws:response:finish:${serviceName}`);\n\n      try {\n        let result = cb.apply(this, arguments);\n\n        if (result && result.then) {\n          result = result.then(x => {\n            finishChannel.publish();\n            return x;\n          }, e => {\n            finishChannel.publish(e);\n            throw e;\n          });\n        } else {\n          finishChannel.publish();\n        }\n\n        return result;\n      } catch (e) {\n        finishChannel.publish(e);\n        throw e;\n      }\n    });\n  };\n}\n\nfunction getChannelSuffix(name) {\n  return ['cloudwatchlogs', 'dynamodb', 'eventbridge', 'kinesis', 'lambda', 'redshift', 's3', 'sns', 'sqs'].includes(name) ? name : 'default';\n}\n\naddHook({\n  name: 'aws-sdk',\n  versions: ['>=2.3.0']\n}, AWS => {\n  shimmer.wrap(AWS.Request.prototype, 'promise', wrapRequest);\n  shimmer.wrap(AWS.config, 'setPromisesDependency', setPromisesDependency => {\n    return function wrappedSetPromisesDependency(dep) {\n      const result = setPromisesDependency.apply(this, arguments);\n      shimmer.wrap(AWS.Request.prototype, 'promise', wrapRequest);\n      return result;\n    };\n  });\n  return AWS;\n}); // <2.1.35 has breaking changes for instrumentation\n// https://github.com/aws/aws-sdk-js/pull/629\n\naddHook({\n  name: 'aws-sdk',\n  versions: ['>=2.1.35']\n}, AWS => {\n  shimmer.wrap(AWS.Request.prototype, 'send', wrapRequest);\n  return AWS;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","wrapRequest","send","wrappedRequest","cb","service","apply","arguments","serviceIdentifier","channelSuffix","getChannelSuffix","startCh","hasSubscribers","innerAr","outerAr","runInAsyncScope","on","bind","response","publish","operation","awsRegion","config","region","awsService","api","className","request","wrapCb","serviceName","ar","wrappedCb","err","obj","needsFinish","finishChannel","result","then","x","e","name","includes","versions","AWS","wrap","Request","prototype","setPromisesDependency","wrappedSetPromisesDependency","dep"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/aws-sdk.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nfunction wrapRequest (send) {\n  return function wrappedRequest (cb) {\n    if (!this.service) return send.apply(this, arguments)\n\n    const serviceIdentifier = this.service.serviceIdentifier\n    const channelSuffix = getChannelSuffix(serviceIdentifier)\n    const startCh = channel(`apm:aws:request:start:${channelSuffix}`)\n    if (!startCh.hasSubscribers) return send.apply(this, arguments)\n    const innerAr = new AsyncResource('apm:aws:request:inner')\n    const outerAr = new AsyncResource('apm:aws:request:outer')\n\n    return innerAr.runInAsyncScope(() => {\n      this.on('complete', innerAr.bind(response => {\n        channel(`apm:aws:request:complete:${channelSuffix}`).publish({ response })\n      }))\n\n      startCh.publish({\n        serviceIdentifier,\n        operation: this.operation,\n        awsRegion: this.service.config && this.service.config.region,\n        awsService: this.service.api && this.service.api.className,\n        request: this\n      })\n\n      if (typeof cb === 'function') {\n        arguments[0] = wrapCb(cb, channelSuffix, this, outerAr)\n      }\n      return send.apply(this, arguments)\n    })\n  }\n}\n\nfunction wrapCb (cb, serviceName, request, ar) {\n  return function wrappedCb (err, response) {\n    const obj = { request, response }\n    return ar.runInAsyncScope(() => {\n      channel(`apm:aws:response:start:${serviceName}`).publish(obj)\n      // TODO(bengl) make this work without needing a needsFinish property added to the object\n      if (!obj.needsFinish) {\n        return cb.apply(this, arguments)\n      }\n      const finishChannel = channel(`apm:aws:response:finish:${serviceName}`)\n      try {\n        let result = cb.apply(this, arguments)\n        if (result && result.then) {\n          result = result.then(x => {\n            finishChannel.publish()\n            return x\n          }, e => {\n            finishChannel.publish(e)\n            throw e\n          })\n        } else {\n          finishChannel.publish()\n        }\n        return result\n      } catch (e) {\n        finishChannel.publish(e)\n        throw e\n      }\n    })\n  }\n}\n\nfunction getChannelSuffix (name) {\n  return [\n    'cloudwatchlogs',\n    'dynamodb',\n    'eventbridge',\n    'kinesis',\n    'lambda',\n    'redshift',\n    's3',\n    'sns',\n    'sqs'\n  ].includes(name) ? name : 'default'\n}\n\naddHook({ name: 'aws-sdk', versions: ['>=2.3.0'] }, AWS => {\n  shimmer.wrap(AWS.Request.prototype, 'promise', wrapRequest)\n  shimmer.wrap(AWS.config, 'setPromisesDependency', setPromisesDependency => {\n    return function wrappedSetPromisesDependency (dep) {\n      const result = setPromisesDependency.apply(this, arguments)\n      shimmer.wrap(AWS.Request.prototype, 'promise', wrapRequest)\n      return result\n    }\n  })\n  return AWS\n})\n\n// <2.1.35 has breaking changes for instrumentation\n// https://github.com/aws/aws-sdk-js/pull/629\naddHook({ name: 'aws-sdk', versions: ['>=2.1.35'] }, AWS => {\n  shimmer.wrap(AWS.Request.prototype, 'send', wrapRequest)\n  return AWS\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}