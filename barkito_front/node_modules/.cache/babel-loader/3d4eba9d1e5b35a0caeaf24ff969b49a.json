{"ast":null,"code":"'use strict';\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin');\n\nconst {\n  storage\n} = require('../../datadog-core');\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nclass CouchBasePlugin extends Plugin {\n  static get name() {\n    return 'couchbase';\n  }\n\n  addSubs(func, start) {\n    let finish = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : defaultFinish;\n    this.addSub(`apm:couchbase:${func}:start`, start);\n    this.addSub(`apm:couchbase:${func}:error`, this.addError);\n    this.addSub(`apm:couchbase:${func}:finish`, finish);\n  }\n\n  startSpan(operation, customTags, store, _ref) {\n    let {\n      bucket,\n      collection\n    } = _ref;\n    const tags = {\n      'db.type': 'couchbase',\n      'component': 'couchbase',\n      'service.name': this.config.service || `${this.tracer._service}-couchbase`,\n      'resource.name': `couchbase.${operation}`,\n      'span.kind': 'client'\n    };\n\n    for (const tag in customTags) {\n      tags[tag] = customTags[tag];\n    }\n\n    const span = this.tracer.startSpan(`couchbase.${operation}`, {\n      childOf: store ? store.span : null,\n      tags\n    });\n    if (bucket) span.setTag(`couchbase.bucket.name`, bucket.name);\n    if (collection) span.setTag(`couchbase.collection.name`, collection.name);\n    analyticsSampler.sample(span, this.config.measured);\n    return span;\n  }\n\n  constructor() {\n    super(...arguments);\n    this.addSubs('query', _ref2 => {\n      let {\n        resource,\n        bucket\n      } = _ref2;\n      const store = storage.getStore();\n      const span = this.startSpan('query', {\n        'span.type': 'sql',\n        'resource.name': resource\n      }, store, {\n        bucket\n      });\n      this.enter(span, store);\n    });\n\n    this._addCommandSubs('upsert');\n\n    this._addCommandSubs('insert');\n\n    this._addCommandSubs('replace');\n\n    this._addCommandSubs('append');\n\n    this._addCommandSubs('prepend');\n  }\n\n  _addCommandSubs(name) {\n    this.addSubs(name, _ref3 => {\n      let {\n        bucket,\n        collection\n      } = _ref3;\n      const store = storage.getStore();\n      const span = this.startSpan(name, {}, store, {\n        bucket,\n        collection\n      });\n      this.enter(span, store);\n    });\n  }\n\n}\n\nfunction defaultFinish() {\n  storage.getStore().span.finish();\n}\n\nmodule.exports = CouchBasePlugin;","map":{"version":3,"names":["Plugin","require","storage","analyticsSampler","CouchBasePlugin","name","addSubs","func","start","finish","defaultFinish","addSub","addError","startSpan","operation","customTags","store","bucket","collection","tags","config","service","tracer","_service","tag","span","childOf","setTag","sample","measured","constructor","resource","getStore","enter","_addCommandSubs","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-couchbase/src/index.js"],"sourcesContent":["'use strict'\n\nconst Plugin = require('../../dd-trace/src/plugins/plugin')\nconst { storage } = require('../../datadog-core')\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\n\nclass CouchBasePlugin extends Plugin {\n  static get name () {\n    return 'couchbase'\n  }\n\n  addSubs (func, start, finish = defaultFinish) {\n    this.addSub(`apm:couchbase:${func}:start`, start)\n    this.addSub(`apm:couchbase:${func}:error`, this.addError)\n    this.addSub(`apm:couchbase:${func}:finish`, finish)\n  }\n\n  startSpan (operation, customTags, store, { bucket, collection }) {\n    const tags = {\n      'db.type': 'couchbase',\n      'component': 'couchbase',\n      'service.name': this.config.service || `${this.tracer._service}-couchbase`,\n      'resource.name': `couchbase.${operation}`,\n      'span.kind': 'client'\n    }\n\n    for (const tag in customTags) {\n      tags[tag] = customTags[tag]\n    }\n    const span = this.tracer.startSpan(`couchbase.${operation}`, {\n      childOf: store ? store.span : null,\n      tags\n    })\n\n    if (bucket) span.setTag(`couchbase.bucket.name`, bucket.name)\n    if (collection) span.setTag(`couchbase.collection.name`, collection.name)\n\n    analyticsSampler.sample(span, this.config.measured)\n    return span\n  }\n\n  constructor (...args) {\n    super(...args)\n\n    this.addSubs('query', ({ resource, bucket }) => {\n      const store = storage.getStore()\n      const span = this.startSpan('query', { 'span.type': 'sql', 'resource.name': resource },\n        store, { bucket })\n      this.enter(span, store)\n    })\n\n    this._addCommandSubs('upsert')\n    this._addCommandSubs('insert')\n    this._addCommandSubs('replace')\n    this._addCommandSubs('append')\n    this._addCommandSubs('prepend')\n  }\n  _addCommandSubs (name) {\n    this.addSubs(name, ({ bucket, collection }) => {\n      const store = storage.getStore()\n      const span = this.startSpan(name, {}, store, { bucket, collection })\n      this.enter(span, store)\n    })\n  }\n}\n\nfunction defaultFinish () {\n  storage.getStore().span.finish()\n}\n\nmodule.exports = CouchBasePlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}