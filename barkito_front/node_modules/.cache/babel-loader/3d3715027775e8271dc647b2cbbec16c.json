{"ast":null,"code":"'use strict';\n\nconst Tracer = require('./opentracing/tracer');\n\nconst tags = require('../../../ext/tags');\n\nconst Scope = require('./scope');\n\nconst {\n  storage\n} = require('../../datadog-core');\n\nconst {\n  isError\n} = require('./util');\n\nconst {\n  setStartupLogConfig\n} = require('./startup-log');\n\nconst SPAN_TYPE = tags.SPAN_TYPE;\nconst RESOURCE_NAME = tags.RESOURCE_NAME;\nconst SERVICE_NAME = tags.SERVICE_NAME;\nconst MEASURED = tags.MEASURED;\n\nclass DatadogTracer extends Tracer {\n  constructor(config) {\n    super(config);\n    this._scope = new Scope();\n    setStartupLogConfig(config);\n  }\n\n  trace(name, options, fn) {\n    options = Object.assign({\n      childOf: this.scope().active()\n    }, options);\n\n    if (!options.childOf && options.orphanable === false) {\n      return fn(null, () => {});\n    }\n\n    const span = this.startSpan(name, options);\n    addTags(span, options);\n\n    try {\n      if (fn.length > 1) {\n        return this.scope().activate(span, () => fn(span, err => {\n          addError(span, err);\n          span.finish();\n        }));\n      }\n\n      const result = this.scope().activate(span, () => fn(span));\n\n      if (result && typeof result.then === 'function') {\n        result.then(() => span.finish(), err => {\n          addError(span, err);\n          span.finish();\n        });\n      } else {\n        span.finish();\n      }\n\n      return result;\n    } catch (e) {\n      addError(span, e);\n      span.finish();\n      throw e;\n    }\n  }\n\n  wrap(name, options, fn) {\n    const tracer = this;\n    return function () {\n      const store = storage.getStore();\n      if (store && store.noop) return fn.apply(this, arguments);\n      let optionsObj = options;\n\n      if (typeof optionsObj === 'function' && typeof fn === 'function') {\n        optionsObj = optionsObj.apply(this, arguments);\n      }\n\n      if (optionsObj && optionsObj.orphanable === false && !tracer.scope().active()) {\n        return fn.apply(this, arguments);\n      }\n\n      const lastArgId = arguments.length - 1;\n      const cb = arguments[lastArgId];\n\n      if (typeof cb === 'function') {\n        const scopeBoundCb = tracer.scope().bind(cb);\n        return tracer.trace(name, optionsObj, (span, done) => {\n          arguments[lastArgId] = function (err) {\n            done(err);\n            return scopeBoundCb.apply(this, arguments);\n          };\n\n          return fn.apply(this, arguments);\n        });\n      } else {\n        return tracer.trace(name, optionsObj, () => fn.apply(this, arguments));\n      }\n    };\n  }\n\n  setUrl(url) {\n    this._exporter.setUrl(url);\n  }\n\n  scope() {\n    return this._scope;\n  }\n\n  currentSpan() {\n    return this.scope().active();\n  }\n\n  getRumData() {\n    if (!this._enableGetRumData) {\n      return '';\n    }\n\n    const span = this.scope().active().context();\n    const traceId = span.toTraceId();\n    const traceTime = Date.now();\n    return `\\\n<meta name=\"dd-trace-id\" content=\"${traceId}\" />\\\n<meta name=\"dd-trace-time\" content=\"${traceTime}\" />`;\n  }\n\n  setUser(user) {\n    if (!user || !user.id) return this;\n    const span = this.scope().active();\n    if (!span) return this;\n    const rootSpan = span._spanContext._trace.started[0];\n    if (!rootSpan) return this;\n\n    for (const k of Object.keys(user)) {\n      rootSpan.setTag(`usr.${k}`, '' + user[k]);\n    }\n\n    return this;\n  }\n\n}\n\nfunction addError(span, error) {\n  if (isError(error)) {\n    span.addTags({\n      'error.type': error.name,\n      'error.msg': error.message,\n      'error.stack': error.stack\n    });\n  }\n}\n\nfunction addTags(span, options) {\n  const tags = {};\n  if (options.type) tags[SPAN_TYPE] = options.type;\n  if (options.service) tags[SERVICE_NAME] = options.service;\n  if (options.resource) tags[RESOURCE_NAME] = options.resource;\n  tags[MEASURED] = options.measured;\n  span.addTags(tags);\n}\n\nmodule.exports = DatadogTracer;","map":{"version":3,"names":["Tracer","require","tags","Scope","storage","isError","setStartupLogConfig","SPAN_TYPE","RESOURCE_NAME","SERVICE_NAME","MEASURED","DatadogTracer","constructor","config","_scope","trace","name","options","fn","Object","assign","childOf","scope","active","orphanable","span","startSpan","addTags","length","activate","err","addError","finish","result","then","e","wrap","tracer","store","getStore","noop","apply","arguments","optionsObj","lastArgId","cb","scopeBoundCb","bind","done","setUrl","url","_exporter","currentSpan","getRumData","_enableGetRumData","context","traceId","toTraceId","traceTime","Date","now","setUser","user","id","rootSpan","_spanContext","_trace","started","k","keys","setTag","error","message","stack","type","service","resource","measured","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/tracer.js"],"sourcesContent":["'use strict'\n\nconst Tracer = require('./opentracing/tracer')\nconst tags = require('../../../ext/tags')\nconst Scope = require('./scope')\nconst { storage } = require('../../datadog-core')\nconst { isError } = require('./util')\nconst { setStartupLogConfig } = require('./startup-log')\n\nconst SPAN_TYPE = tags.SPAN_TYPE\nconst RESOURCE_NAME = tags.RESOURCE_NAME\nconst SERVICE_NAME = tags.SERVICE_NAME\nconst MEASURED = tags.MEASURED\n\nclass DatadogTracer extends Tracer {\n  constructor (config) {\n    super(config)\n\n    this._scope = new Scope()\n    setStartupLogConfig(config)\n  }\n\n  trace (name, options, fn) {\n    options = Object.assign({\n      childOf: this.scope().active()\n    }, options)\n\n    if (!options.childOf && options.orphanable === false) {\n      return fn(null, () => {})\n    }\n\n    const span = this.startSpan(name, options)\n\n    addTags(span, options)\n\n    try {\n      if (fn.length > 1) {\n        return this.scope().activate(span, () => fn(span, err => {\n          addError(span, err)\n          span.finish()\n        }))\n      }\n\n      const result = this.scope().activate(span, () => fn(span))\n\n      if (result && typeof result.then === 'function') {\n        result.then(\n          () => span.finish(),\n          err => {\n            addError(span, err)\n            span.finish()\n          }\n        )\n      } else {\n        span.finish()\n      }\n\n      return result\n    } catch (e) {\n      addError(span, e)\n      span.finish()\n      throw e\n    }\n  }\n\n  wrap (name, options, fn) {\n    const tracer = this\n\n    return function () {\n      const store = storage.getStore()\n\n      if (store && store.noop) return fn.apply(this, arguments)\n\n      let optionsObj = options\n      if (typeof optionsObj === 'function' && typeof fn === 'function') {\n        optionsObj = optionsObj.apply(this, arguments)\n      }\n\n      if (optionsObj && optionsObj.orphanable === false && !tracer.scope().active()) {\n        return fn.apply(this, arguments)\n      }\n\n      const lastArgId = arguments.length - 1\n      const cb = arguments[lastArgId]\n\n      if (typeof cb === 'function') {\n        const scopeBoundCb = tracer.scope().bind(cb)\n        return tracer.trace(name, optionsObj, (span, done) => {\n          arguments[lastArgId] = function (err) {\n            done(err)\n            return scopeBoundCb.apply(this, arguments)\n          }\n\n          return fn.apply(this, arguments)\n        })\n      } else {\n        return tracer.trace(name, optionsObj, () => fn.apply(this, arguments))\n      }\n    }\n  }\n\n  setUrl (url) {\n    this._exporter.setUrl(url)\n  }\n\n  scope () {\n    return this._scope\n  }\n\n  currentSpan () {\n    return this.scope().active()\n  }\n\n  getRumData () {\n    if (!this._enableGetRumData) {\n      return ''\n    }\n    const span = this.scope().active().context()\n    const traceId = span.toTraceId()\n    const traceTime = Date.now()\n    return `\\\n<meta name=\"dd-trace-id\" content=\"${traceId}\" />\\\n<meta name=\"dd-trace-time\" content=\"${traceTime}\" />`\n  }\n\n  setUser (user) {\n    if (!user || !user.id) return this\n\n    const span = this.scope().active()\n    if (!span) return this\n\n    const rootSpan = span._spanContext._trace.started[0]\n    if (!rootSpan) return this\n\n    for (const k of Object.keys(user)) {\n      rootSpan.setTag(`usr.${k}`, '' + user[k])\n    }\n\n    return this\n  }\n}\n\nfunction addError (span, error) {\n  if (isError(error)) {\n    span.addTags({\n      'error.type': error.name,\n      'error.msg': error.message,\n      'error.stack': error.stack\n    })\n  }\n}\n\nfunction addTags (span, options) {\n  const tags = {}\n\n  if (options.type) tags[SPAN_TYPE] = options.type\n  if (options.service) tags[SERVICE_NAME] = options.service\n  if (options.resource) tags[RESOURCE_NAME] = options.resource\n\n  tags[MEASURED] = options.measured\n\n  span.addTags(tags)\n}\n\nmodule.exports = DatadogTracer\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}