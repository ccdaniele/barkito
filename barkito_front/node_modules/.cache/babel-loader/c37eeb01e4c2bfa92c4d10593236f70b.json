{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('../helpers/instrument');\n\nconst shimmer = require('../../../datadog-shimmer');\n\nconst startChannel = channel('apm:moleculer:action:start');\nconst finishChannel = channel('apm:moleculer:action:finish');\nconst errorChannel = channel('apm:moleculer:action:error');\n\nfunction wrapRegisterMiddlewares(registerMiddlewares) {\n  return function (userMiddlewares) {\n    if (this.middlewares && this.middlewares.add) {\n      this.middlewares.add(createMiddleware());\n    }\n\n    return registerMiddlewares.apply(this, arguments);\n  };\n}\n\nfunction createMiddleware() {\n  return {\n    name: 'Datadog',\n\n    localAction(next, action) {\n      const broker = this;\n      return function datadogMiddleware(ctx) {\n        const actionResource = new AsyncResource('bound-anonymous-fn');\n        return actionResource.runInAsyncScope(() => {\n          startChannel.publish({\n            action,\n            ctx,\n            broker\n          });\n\n          try {\n            return next(ctx).then(result => {\n              finishChannel.publish();\n              return result;\n            }, error => {\n              errorChannel.publish(error);\n              finishChannel.publish();\n              throw error;\n            });\n          } catch (e) {\n            errorChannel.publish(e);\n            finishChannel.publish();\n          }\n        });\n      };\n    }\n\n  };\n}\n\naddHook({\n  name: 'moleculer',\n  versions: ['>=0.14']\n}, moleculer => {\n  shimmer.wrap(moleculer.ServiceBroker.prototype, 'registerMiddlewares', wrapRegisterMiddlewares);\n  return moleculer;\n});","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startChannel","finishChannel","errorChannel","wrapRegisterMiddlewares","registerMiddlewares","userMiddlewares","middlewares","add","createMiddleware","apply","arguments","name","localAction","next","action","broker","datadogMiddleware","ctx","actionResource","runInAsyncScope","publish","then","result","error","e","versions","moleculer","wrap","ServiceBroker","prototype"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/moleculer/server.js"],"sourcesContent":["'use strict'\n\nconst { channel, addHook, AsyncResource } = require('../helpers/instrument')\nconst shimmer = require('../../../datadog-shimmer')\n\nconst startChannel = channel('apm:moleculer:action:start')\nconst finishChannel = channel('apm:moleculer:action:finish')\nconst errorChannel = channel('apm:moleculer:action:error')\n\nfunction wrapRegisterMiddlewares (registerMiddlewares) {\n  return function (userMiddlewares) {\n    if (this.middlewares && this.middlewares.add) {\n      this.middlewares.add(createMiddleware())\n    }\n\n    return registerMiddlewares.apply(this, arguments)\n  }\n}\n\nfunction createMiddleware () {\n  return {\n    name: 'Datadog',\n\n    localAction (next, action) {\n      const broker = this\n\n      return function datadogMiddleware (ctx) {\n        const actionResource = new AsyncResource('bound-anonymous-fn')\n\n        return actionResource.runInAsyncScope(() => {\n          startChannel.publish({ action, ctx, broker })\n\n          try {\n            return next(ctx).then(\n              result => {\n                finishChannel.publish()\n                return result\n              },\n              error => {\n                errorChannel.publish(error)\n                finishChannel.publish()\n                throw error\n              }\n            )\n          } catch (e) {\n            errorChannel.publish(e)\n            finishChannel.publish()\n          }\n        })\n      }\n    }\n  }\n}\n\naddHook({ name: 'moleculer', versions: ['>=0.14'] }, moleculer => {\n  shimmer.wrap(moleculer.ServiceBroker.prototype, 'registerMiddlewares', wrapRegisterMiddlewares)\n\n  return moleculer\n})\n"],"mappings":"AAAA;;AAEA,MAAM;EAAEA,OAAF;EAAWC,OAAX;EAAoBC;AAApB,IAAsCC,OAAO,CAAC,uBAAD,CAAnD;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,0BAAD,CAAvB;;AAEA,MAAME,YAAY,GAAGL,OAAO,CAAC,4BAAD,CAA5B;AACA,MAAMM,aAAa,GAAGN,OAAO,CAAC,6BAAD,CAA7B;AACA,MAAMO,YAAY,GAAGP,OAAO,CAAC,4BAAD,CAA5B;;AAEA,SAASQ,uBAAT,CAAkCC,mBAAlC,EAAuD;EACrD,OAAO,UAAUC,eAAV,EAA2B;IAChC,IAAI,KAAKC,WAAL,IAAoB,KAAKA,WAAL,CAAiBC,GAAzC,EAA8C;MAC5C,KAAKD,WAAL,CAAiBC,GAAjB,CAAqBC,gBAAgB,EAArC;IACD;;IAED,OAAOJ,mBAAmB,CAACK,KAApB,CAA0B,IAA1B,EAAgCC,SAAhC,CAAP;EACD,CAND;AAOD;;AAED,SAASF,gBAAT,GAA6B;EAC3B,OAAO;IACLG,IAAI,EAAE,SADD;;IAGLC,WAAW,CAAEC,IAAF,EAAQC,MAAR,EAAgB;MACzB,MAAMC,MAAM,GAAG,IAAf;MAEA,OAAO,SAASC,iBAAT,CAA4BC,GAA5B,EAAiC;QACtC,MAAMC,cAAc,GAAG,IAAIrB,aAAJ,CAAkB,oBAAlB,CAAvB;QAEA,OAAOqB,cAAc,CAACC,eAAf,CAA+B,MAAM;UAC1CnB,YAAY,CAACoB,OAAb,CAAqB;YAAEN,MAAF;YAAUG,GAAV;YAAeF;UAAf,CAArB;;UAEA,IAAI;YACF,OAAOF,IAAI,CAACI,GAAD,CAAJ,CAAUI,IAAV,CACLC,MAAM,IAAI;cACRrB,aAAa,CAACmB,OAAd;cACA,OAAOE,MAAP;YACD,CAJI,EAKLC,KAAK,IAAI;cACPrB,YAAY,CAACkB,OAAb,CAAqBG,KAArB;cACAtB,aAAa,CAACmB,OAAd;cACA,MAAMG,KAAN;YACD,CATI,CAAP;UAWD,CAZD,CAYE,OAAOC,CAAP,EAAU;YACVtB,YAAY,CAACkB,OAAb,CAAqBI,CAArB;YACAvB,aAAa,CAACmB,OAAd;UACD;QACF,CAnBM,CAAP;MAoBD,CAvBD;IAwBD;;EA9BI,CAAP;AAgCD;;AAEDxB,OAAO,CAAC;EAAEe,IAAI,EAAE,WAAR;EAAqBc,QAAQ,EAAE,CAAC,QAAD;AAA/B,CAAD,EAA8CC,SAAS,IAAI;EAChE3B,OAAO,CAAC4B,IAAR,CAAaD,SAAS,CAACE,aAAV,CAAwBC,SAArC,EAAgD,qBAAhD,EAAuE1B,uBAAvE;EAEA,OAAOuB,SAAP;AACD,CAJM,CAAP"},"metadata":{},"sourceType":"script"}