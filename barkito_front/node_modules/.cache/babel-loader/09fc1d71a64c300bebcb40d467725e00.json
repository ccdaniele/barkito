{"ast":null,"code":"'use strict';\n\nconst DatabasePlugin = require('../../dd-trace/src/plugins/database');\n\nclass MongodbCorePlugin extends DatabasePlugin {\n  static get name() {\n    return 'mongodb-core';\n  }\n\n  static get component() {\n    return 'mongodb';\n  }\n\n  start(_ref) {\n    let {\n      ns,\n      ops,\n      options = {},\n      name\n    } = _ref;\n    const query = getQuery(ops);\n    const resource = truncate(getResource(ns, query, name));\n    this.startSpan('mongodb.query', {\n      service: this.config.service,\n      resource,\n      type: 'mongodb',\n      kind: 'client',\n      meta: {\n        'db.name': ns,\n        'mongodb.query': query,\n        'out.host': options.host,\n        'out.port': options.port\n      }\n    });\n  }\n\n}\n\nfunction getQuery(cmd) {\n  if (!cmd || typeof cmd !== 'object' || Array.isArray(cmd)) return;\n  if (cmd.query) return JSON.stringify(limitDepth(cmd.query));\n  if (cmd.filter) return JSON.stringify(limitDepth(cmd.filter));\n}\n\nfunction getResource(ns, query, operationName) {\n  const parts = [operationName, ns];\n\n  if (query) {\n    parts.push(query);\n  }\n\n  return parts.join(' ');\n}\n\nfunction truncate(input) {\n  return input.slice(0, Math.min(input.length, 10000));\n}\n\nfunction shouldSimplify(input) {\n  return !isObject(input);\n}\n\nfunction shouldHide(input) {\n  return Buffer.isBuffer(input) || typeof input === 'function' || isBinary(input);\n}\n\nfunction limitDepth(input) {\n  if (isBSON(input)) {\n    input = input.toJSON();\n  }\n\n  if (shouldHide(input)) return '?';\n  if (shouldSimplify(input)) return input;\n  const output = {};\n  const queue = [{\n    input,\n    output,\n    depth: 0\n  }];\n\n  while (queue.length) {\n    const {\n      input,\n      output,\n      depth\n    } = queue.pop();\n    const nextDepth = depth + 1;\n\n    for (const key in input) {\n      if (typeof input[key] === 'function') continue;\n      let child = input[key];\n\n      if (isBSON(child)) {\n        child = child.toJSON();\n      }\n\n      if (depth >= 10 || shouldHide(child)) {\n        output[key] = '?';\n      } else if (shouldSimplify(child)) {\n        output[key] = child;\n      } else {\n        queue.push({\n          input: child,\n          output: output[key] = {},\n          depth: nextDepth\n        });\n      }\n    }\n  }\n\n  return output;\n}\n\nfunction isObject(val) {\n  return typeof val === 'object' && val !== null && !(val instanceof Array);\n}\n\nfunction isBSON(val) {\n  return val && val._bsontype && !isBinary(val);\n}\n\nfunction isBinary(val) {\n  return val && val._bsontype === 'Binary';\n}\n\nmodule.exports = MongodbCorePlugin;","map":{"version":3,"names":["DatabasePlugin","require","MongodbCorePlugin","name","component","start","ns","ops","options","query","getQuery","resource","truncate","getResource","startSpan","service","config","type","kind","meta","host","port","cmd","Array","isArray","JSON","stringify","limitDepth","filter","operationName","parts","push","join","input","slice","Math","min","length","shouldSimplify","isObject","shouldHide","Buffer","isBuffer","isBinary","isBSON","toJSON","output","queue","depth","pop","nextDepth","key","child","val","_bsontype","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-plugin-mongodb-core/src/index.js"],"sourcesContent":["'use strict'\n\nconst DatabasePlugin = require('../../dd-trace/src/plugins/database')\n\nclass MongodbCorePlugin extends DatabasePlugin {\n  static get name () { return 'mongodb-core' }\n  static get component () { return 'mongodb' }\n\n  start ({ ns, ops, options = {}, name }) {\n    const query = getQuery(ops)\n    const resource = truncate(getResource(ns, query, name))\n\n    this.startSpan('mongodb.query', {\n      service: this.config.service,\n      resource,\n      type: 'mongodb',\n      kind: 'client',\n      meta: {\n        'db.name': ns,\n        'mongodb.query': query,\n        'out.host': options.host,\n        'out.port': options.port\n      }\n    })\n  }\n}\n\nfunction getQuery (cmd) {\n  if (!cmd || typeof cmd !== 'object' || Array.isArray(cmd)) return\n  if (cmd.query) return JSON.stringify(limitDepth(cmd.query))\n  if (cmd.filter) return JSON.stringify(limitDepth(cmd.filter))\n}\n\nfunction getResource (ns, query, operationName) {\n  const parts = [operationName, ns]\n\n  if (query) {\n    parts.push(query)\n  }\n\n  return parts.join(' ')\n}\n\nfunction truncate (input) {\n  return input.slice(0, Math.min(input.length, 10000))\n}\n\nfunction shouldSimplify (input) {\n  return !isObject(input)\n}\n\nfunction shouldHide (input) {\n  return Buffer.isBuffer(input) || typeof input === 'function' || isBinary(input)\n}\n\nfunction limitDepth (input) {\n  if (isBSON(input)) {\n    input = input.toJSON()\n  }\n\n  if (shouldHide(input)) return '?'\n  if (shouldSimplify(input)) return input\n\n  const output = {}\n  const queue = [{\n    input,\n    output,\n    depth: 0\n  }]\n\n  while (queue.length) {\n    const {\n      input, output, depth\n    } = queue.pop()\n    const nextDepth = depth + 1\n    for (const key in input) {\n      if (typeof input[key] === 'function') continue\n\n      let child = input[key]\n\n      if (isBSON(child)) {\n        child = child.toJSON()\n      }\n\n      if (depth >= 10 || shouldHide(child)) {\n        output[key] = '?'\n      } else if (shouldSimplify(child)) {\n        output[key] = child\n      } else {\n        queue.push({\n          input: child,\n          output: output[key] = {},\n          depth: nextDepth\n        })\n      }\n    }\n  }\n\n  return output\n}\n\nfunction isObject (val) {\n  return typeof val === 'object' && val !== null && !(val instanceof Array)\n}\n\nfunction isBSON (val) {\n  return val && val._bsontype && !isBinary(val)\n}\n\nfunction isBinary (val) {\n  return val && val._bsontype === 'Binary'\n}\n\nmodule.exports = MongodbCorePlugin\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}