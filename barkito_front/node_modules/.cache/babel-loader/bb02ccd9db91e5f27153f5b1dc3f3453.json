{"ast":null,"code":"'use strict';\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst {\n  addHook,\n  channel,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst enterChannel = channel('apm:koa:middleware:enter');\nconst exitChannel = channel('apm:koa:middleware:exit');\nconst errorChannel = channel('apm:koa:middleware:error');\nconst nextChannel = channel('apm:koa:middleware:next');\nconst handleChannel = channel('apm:koa:request:handle');\nconst routeChannel = channel('apm:koa:request:route');\nconst originals = new WeakMap();\n\nfunction wrapCallback(callback) {\n  return function callbackWithTrace() {\n    const handleRequest = callback.apply(this, arguments);\n    if (typeof handleRequest !== 'function') return handleRequest;\n    return function handleRequestWithTrace(req, res) {\n      handleChannel.publish({\n        req,\n        res\n      });\n      return handleRequest.apply(this, arguments);\n    };\n  };\n}\n\nfunction wrapUse(use) {\n  return function useWithTrace() {\n    const result = use.apply(this, arguments);\n    if (!Array.isArray(this.middleware)) return result;\n    const fn = this.middleware.pop();\n    this.middleware.push(wrapMiddleware(fn));\n    return result;\n  };\n}\n\nfunction wrapRegister(register) {\n  return function registerWithTrace(path, methods, middleware, opts) {\n    const route = register.apply(this, arguments);\n\n    if (!Array.isArray(path) && route && Array.isArray(route.stack)) {\n      wrapStack(route);\n    }\n\n    return route;\n  };\n}\n\nfunction wrapRouterUse(use) {\n  return function useWithTrace() {\n    const router = use.apply(this, arguments);\n    router.stack.forEach(wrapStack);\n    return router;\n  };\n}\n\nfunction wrapStack(layer) {\n  layer.stack = layer.stack.map(middleware => {\n    if (typeof middleware !== 'function') return middleware;\n    const original = originals.get(middleware);\n    middleware = original || middleware;\n    const handler = shimmer.wrap(middleware, wrapMiddleware(middleware, layer));\n    originals.set(handler, middleware);\n    return handler;\n  });\n}\n\nfunction wrapMiddleware(fn, layer) {\n  if (typeof fn !== 'function') return fn;\n  const name = fn.name;\n  return function (ctx, next) {\n    if (!ctx || !enterChannel.hasSubscribers) return fn.apply(this, arguments);\n    const middlewareResource = new AsyncResource('bound-anonymous-fn');\n    const req = ctx.req;\n    return middlewareResource.runInAsyncScope(() => {\n      const path = layer && layer.path;\n      const route = typeof path === 'string' && !path.endsWith('(.*)') && !path.endsWith('([^/]*)') && path;\n      enterChannel.publish({\n        req,\n        name,\n        route\n      });\n\n      if (typeof next === 'function') {\n        arguments[1] = wrapNext(req, next);\n      }\n\n      try {\n        const result = fn.apply(this, arguments);\n\n        if (result && typeof result.then === 'function') {\n          return result.then(result => {\n            fulfill(ctx);\n            return result;\n          }, err => {\n            fulfill(ctx, err);\n            throw err;\n          });\n        } else {\n          fulfill(ctx);\n          return result;\n        }\n      } catch (e) {\n        fulfill(ctx, e);\n        throw e;\n      }\n    });\n  };\n}\n\nfunction fulfill(ctx, error) {\n  const req = ctx.req;\n  const route = ctx.routePath;\n\n  if (error) {\n    errorChannel.publish({\n      req,\n      error\n    });\n  } // TODO: make sure that the parent class cannot override this in `enter`\n\n\n  if (route) {\n    routeChannel.publish({\n      req,\n      route\n    });\n  }\n\n  exitChannel.publish({\n    req\n  });\n}\n\nfunction wrapNext(req, next) {\n  return function () {\n    nextChannel.publish({\n      req\n    });\n    return next.apply(this, arguments);\n  };\n}\n\naddHook({\n  name: 'koa',\n  versions: ['>=2']\n}, Koa => {\n  shimmer.wrap(Koa.prototype, 'callback', wrapCallback);\n  shimmer.wrap(Koa.prototype, 'use', wrapUse);\n  return Koa;\n});\naddHook({\n  name: '@koa/router',\n  versions: ['>=8']\n}, Router => {\n  shimmer.wrap(Router.prototype, 'register', wrapRegister);\n  shimmer.wrap(Router.prototype, 'use', wrapRouterUse);\n  return Router;\n});\naddHook({\n  name: 'koa-router',\n  versions: ['>=7']\n}, Router => {\n  shimmer.wrap(Router.prototype, 'register', wrapRegister);\n  shimmer.wrap(Router.prototype, 'use', wrapRouterUse);\n  return Router;\n});","map":{"version":3,"names":["shimmer","require","addHook","channel","AsyncResource","enterChannel","exitChannel","errorChannel","nextChannel","handleChannel","routeChannel","originals","WeakMap","wrapCallback","callback","callbackWithTrace","handleRequest","apply","arguments","handleRequestWithTrace","req","res","publish","wrapUse","use","useWithTrace","result","Array","isArray","middleware","fn","pop","push","wrapMiddleware","wrapRegister","register","registerWithTrace","path","methods","opts","route","stack","wrapStack","wrapRouterUse","router","forEach","layer","map","original","get","handler","wrap","set","name","ctx","next","hasSubscribers","middlewareResource","runInAsyncScope","endsWith","wrapNext","then","fulfill","err","e","error","routePath","versions","Koa","prototype","Router"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/koa.js"],"sourcesContent":["'use strict'\n\nconst shimmer = require('../../datadog-shimmer')\nconst { addHook, channel, AsyncResource } = require('./helpers/instrument')\n\nconst enterChannel = channel('apm:koa:middleware:enter')\nconst exitChannel = channel('apm:koa:middleware:exit')\nconst errorChannel = channel('apm:koa:middleware:error')\nconst nextChannel = channel('apm:koa:middleware:next')\nconst handleChannel = channel('apm:koa:request:handle')\nconst routeChannel = channel('apm:koa:request:route')\n\nconst originals = new WeakMap()\n\nfunction wrapCallback (callback) {\n  return function callbackWithTrace () {\n    const handleRequest = callback.apply(this, arguments)\n\n    if (typeof handleRequest !== 'function') return handleRequest\n\n    return function handleRequestWithTrace (req, res) {\n      handleChannel.publish({ req, res })\n\n      return handleRequest.apply(this, arguments)\n    }\n  }\n}\n\nfunction wrapUse (use) {\n  return function useWithTrace () {\n    const result = use.apply(this, arguments)\n\n    if (!Array.isArray(this.middleware)) return result\n\n    const fn = this.middleware.pop()\n\n    this.middleware.push(wrapMiddleware(fn))\n\n    return result\n  }\n}\n\nfunction wrapRegister (register) {\n  return function registerWithTrace (path, methods, middleware, opts) {\n    const route = register.apply(this, arguments)\n\n    if (!Array.isArray(path) && route && Array.isArray(route.stack)) {\n      wrapStack(route)\n    }\n\n    return route\n  }\n}\n\nfunction wrapRouterUse (use) {\n  return function useWithTrace () {\n    const router = use.apply(this, arguments)\n\n    router.stack.forEach(wrapStack)\n\n    return router\n  }\n}\n\nfunction wrapStack (layer) {\n  layer.stack = layer.stack.map(middleware => {\n    if (typeof middleware !== 'function') return middleware\n\n    const original = originals.get(middleware)\n\n    middleware = original || middleware\n\n    const handler = shimmer.wrap(middleware, wrapMiddleware(middleware, layer))\n\n    originals.set(handler, middleware)\n\n    return handler\n  })\n}\n\nfunction wrapMiddleware (fn, layer) {\n  if (typeof fn !== 'function') return fn\n\n  const name = fn.name\n\n  return function (ctx, next) {\n    if (!ctx || !enterChannel.hasSubscribers) return fn.apply(this, arguments)\n\n    const middlewareResource = new AsyncResource('bound-anonymous-fn')\n    const req = ctx.req\n\n    return middlewareResource.runInAsyncScope(() => {\n      const path = layer && layer.path\n      const route = typeof path === 'string' && !path.endsWith('(.*)') && !path.endsWith('([^/]*)') && path\n\n      enterChannel.publish({ req, name, route })\n\n      if (typeof next === 'function') {\n        arguments[1] = wrapNext(req, next)\n      }\n\n      try {\n        const result = fn.apply(this, arguments)\n\n        if (result && typeof result.then === 'function') {\n          return result.then(\n            result => {\n              fulfill(ctx)\n              return result\n            },\n            err => {\n              fulfill(ctx, err)\n              throw err\n            }\n          )\n        } else {\n          fulfill(ctx)\n          return result\n        }\n      } catch (e) {\n        fulfill(ctx, e)\n        throw e\n      }\n    })\n  }\n}\n\nfunction fulfill (ctx, error) {\n  const req = ctx.req\n  const route = ctx.routePath\n\n  if (error) {\n    errorChannel.publish({ req, error })\n  }\n\n  // TODO: make sure that the parent class cannot override this in `enter`\n  if (route) {\n    routeChannel.publish({ req, route })\n  }\n\n  exitChannel.publish({ req })\n}\n\nfunction wrapNext (req, next) {\n  return function () {\n    nextChannel.publish({ req })\n\n    return next.apply(this, arguments)\n  }\n}\n\naddHook({ name: 'koa', versions: ['>=2'] }, Koa => {\n  shimmer.wrap(Koa.prototype, 'callback', wrapCallback)\n  shimmer.wrap(Koa.prototype, 'use', wrapUse)\n\n  return Koa\n})\n\naddHook({ name: '@koa/router', versions: ['>=8'] }, Router => {\n  shimmer.wrap(Router.prototype, 'register', wrapRegister)\n  shimmer.wrap(Router.prototype, 'use', wrapRouterUse)\n\n  return Router\n})\n\naddHook({ name: 'koa-router', versions: ['>=7'] }, Router => {\n  shimmer.wrap(Router.prototype, 'register', wrapRegister)\n  shimmer.wrap(Router.prototype, 'use', wrapRouterUse)\n\n  return Router\n})\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}