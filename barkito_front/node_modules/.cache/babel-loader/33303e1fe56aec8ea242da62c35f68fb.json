{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\naddHook({\n  name: 'amqp10',\n  file: 'lib/sender_link.js',\n  versions: ['>=3']\n}, SenderLink => {\n  const startCh = channel('apm:amqp10:send:start');\n  const finishCh = channel('apm:amqp10:send:finish');\n  const errorCh = channel('apm:amqp10:send:error');\n  shimmer.wrap(SenderLink.prototype, 'send', send => function (msg, options) {\n    if (!startCh.hasSubscribers) {\n      return send.apply(this, arguments);\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({\n        link: this\n      });\n\n      try {\n        const promise = send.apply(this, arguments);\n\n        if (!promise) {\n          finish(finishCh, errorCh);\n          return promise;\n        }\n\n        promise.then(asyncResource.bind(() => finish(finishCh, errorCh)), asyncResource.bind(e => finish(finishCh, errorCh, e)));\n        return promise;\n      } catch (err) {\n        finish(finishCh, errorCh, err);\n        throw err;\n      }\n    });\n  });\n  return SenderLink;\n});\naddHook({\n  name: 'amqp10',\n  file: 'lib/receiver_link.js',\n  versions: ['>=3']\n}, ReceiverLink => {\n  const startCh = channel('apm:amqp10:receive:start');\n  const finishCh = channel('apm:amqp10:receive:finish');\n  const errorCh = channel('apm:amqp10:receive:error');\n  shimmer.wrap(ReceiverLink.prototype, '_messageReceived', messageReceived => function (transferFrame) {\n    if (!transferFrame || transferFrame.aborted || transferFrame.more) {\n      return messageReceived.apply(this, arguments);\n    }\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({\n        link: this\n      });\n\n      try {\n        return messageReceived.apply(this, arguments);\n      } catch (err) {\n        errorCh.publish(err);\n        throw err;\n      } finally {\n        finishCh.publish();\n      }\n    });\n  });\n  return ReceiverLink;\n});\n\nfunction finish(finishCh, errorCh, error) {\n  if (error) {\n    errorCh.publish(error);\n  }\n\n  finishCh.publish();\n}","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","name","file","versions","SenderLink","startCh","finishCh","errorCh","wrap","prototype","send","msg","options","hasSubscribers","apply","arguments","asyncResource","runInAsyncScope","publish","link","promise","finish","then","bind","e","err","ReceiverLink","messageReceived","transferFrame","aborted","more","error"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/amqp10.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\naddHook({ name: 'amqp10', file: 'lib/sender_link.js', versions: ['>=3'] }, SenderLink => {\n  const startCh = channel('apm:amqp10:send:start')\n  const finishCh = channel('apm:amqp10:send:finish')\n  const errorCh = channel('apm:amqp10:send:error')\n  shimmer.wrap(SenderLink.prototype, 'send', send => function (msg, options) {\n    if (!startCh.hasSubscribers) {\n      return send.apply(this, arguments)\n    }\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({ link: this })\n      try {\n        const promise = send.apply(this, arguments)\n\n        if (!promise) {\n          finish(finishCh, errorCh)\n          return promise\n        }\n\n        promise.then(asyncResource.bind(() => finish(finishCh, errorCh)),\n          asyncResource.bind(e => finish(finishCh, errorCh, e)))\n\n        return promise\n      } catch (err) {\n        finish(finishCh, errorCh, err)\n        throw err\n      }\n    })\n  })\n  return SenderLink\n})\n\naddHook({ name: 'amqp10', file: 'lib/receiver_link.js', versions: ['>=3'] }, ReceiverLink => {\n  const startCh = channel('apm:amqp10:receive:start')\n  const finishCh = channel('apm:amqp10:receive:finish')\n  const errorCh = channel('apm:amqp10:receive:error')\n  shimmer.wrap(ReceiverLink.prototype, '_messageReceived', messageReceived => function (transferFrame) {\n    if (!transferFrame || transferFrame.aborted || transferFrame.more) {\n      return messageReceived.apply(this, arguments)\n    }\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    return asyncResource.runInAsyncScope(() => {\n      startCh.publish({ link: this })\n      try {\n        return messageReceived.apply(this, arguments)\n      } catch (err) {\n        errorCh.publish(err)\n        throw err\n      } finally {\n        finishCh.publish()\n      }\n    })\n  })\n  return ReceiverLink\n})\n\nfunction finish (finishCh, errorCh, error) {\n  if (error) {\n    errorCh.publish(error)\n  }\n  finishCh.publish()\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}