{"ast":null,"code":"'use strict';\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument');\n\nconst shimmer = require('../../datadog-shimmer');\n\nconst startCh = channel('apm:redis:command:start');\nconst finishCh = channel('apm:redis:command:finish');\nconst errorCh = channel('apm:redis:command:error');\n\nfunction wrapAddCommand(addCommand) {\n  return function (command) {\n    if (!startCh.hasSubscribers) {\n      return addCommand.apply(this, arguments);\n    }\n\n    const name = command[0];\n    const args = command.slice(1);\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      start(this, name, args);\n      const res = addCommand.apply(this, arguments);\n      const onResolve = asyncResource.bind(() => finish(finishCh, errorCh));\n      const onReject = asyncResource.bind(err => finish(finishCh, errorCh, err));\n      res.then(onResolve, onReject);\n      return res;\n    });\n  };\n}\n\naddHook({\n  name: '@redis/client',\n  file: 'dist/lib/client/commands-queue.js',\n  versions: ['>=1.1']\n}, redis => {\n  shimmer.wrap(redis.default.prototype, 'addCommand', wrapAddCommand);\n  return redis;\n});\naddHook({\n  name: '@node-redis/client',\n  file: 'dist/lib/client/commands-queue.js',\n  versions: ['>=1']\n}, redis => {\n  shimmer.wrap(redis.default.prototype, 'addCommand', wrapAddCommand);\n  return redis;\n});\naddHook({\n  name: 'redis',\n  versions: ['>=2.6 <4']\n}, redis => {\n  shimmer.wrap(redis.RedisClient.prototype, 'internal_send_command', internalSendCommand => function (options) {\n    if (!startCh.hasSubscribers) return internalSendCommand.apply(this, arguments);\n    if (!options.callback) return internalSendCommand.apply(this, arguments);\n    const callbackResource = new AsyncResource('bound-anonymous-fn');\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    const cb = callbackResource.bind(options.callback);\n    return asyncResource.runInAsyncScope(() => {\n      start(this, options.command, options.args);\n      options.callback = asyncResource.bind(wrapCallback(finishCh, errorCh, cb));\n\n      try {\n        return internalSendCommand.apply(this, arguments);\n      } catch (err) {\n        errorCh.publish(err);\n        throw err;\n      }\n    });\n  });\n  return redis;\n});\naddHook({\n  name: 'redis',\n  versions: ['>=0.12 <2.6']\n}, redis => {\n  shimmer.wrap(redis.RedisClient.prototype, 'send_command', sendCommand => function (command, args, callback) {\n    if (!startCh.hasSubscribers) {\n      return sendCommand.apply(this, arguments);\n    }\n\n    const callbackResource = new AsyncResource('bound-anonymous-fn');\n    const asyncResource = new AsyncResource('bound-anonymous-fn');\n    return asyncResource.runInAsyncScope(() => {\n      start(this, command, args);\n\n      if (typeof callback === 'function') {\n        const cb = callbackResource.bind(callback);\n        arguments[2] = asyncResource.bind(wrapCallback(finishCh, errorCh, cb));\n      } else if (Array.isArray(args) && typeof args[args.length - 1] === 'function') {\n        const cb = callbackResource.bind(args[args.length - 1]);\n        args[args.length - 1] = asyncResource.bind(wrapCallback(finishCh, errorCh, cb));\n      } else {\n        arguments[2] = asyncResource.bind(wrapCallback(finishCh, errorCh));\n      }\n\n      try {\n        return sendCommand.apply(this, arguments);\n      } catch (err) {\n        errorCh.publish(err);\n        throw err;\n      }\n    });\n  });\n  return redis;\n});\n\nfunction start(client, command, args) {\n  const db = client.selected_db;\n  const connectionOptions = client.connection_options || client.connection_option || client.connectionOption || {};\n  startCh.publish({\n    db,\n    command,\n    args,\n    connectionOptions\n  });\n}\n\nfunction wrapCallback(finishCh, errorCh, callback) {\n  return function (err) {\n    finish(finishCh, errorCh, err);\n\n    if (callback) {\n      return callback.apply(this, arguments);\n    }\n  };\n}\n\nfunction finish(finishCh, errorCh, error) {\n  if (error) {\n    errorCh.publish(error);\n  }\n\n  finishCh.publish();\n}","map":{"version":3,"names":["channel","addHook","AsyncResource","require","shimmer","startCh","finishCh","errorCh","wrapAddCommand","addCommand","command","hasSubscribers","apply","arguments","name","args","slice","asyncResource","runInAsyncScope","start","res","onResolve","bind","finish","onReject","err","then","file","versions","redis","wrap","default","prototype","RedisClient","internalSendCommand","options","callback","callbackResource","cb","wrapCallback","publish","sendCommand","Array","isArray","length","client","db","selected_db","connectionOptions","connection_options","connection_option","connectionOption","error"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/datadog-instrumentations/src/redis.js"],"sourcesContent":["'use strict'\n\nconst {\n  channel,\n  addHook,\n  AsyncResource\n} = require('./helpers/instrument')\nconst shimmer = require('../../datadog-shimmer')\n\nconst startCh = channel('apm:redis:command:start')\nconst finishCh = channel('apm:redis:command:finish')\nconst errorCh = channel('apm:redis:command:error')\n\nfunction wrapAddCommand (addCommand) {\n  return function (command) {\n    if (!startCh.hasSubscribers) {\n      return addCommand.apply(this, arguments)\n    }\n\n    const name = command[0]\n    const args = command.slice(1)\n\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    return asyncResource.runInAsyncScope(() => {\n      start(this, name, args)\n\n      const res = addCommand.apply(this, arguments)\n      const onResolve = asyncResource.bind(() => finish(finishCh, errorCh))\n      const onReject = asyncResource.bind(err => finish(finishCh, errorCh, err))\n\n      res.then(onResolve, onReject)\n\n      return res\n    })\n  }\n}\n\naddHook({ name: '@redis/client', file: 'dist/lib/client/commands-queue.js', versions: ['>=1.1'] }, redis => {\n  shimmer.wrap(redis.default.prototype, 'addCommand', wrapAddCommand)\n  return redis\n})\n\naddHook({ name: '@node-redis/client', file: 'dist/lib/client/commands-queue.js', versions: ['>=1'] }, redis => {\n  shimmer.wrap(redis.default.prototype, 'addCommand', wrapAddCommand)\n  return redis\n})\n\naddHook({ name: 'redis', versions: ['>=2.6 <4'] }, redis => {\n  shimmer.wrap(redis.RedisClient.prototype, 'internal_send_command', internalSendCommand => function (options) {\n    if (!startCh.hasSubscribers) return internalSendCommand.apply(this, arguments)\n\n    if (!options.callback) return internalSendCommand.apply(this, arguments)\n\n    const callbackResource = new AsyncResource('bound-anonymous-fn')\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n    const cb = callbackResource.bind(options.callback)\n\n    return asyncResource.runInAsyncScope(() => {\n      start(this, options.command, options.args)\n\n      options.callback = asyncResource.bind(wrapCallback(finishCh, errorCh, cb))\n\n      try {\n        return internalSendCommand.apply(this, arguments)\n      } catch (err) {\n        errorCh.publish(err)\n\n        throw err\n      }\n    })\n  })\n  return redis\n})\n\naddHook({ name: 'redis', versions: ['>=0.12 <2.6'] }, redis => {\n  shimmer.wrap(redis.RedisClient.prototype, 'send_command', sendCommand => function (command, args, callback) {\n    if (!startCh.hasSubscribers) {\n      return sendCommand.apply(this, arguments)\n    }\n\n    const callbackResource = new AsyncResource('bound-anonymous-fn')\n    const asyncResource = new AsyncResource('bound-anonymous-fn')\n\n    return asyncResource.runInAsyncScope(() => {\n      start(this, command, args)\n\n      if (typeof callback === 'function') {\n        const cb = callbackResource.bind(callback)\n        arguments[2] = asyncResource.bind(wrapCallback(finishCh, errorCh, cb))\n      } else if (Array.isArray(args) && typeof args[args.length - 1] === 'function') {\n        const cb = callbackResource.bind(args[args.length - 1])\n        args[args.length - 1] = asyncResource.bind(wrapCallback(finishCh, errorCh, cb))\n      } else {\n        arguments[2] = asyncResource.bind(wrapCallback(finishCh, errorCh))\n      }\n\n      try {\n        return sendCommand.apply(this, arguments)\n      } catch (err) {\n        errorCh.publish(err)\n\n        throw err\n      }\n    })\n  })\n  return redis\n})\n\nfunction start (client, command, args) {\n  const db = client.selected_db\n  const connectionOptions = client.connection_options || client.connection_option || client.connectionOption || {}\n  startCh.publish({ db, command, args, connectionOptions })\n}\n\nfunction wrapCallback (finishCh, errorCh, callback) {\n  return function (err) {\n    finish(finishCh, errorCh, err)\n    if (callback) {\n      return callback.apply(this, arguments)\n    }\n  }\n}\n\nfunction finish (finishCh, errorCh, error) {\n  if (error) {\n    errorCh.publish(error)\n  }\n  finishCh.publish()\n}\n"],"mappings":"AAAA;;AAEA,MAAM;EACJA,OADI;EAEJC,OAFI;EAGJC;AAHI,IAIFC,OAAO,CAAC,sBAAD,CAJX;;AAKA,MAAMC,OAAO,GAAGD,OAAO,CAAC,uBAAD,CAAvB;;AAEA,MAAME,OAAO,GAAGL,OAAO,CAAC,yBAAD,CAAvB;AACA,MAAMM,QAAQ,GAAGN,OAAO,CAAC,0BAAD,CAAxB;AACA,MAAMO,OAAO,GAAGP,OAAO,CAAC,yBAAD,CAAvB;;AAEA,SAASQ,cAAT,CAAyBC,UAAzB,EAAqC;EACnC,OAAO,UAAUC,OAAV,EAAmB;IACxB,IAAI,CAACL,OAAO,CAACM,cAAb,EAA6B;MAC3B,OAAOF,UAAU,CAACG,KAAX,CAAiB,IAAjB,EAAuBC,SAAvB,CAAP;IACD;;IAED,MAAMC,IAAI,GAAGJ,OAAO,CAAC,CAAD,CAApB;IACA,MAAMK,IAAI,GAAGL,OAAO,CAACM,KAAR,CAAc,CAAd,CAAb;IAEA,MAAMC,aAAa,GAAG,IAAIf,aAAJ,CAAkB,oBAAlB,CAAtB;IACA,OAAOe,aAAa,CAACC,eAAd,CAA8B,MAAM;MACzCC,KAAK,CAAC,IAAD,EAAOL,IAAP,EAAaC,IAAb,CAAL;MAEA,MAAMK,GAAG,GAAGX,UAAU,CAACG,KAAX,CAAiB,IAAjB,EAAuBC,SAAvB,CAAZ;MACA,MAAMQ,SAAS,GAAGJ,aAAa,CAACK,IAAd,CAAmB,MAAMC,MAAM,CAACjB,QAAD,EAAWC,OAAX,CAA/B,CAAlB;MACA,MAAMiB,QAAQ,GAAGP,aAAa,CAACK,IAAd,CAAmBG,GAAG,IAAIF,MAAM,CAACjB,QAAD,EAAWC,OAAX,EAAoBkB,GAApB,CAAhC,CAAjB;MAEAL,GAAG,CAACM,IAAJ,CAASL,SAAT,EAAoBG,QAApB;MAEA,OAAOJ,GAAP;IACD,CAVM,CAAP;EAWD,CApBD;AAqBD;;AAEDnB,OAAO,CAAC;EAAEa,IAAI,EAAE,eAAR;EAAyBa,IAAI,EAAE,mCAA/B;EAAoEC,QAAQ,EAAE,CAAC,OAAD;AAA9E,CAAD,EAA4FC,KAAK,IAAI;EAC1GzB,OAAO,CAAC0B,IAAR,CAAaD,KAAK,CAACE,OAAN,CAAcC,SAA3B,EAAsC,YAAtC,EAAoDxB,cAApD;EACA,OAAOqB,KAAP;AACD,CAHM,CAAP;AAKA5B,OAAO,CAAC;EAAEa,IAAI,EAAE,oBAAR;EAA8Ba,IAAI,EAAE,mCAApC;EAAyEC,QAAQ,EAAE,CAAC,KAAD;AAAnF,CAAD,EAA+FC,KAAK,IAAI;EAC7GzB,OAAO,CAAC0B,IAAR,CAAaD,KAAK,CAACE,OAAN,CAAcC,SAA3B,EAAsC,YAAtC,EAAoDxB,cAApD;EACA,OAAOqB,KAAP;AACD,CAHM,CAAP;AAKA5B,OAAO,CAAC;EAAEa,IAAI,EAAE,OAAR;EAAiBc,QAAQ,EAAE,CAAC,UAAD;AAA3B,CAAD,EAA4CC,KAAK,IAAI;EAC1DzB,OAAO,CAAC0B,IAAR,CAAaD,KAAK,CAACI,WAAN,CAAkBD,SAA/B,EAA0C,uBAA1C,EAAmEE,mBAAmB,IAAI,UAAUC,OAAV,EAAmB;IAC3G,IAAI,CAAC9B,OAAO,CAACM,cAAb,EAA6B,OAAOuB,mBAAmB,CAACtB,KAApB,CAA0B,IAA1B,EAAgCC,SAAhC,CAAP;IAE7B,IAAI,CAACsB,OAAO,CAACC,QAAb,EAAuB,OAAOF,mBAAmB,CAACtB,KAApB,CAA0B,IAA1B,EAAgCC,SAAhC,CAAP;IAEvB,MAAMwB,gBAAgB,GAAG,IAAInC,aAAJ,CAAkB,oBAAlB,CAAzB;IACA,MAAMe,aAAa,GAAG,IAAIf,aAAJ,CAAkB,oBAAlB,CAAtB;IACA,MAAMoC,EAAE,GAAGD,gBAAgB,CAACf,IAAjB,CAAsBa,OAAO,CAACC,QAA9B,CAAX;IAEA,OAAOnB,aAAa,CAACC,eAAd,CAA8B,MAAM;MACzCC,KAAK,CAAC,IAAD,EAAOgB,OAAO,CAACzB,OAAf,EAAwByB,OAAO,CAACpB,IAAhC,CAAL;MAEAoB,OAAO,CAACC,QAAR,GAAmBnB,aAAa,CAACK,IAAd,CAAmBiB,YAAY,CAACjC,QAAD,EAAWC,OAAX,EAAoB+B,EAApB,CAA/B,CAAnB;;MAEA,IAAI;QACF,OAAOJ,mBAAmB,CAACtB,KAApB,CAA0B,IAA1B,EAAgCC,SAAhC,CAAP;MACD,CAFD,CAEE,OAAOY,GAAP,EAAY;QACZlB,OAAO,CAACiC,OAAR,CAAgBf,GAAhB;QAEA,MAAMA,GAAN;MACD;IACF,CAZM,CAAP;EAaD,CAtBD;EAuBA,OAAOI,KAAP;AACD,CAzBM,CAAP;AA2BA5B,OAAO,CAAC;EAAEa,IAAI,EAAE,OAAR;EAAiBc,QAAQ,EAAE,CAAC,aAAD;AAA3B,CAAD,EAA+CC,KAAK,IAAI;EAC7DzB,OAAO,CAAC0B,IAAR,CAAaD,KAAK,CAACI,WAAN,CAAkBD,SAA/B,EAA0C,cAA1C,EAA0DS,WAAW,IAAI,UAAU/B,OAAV,EAAmBK,IAAnB,EAAyBqB,QAAzB,EAAmC;IAC1G,IAAI,CAAC/B,OAAO,CAACM,cAAb,EAA6B;MAC3B,OAAO8B,WAAW,CAAC7B,KAAZ,CAAkB,IAAlB,EAAwBC,SAAxB,CAAP;IACD;;IAED,MAAMwB,gBAAgB,GAAG,IAAInC,aAAJ,CAAkB,oBAAlB,CAAzB;IACA,MAAMe,aAAa,GAAG,IAAIf,aAAJ,CAAkB,oBAAlB,CAAtB;IAEA,OAAOe,aAAa,CAACC,eAAd,CAA8B,MAAM;MACzCC,KAAK,CAAC,IAAD,EAAOT,OAAP,EAAgBK,IAAhB,CAAL;;MAEA,IAAI,OAAOqB,QAAP,KAAoB,UAAxB,EAAoC;QAClC,MAAME,EAAE,GAAGD,gBAAgB,CAACf,IAAjB,CAAsBc,QAAtB,CAAX;QACAvB,SAAS,CAAC,CAAD,CAAT,GAAeI,aAAa,CAACK,IAAd,CAAmBiB,YAAY,CAACjC,QAAD,EAAWC,OAAX,EAAoB+B,EAApB,CAA/B,CAAf;MACD,CAHD,MAGO,IAAII,KAAK,CAACC,OAAN,CAAc5B,IAAd,KAAuB,OAAOA,IAAI,CAACA,IAAI,CAAC6B,MAAL,GAAc,CAAf,CAAX,KAAiC,UAA5D,EAAwE;QAC7E,MAAMN,EAAE,GAAGD,gBAAgB,CAACf,IAAjB,CAAsBP,IAAI,CAACA,IAAI,CAAC6B,MAAL,GAAc,CAAf,CAA1B,CAAX;QACA7B,IAAI,CAACA,IAAI,CAAC6B,MAAL,GAAc,CAAf,CAAJ,GAAwB3B,aAAa,CAACK,IAAd,CAAmBiB,YAAY,CAACjC,QAAD,EAAWC,OAAX,EAAoB+B,EAApB,CAA/B,CAAxB;MACD,CAHM,MAGA;QACLzB,SAAS,CAAC,CAAD,CAAT,GAAeI,aAAa,CAACK,IAAd,CAAmBiB,YAAY,CAACjC,QAAD,EAAWC,OAAX,CAA/B,CAAf;MACD;;MAED,IAAI;QACF,OAAOkC,WAAW,CAAC7B,KAAZ,CAAkB,IAAlB,EAAwBC,SAAxB,CAAP;MACD,CAFD,CAEE,OAAOY,GAAP,EAAY;QACZlB,OAAO,CAACiC,OAAR,CAAgBf,GAAhB;QAEA,MAAMA,GAAN;MACD;IACF,CApBM,CAAP;EAqBD,CA7BD;EA8BA,OAAOI,KAAP;AACD,CAhCM,CAAP;;AAkCA,SAASV,KAAT,CAAgB0B,MAAhB,EAAwBnC,OAAxB,EAAiCK,IAAjC,EAAuC;EACrC,MAAM+B,EAAE,GAAGD,MAAM,CAACE,WAAlB;EACA,MAAMC,iBAAiB,GAAGH,MAAM,CAACI,kBAAP,IAA6BJ,MAAM,CAACK,iBAApC,IAAyDL,MAAM,CAACM,gBAAhE,IAAoF,EAA9G;EACA9C,OAAO,CAACmC,OAAR,CAAgB;IAAEM,EAAF;IAAMpC,OAAN;IAAeK,IAAf;IAAqBiC;EAArB,CAAhB;AACD;;AAED,SAAST,YAAT,CAAuBjC,QAAvB,EAAiCC,OAAjC,EAA0C6B,QAA1C,EAAoD;EAClD,OAAO,UAAUX,GAAV,EAAe;IACpBF,MAAM,CAACjB,QAAD,EAAWC,OAAX,EAAoBkB,GAApB,CAAN;;IACA,IAAIW,QAAJ,EAAc;MACZ,OAAOA,QAAQ,CAACxB,KAAT,CAAe,IAAf,EAAqBC,SAArB,CAAP;IACD;EACF,CALD;AAMD;;AAED,SAASU,MAAT,CAAiBjB,QAAjB,EAA2BC,OAA3B,EAAoC6C,KAApC,EAA2C;EACzC,IAAIA,KAAJ,EAAW;IACT7C,OAAO,CAACiC,OAAR,CAAgBY,KAAhB;EACD;;EACD9C,QAAQ,CAACkC,OAAT;AACD"},"metadata":{},"sourceType":"script"}