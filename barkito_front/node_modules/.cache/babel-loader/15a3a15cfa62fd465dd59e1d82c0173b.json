{"ast":null,"code":"'use strict';\n\nconst tracerVersion = require('../../../../package.json').version;\n\nconst containerId = require('../exporters/common/docker').id();\n\nconst os = require('os');\n\nconst dependencies = require('./dependencies');\n\nconst {\n  sendData\n} = require('./send-data');\n\nconst HEARTBEAT_INTERVAL = process.env.DD_TELEMETRY_HEARTBEAT_INTERVAL ? Number(process.env.DD_TELEMETRY_HEARTBEAT_INTERVAL) * 1000 : 60000;\nlet config;\nlet pluginManager;\nlet application;\nlet host;\nlet interval;\nconst sentIntegrations = new Set();\n\nfunction getIntegrations() {\n  const newIntegrations = [];\n\n  for (const pluginName in pluginManager._pluginsByName) {\n    if (sentIntegrations.has(pluginName)) {\n      continue;\n    }\n\n    newIntegrations.push({\n      name: pluginName,\n      enabled: pluginManager._pluginsByName[pluginName]._enabled,\n      auto_enabled: true\n    });\n    sentIntegrations.add(pluginName);\n  }\n\n  return newIntegrations;\n}\n\nfunction flatten(input) {\n  let result = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n  let prefix = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  let traversedObjects = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;\n  traversedObjects = traversedObjects || new WeakSet();\n\n  if (traversedObjects.has(input)) {\n    return;\n  }\n\n  traversedObjects.add(input);\n\n  for (const [key, value] of Object.entries(input)) {\n    if (typeof value === 'object' && value !== null) {\n      flatten(value, result, [...prefix, key], traversedObjects);\n    } else {\n      result.push({\n        name: [...prefix, key].join('.'),\n        value\n      });\n    }\n  }\n\n  return result;\n}\n\nfunction appStarted() {\n  return {\n    integrations: getIntegrations(),\n    dependencies: [],\n    configuration: flatten(config),\n    additional_payload: []\n  };\n}\n\nfunction onBeforeExit() {\n  process.removeListener('beforeExit', onBeforeExit);\n  sendData(config, application, host, 'app-closing');\n}\n\nfunction createAppObject() {\n  return {\n    service_name: config.service,\n    env: config.env,\n    service_version: config.version,\n    tracer_version: tracerVersion,\n    language_name: 'nodejs',\n    language_version: process.versions.node\n  };\n}\n\nfunction createHostObject() {\n  return {\n    hostname: os.hostname(),\n    // TODO is this enough?\n    container_id: containerId\n  };\n}\n\nfunction start(aConfig, thePluginManager) {\n  if (!aConfig.telemetryEnabled) {\n    return;\n  }\n\n  config = aConfig;\n  pluginManager = thePluginManager;\n  application = createAppObject();\n  host = createHostObject();\n  dependencies.start(config, application, host);\n  sendData(config, application, host, 'app-started', appStarted());\n  interval = setInterval(() => {\n    sendData(config, application, host, 'app-heartbeat');\n  }, HEARTBEAT_INTERVAL);\n  interval.unref();\n  process.on('beforeExit', onBeforeExit);\n}\n\nfunction stop() {\n  if (!config) {\n    return;\n  }\n\n  clearInterval(interval);\n  process.removeListener('beforeExit', onBeforeExit);\n}\n\nfunction updateIntegrations() {\n  if (!config || !config.telemetryEnabled) {\n    return;\n  }\n\n  const integrations = getIntegrations();\n\n  if (integrations.length === 0) {\n    return;\n  }\n\n  sendData(config, application, host, 'app-integrations-change', {\n    integrations\n  });\n}\n\nmodule.exports = {\n  start,\n  stop,\n  updateIntegrations\n};","map":{"version":3,"names":["tracerVersion","require","version","containerId","id","os","dependencies","sendData","HEARTBEAT_INTERVAL","process","env","DD_TELEMETRY_HEARTBEAT_INTERVAL","Number","config","pluginManager","application","host","interval","sentIntegrations","Set","getIntegrations","newIntegrations","pluginName","_pluginsByName","has","push","name","enabled","_enabled","auto_enabled","add","flatten","input","result","prefix","traversedObjects","WeakSet","key","value","Object","entries","join","appStarted","integrations","configuration","additional_payload","onBeforeExit","removeListener","createAppObject","service_name","service","service_version","tracer_version","language_name","language_version","versions","node","createHostObject","hostname","container_id","start","aConfig","thePluginManager","telemetryEnabled","setInterval","unref","on","stop","clearInterval","updateIntegrations","length","module","exports"],"sources":["/Users/daniel.calderon/Projects/barkito/barkito_front/node_modules/dd-trace/packages/dd-trace/src/telemetry/index.js"],"sourcesContent":["'use strict'\n\nconst tracerVersion = require('../../../../package.json').version\nconst containerId = require('../exporters/common/docker').id()\nconst os = require('os')\nconst dependencies = require('./dependencies')\nconst { sendData } = require('./send-data')\n\nconst HEARTBEAT_INTERVAL = process.env.DD_TELEMETRY_HEARTBEAT_INTERVAL\n  ? Number(process.env.DD_TELEMETRY_HEARTBEAT_INTERVAL) * 1000\n  : 60000\n\nlet config\nlet pluginManager\n\nlet application\nlet host\nlet interval\nconst sentIntegrations = new Set()\n\nfunction getIntegrations () {\n  const newIntegrations = []\n  for (const pluginName in pluginManager._pluginsByName) {\n    if (sentIntegrations.has(pluginName)) {\n      continue\n    }\n    newIntegrations.push({\n      name: pluginName,\n      enabled: pluginManager._pluginsByName[pluginName]._enabled,\n      auto_enabled: true\n    })\n    sentIntegrations.add(pluginName)\n  }\n  return newIntegrations\n}\n\nfunction flatten (input, result = [], prefix = [], traversedObjects = null) {\n  traversedObjects = traversedObjects || new WeakSet()\n  if (traversedObjects.has(input)) {\n    return\n  }\n  traversedObjects.add(input)\n  for (const [key, value] of Object.entries(input)) {\n    if (typeof value === 'object' && value !== null) {\n      flatten(value, result, [...prefix, key], traversedObjects)\n    } else {\n      result.push({ name: [...prefix, key].join('.'), value })\n    }\n  }\n  return result\n}\n\nfunction appStarted () {\n  return {\n    integrations: getIntegrations(),\n    dependencies: [],\n    configuration: flatten(config),\n    additional_payload: []\n  }\n}\n\nfunction onBeforeExit () {\n  process.removeListener('beforeExit', onBeforeExit)\n  sendData(config, application, host, 'app-closing')\n}\n\nfunction createAppObject () {\n  return {\n    service_name: config.service,\n    env: config.env,\n    service_version: config.version,\n    tracer_version: tracerVersion,\n    language_name: 'nodejs',\n    language_version: process.versions.node\n  }\n}\n\nfunction createHostObject () {\n  return {\n    hostname: os.hostname(), // TODO is this enough?\n    container_id: containerId\n  }\n}\n\nfunction start (aConfig, thePluginManager) {\n  if (!aConfig.telemetryEnabled) {\n    return\n  }\n  config = aConfig\n  pluginManager = thePluginManager\n  application = createAppObject()\n  host = createHostObject()\n  dependencies.start(config, application, host)\n  sendData(config, application, host, 'app-started', appStarted())\n  interval = setInterval(() => {\n    sendData(config, application, host, 'app-heartbeat')\n  }, HEARTBEAT_INTERVAL)\n  interval.unref()\n  process.on('beforeExit', onBeforeExit)\n}\n\nfunction stop () {\n  if (!config) {\n    return\n  }\n  clearInterval(interval)\n  process.removeListener('beforeExit', onBeforeExit)\n}\n\nfunction updateIntegrations () {\n  if (!config || !config.telemetryEnabled) {\n    return\n  }\n  const integrations = getIntegrations()\n  if (integrations.length === 0) {\n    return\n  }\n  sendData(config, application, host, 'app-integrations-change', { integrations })\n}\n\nmodule.exports = {\n  start,\n  stop,\n  updateIntegrations\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}